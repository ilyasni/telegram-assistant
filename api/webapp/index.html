<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Assistant - QR Login</title>
  <!-- Context7: –∑–∞–≥—Ä—É–∂–∞–µ–º Telegram WebApp API –ü–ï–†–í–´–ú, –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ -->
  <!-- –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebApp –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; padding: 16px; background: #f8f9fa; 
    }
    .container { 
      max-width: 400px; margin: 0 auto; 
    }
    .card { 
      background: white; border-radius: 12px; padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      text-align: center;
    }
    .header {
      margin-bottom: 24px;
    }
    .title {
      font-size: 24px; font-weight: 600; color: #1a1a1a;
      margin: 0 0 8px 0;
    }
    .subtitle {
      color: #6b7280; font-size: 14px; margin: 0;
    }
    .status {
      padding: 12px 16px; border-radius: 8px; margin: 16px 0;
      font-weight: 500; font-size: 14px;
    }
    .status.loading { background: #fef3c7; color: #92400e; }
    .status.pending { background: #dbeafe; color: #1e40af; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #dc2626; }
    .qr-container {
      margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 8px;
    }
    #qr {
      display: flex; justify-content: center; align-items: center;
      min-height: 200px;
    }
    .timer {
      margin-top: 12px; font-size: 14px; color: #6b7280;
    }
    .timer.warning { color: #dc2626; font-weight: 500; }
    .instructions {
      margin-top: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px;
      font-size: 14px; color: #374151; line-height: 1.5;
    }
    .btn {
      background: #3b82f6; color: white; border: none; border-radius: 8px;
      padding: 12px 24px; font-size: 14px; font-weight: 500;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover { background: #2563eb; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .spinner {
      display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3;
      border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
    .error-details {
      margin-top: 12px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca;
      border-radius: 6px; font-size: 12px; color: #dc2626; text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1 class="title">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
        <p class="subtitle">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Telegram –¥–ª—è –≤—Ö–æ–¥–∞</p>
      </div>
      
      <div id="status" class="status loading">
        <span class="spinner"></span> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
      </div>
      
      <div id="qr-container" class="qr-container hidden">
        <div id="qr"></div>
        <div id="timer" class="timer"></div>
      </div>
      
      <div class="instructions">
        <strong>–ö–∞–∫ –≤–æ–π—Ç–∏:</strong><br>
        1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ<br>
        2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞<br>
        3. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"<br>
        4. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥
      </div>
      
      <!-- Context7: –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ 2FA –ø–∞—Ä–æ–ª—è -->
      <div id="password-form" class="password-form hidden">
        <h3 style="margin-top: 0; margin-bottom: 16px;">üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA</h3>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
          –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞
        </p>
        <input 
          type="password" 
          id="password-input" 
          placeholder="–ü–∞—Ä–æ–ª—å 2FA" 
          style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; margin-bottom: 12px;"
          autocomplete="current-password"
        />
        <button id="btn-submit-password" class="btn" style="width: 100%;">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </button>
        <div id="password-error" style="margin-top: 12px; color: #dc2626; font-size: 14px; display: none;"></div>
      </div>
      
      <button id="btn-retry" class="btn hidden">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>
  </div>

  <script>
    // DOM elements
    const statusEl = document.getElementById('status');
    const qrContainerEl = document.getElementById('qr-container');
    const qrEl = document.getElementById('qr');
    const timerEl = document.getElementById('timer');
    const btnRetryEl = document.getElementById('btn-retry');
    const passwordFormEl = document.getElementById('password-form');
    const passwordInputEl = document.getElementById('password-input');
    const btnSubmitPasswordEl = document.getElementById('btn-submit-password');
    const passwordErrorEl = document.getElementById('password-error');

    // State
    let sessionToken = null;
    let eventSource = null;
    let qrCode = null;
    let expiresAt = null;
    let countdownInterval = null;

    // API helper
    async function callApi(path, method = 'GET', body) {
      const headers = { 'Content-Type': 'application/json' };
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      const res = await fetch(path, options);
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    // Update status display
    function updateStatus(text, type = 'loading') {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
    }

    // Update timer
    function updateTimer() {
      if (!expiresAt) return;
      const now = Math.floor(Date.now() / 1000);
      const timeLeft = expiresAt - now;
      
      if (timeLeft <= 0) {
        timerEl.textContent = 'QR-–∫–æ–¥ –∏—Å—Ç—ë–∫';
        timerEl.className = 'timer warning';
        clearInterval(countdownInterval);
        if (eventSource) eventSource.close();
        updateStatus('QR-–∫–æ–¥ –∏—Å—Ç—ë–∫. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"', 'error');
        btnRetryEl.classList.remove('hidden');
        return;
      }
      
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      timerEl.textContent = `–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –µ—â—ë: ${timeStr}`;
      timerEl.className = timeLeft <= 60 ? 'timer warning' : 'timer';
    }

    // Start SSE connection
    function startSSE(token) {
      if (eventSource) {
        eventSource.close();
      }
      
      console.log('Starting SSE connection with token:', token ? token.substring(0, 20) + '...' : 'null');
      eventSource = new EventSource(`/tg/qr/sse?token=${encodeURIComponent(token)}`);
      
      eventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('SSE message received:', data);
          // Context7: –ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ SSE —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ Mini App
          // –í Mini App console.log –≤–∏–¥–µ–Ω —á–µ—Ä–µ–∑ DevTools –∏–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram.WebApp.showAlert
          if (window.Telegram?.WebApp?.showAlert && data.status === 'password_required') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ password_required
            if (!window._passwordAlertShown) {
              window.Telegram.WebApp.showAlert('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA');
              window._passwordAlertShown = true;
            }
          }
          handleSSEMessage(data);
        } catch (e) {
          console.error('SSE parse error:', e);
          if (window.Telegram?.WebApp?.showAlert) {
            window.Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
          }
        }
      };
      
      eventSource.onerror = function(err) {
        console.error('SSE error:', err);
        // Context7: –≤ Mini App –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ Telegram WebApp API
        if (window.Telegram?.WebApp?.showAlert) {
          window.Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑');
        }
        updateStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑', 'error');
        btnRetryEl.classList.remove('hidden');
        if (eventSource) eventSource.close();
      };
      
      // Context7: –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      eventSource.onopen = function() {
        console.log('SSE connection opened successfully');
      };
    }

    // Handle SSE messages
    function handleSSEMessage(data) {
      console.log('handleSSEMessage called with:', data);
      // Context7: –í–ê–ñ–ù–û! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º password_required –ü–ï–†–í–´–ú, –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ qr_url
      // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–æ—Ä–º–∞ –ø–∞—Ä–æ–ª—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å qr_url –≤ –¥–∞–Ω–Ω—ã—Ö
      
      // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å password_required –°–¢–†–û–ì–û –≤ –Ω–∞—á–∞–ª–µ
      if (data.status === 'password_required') {
        console.log('Password required detected in handleSSEMessage, showing form');
        // Context7: Context7 best practice - –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram.WebApp API –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        // –ù–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (window.Telegram?.WebApp?.showAlert && !window._passwordAlertShown) {
          window.Telegram.WebApp.showAlert('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞');
          window._passwordAlertShown = true;
        }
        
        updateStatus('üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA', 'pending');
        qrContainerEl.classList.add('hidden');
        
        // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
        if (!passwordFormEl) {
          console.error('passwordFormEl not found!');
          // Context7: –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ Telegram API
          updateStatus('‚ùå –û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –ø–∞—Ä–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
          if (window.Telegram?.WebApp?.showAlert) {
            window.Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –ø–∞—Ä–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
          }
          return;
        }
        
        console.log('Showing password form, passwordFormEl:', passwordFormEl, 'hidden class:', passwordFormEl.classList.contains('hidden'));
        // Context7: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–∞—Ä–æ–ª—è
        passwordFormEl.classList.remove('hidden');
        console.log('Password form should be visible now, hidden class:', passwordFormEl.classList.contains('hidden'));
        const instructionsEl = document.querySelector('.instructions');
        if (instructionsEl) {
          instructionsEl.classList.add('hidden');
        }
        
        // Context7: Context7 best practice - —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        // –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ Mini App
        setTimeout(() => {
          if (passwordInputEl) {
            passwordInputEl.focus();
            // Context7: –≤ Mini App –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —è–≤–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è —Ñ–æ–∫—É—Å–∞
            if (passwordInputEl.focus) {
              try {
                passwordInputEl.focus();
              } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Ñ–æ–∫—É—Å–∞ –≤ Mini App
              }
            }
          }
        }, 200); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è Mini App
        
        return; // Context7: –≤—ã—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã
      }
      
      // Context7 best practice: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ qr_url –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–µ awaiting_scan
      // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞ –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
      if (data.qr_url && !qrCode) {
        // Show QR code
        qrContainerEl.classList.remove('hidden');
        qrEl.innerHTML = '';
        qrCode = new QRCode(qrEl, {
          text: data.qr_url,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        updateStatus('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Telegram', 'pending');
      }
      
      // Context7: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "awaiting_scan" - QR-–∫–æ–¥ –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
      if (data.status === 'awaiting_scan' && data.qr_url && !qrCode) {
        qrContainerEl.classList.remove('hidden');
        qrEl.innerHTML = '';
        qrCode = new QRCode(qrEl, {
          text: data.qr_url,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        updateStatus('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Telegram', 'pending');
      }
      
      // Context7: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "pending" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      if (data.status === 'pending' && !data.qr_url) {
        updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ QR-–∫–æ–¥–∞...', 'loading');
      }
      
      // Context7: –æ–±—Ä–∞–±–æ—Ç–∫–∞ password_required —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤—ã—à–µ (–≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏)
      
      if (data.status === 'authorized') {
        updateStatus('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!', 'success');
        qrContainerEl.classList.add('hidden');
        passwordFormEl.classList.add('hidden');
        if (eventSource) eventSource.close();
        if (countdownInterval) clearInterval(countdownInterval);
        
        // Close Mini App after success
        setTimeout(() => {
          if (window.Telegram?.WebApp?.close) {
            window.Telegram.WebApp.close();
          }
        }, 2000);
      } else if (data.status === 'failed') {
        // Context7: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
        if (data.reason) {
          // –ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–∏—á–∏–Ω –æ—à–∏–±–æ–∫ –Ω–∞ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          const reasonMessages = {
            'password_required': '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA',
            'ownership_mismatch': '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞',
            'flood_wait': '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
            'qr_login_error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ QR-–∫–æ–¥–∞',
            'invalid_telegram_user': '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
            'session_store': '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏'
          };
          const reasonKey = Object.keys(reasonMessages).find(key => data.reason.includes(key));
          if (reasonKey) {
            errorMessage = `‚ùå ${reasonMessages[reasonKey]}`;
          } else {
            errorMessage = `‚ùå –û—à–∏–±–∫–∞: ${data.reason}`;
          }
        }
        updateStatus(errorMessage, 'error');
        btnRetryEl.classList.remove('hidden');
        if (eventSource) eventSource.close();
        if (countdownInterval) clearInterval(countdownInterval);
      }
    }

    // Start QR login process
    async function startQRLogin() {
      try {
        updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'loading');
        btnRetryEl.classList.add('hidden');
        
        // Get initData from Telegram WebApp
        // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ initData
        let initData = '';
        if (window.Telegram?.WebApp?.initData) {
          initData = window.Telegram.WebApp.initData;
          console.log('initData from Telegram.WebApp.initData, length:', initData.length);
        } else if (window.Telegram?.WebApp?.initDataUnsafe) {
          // Fallback –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Telegram WebApp
          console.log('Using initDataUnsafe as fallback');
          initData = JSON.stringify(window.Telegram.WebApp.initDataUnsafe);
        } else {
          console.error('initData NOT FOUND! window.Telegram:', !!window.Telegram, 
                       'WebApp:', !!window.Telegram?.WebApp,
                       'initData:', !!window.Telegram?.WebApp?.initData);
          updateStatus('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram WebApp', 'error');
          btnRetryEl.classList.remove('hidden');
          return;
        }
        
        if (!initData || initData.length === 0) {
          console.error('initData is empty!');
          updateStatus('–û—à–∏–±–∫–∞: –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ Telegram WebApp', 'error');
          btnRetryEl.classList.remove('hidden');
          return;
        }
        
        console.log('initData extracted, length:', initData.length, 'first 50 chars:', initData.substring(0, 50));
        
        // Context7: –ò–∑–≤–ª–µ–∫–∞–µ–º telegram_user_id –∏ tenant_id –∏–∑ initData
        let telegramUserId = null;
        let tenantId = null;
        if (initData) {
          try {
            // –ü–∞—Ä—Å–∏–º initData –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è user_id
            const params = new URLSearchParams(initData);
            const userParam = params.get('user');
            if (userParam) {
              const userData = JSON.parse(decodeURIComponent(userParam));
              telegramUserId = userData.id;
              console.log('Extracted telegram_user_id:', telegramUserId);
              // Context7: –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º telegram_id –∫–∞–∫ tenant_id
              // –í –±—É–¥—É—â–µ–º tenant_id –±—É–¥–µ—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å—Å—è –∏–∑ –ë–î —á–µ—Ä–µ–∑ /tg/miniapp/init
              tenantId = String(telegramUserId);
            }
          } catch (e) {
            console.error('Failed to parse initData:', e);
          }
        }
        
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–∑ initData, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ /tg/miniapp/init
        if (!tenantId) {
          const initResponse = await callApi('/tg/miniapp/init', 'POST', { init_data: initData });
          console.log('init response:', initResponse);
          // TODO: extract tenant_id from initResponse if available
        }
        
        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º telegram_user_id –∫–∞–∫ tenant_id –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (!tenantId && telegramUserId) {
          tenantId = String(telegramUserId);
          console.log('Using telegram_user_id as tenant_id:', tenantId);
        }
        
        if (!tenantId) {
          throw new Error('Cannot determine tenant_id from initData');
        }
        
        // Link Mini App
        const linkResponse = await callApi('/tg/miniapp/link', 'POST', { 
          start_param: 'qr_login', 
          tenant_id: tenantId 
        });
        sessionToken = linkResponse.session_token;
        console.log('session_token:', sessionToken.substring(0, 24) + '...');
        
        // Start QR session
        // Context7 best practice: –ø–µ—Ä–µ–¥–∞–µ–º initData –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è telegram_user_id
        const qrStartPayload = { 
          tenant_id: tenantId,
          invite_code: 'DEMO123', // TODO: get from URL params or initData
        };
        
        // Context7: –í–ê–ñ–ù–û - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º init_data –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (initData && initData.length > 0) {
          qrStartPayload.init_data = initData;
          console.log('Sending init_data to /tg/qr/start, length:', initData.length);
        } else {
          console.error('WARNING: initData is empty, will not send to /tg/qr/start!');
        }
        
        console.log('QR start payload:', { ...qrStartPayload, init_data: qrStartPayload.init_data ? `[${qrStartPayload.init_data.length} chars]` : 'missing' });
        const startResponse = await callApi('/tg/qr/start', 'POST', qrStartPayload);
        console.log('qr start response:', startResponse);
        
        // Parse expiration time
        if (startResponse.expires_at) {
          expiresAt = Math.floor(new Date(startResponse.expires_at).getTime() / 1000);
          countdownInterval = setInterval(updateTimer, 1000);
          updateTimer();
        }
        
        // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º SSE
        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ password_required, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å—Ä–∞–∑—É
        try {
          const initialStatus = await callApi('/tg/qr/status', 'POST', { session_token: sessionToken });
          console.log('Initial QR status:', initialStatus);
          if (initialStatus.status === 'password_required') {
            console.log('Status is already password_required, showing form immediately');
            handleSSEMessage({ status: 'password_required', reason: initialStatus.reason });
          }
        } catch (e) {
          console.warn('Failed to check initial status:', e);
        }
        
        // Start SSE for real-time updates
        console.log('Starting SSE with sessionToken:', sessionToken ? sessionToken.substring(0, 24) + '...' : 'null');
        startSSE(sessionToken);
        
      } catch (error) {
        console.error('QR login error:', error);
        updateStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        btnRetryEl.classList.remove('hidden');
      }
    }

    // Context7: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ 2FA –ø–∞—Ä–æ–ª—è
    async function submitPassword() {
      const password = passwordInputEl.value.trim();
      if (!password) {
        passwordErrorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
        passwordErrorEl.style.display = 'block';
        return;
      }
      
      if (!sessionToken) {
        passwordErrorEl.textContent = '–û—à–∏–±–∫–∞: —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
        passwordErrorEl.style.display = 'block';
        return;
      }
      
      try {
        passwordErrorEl.style.display = 'none';
        btnSubmitPasswordEl.disabled = true;
        btnSubmitPasswordEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        
        const response = await callApi('/tg/qr/password', 'POST', {
          session_token: sessionToken,
          password: password
        });
        
        console.log('Password submission response:', response);
        
        if (response.status === 'authorized') {
          updateStatus('‚úÖ –ü–∞—Ä–æ–ª—å –ø—Ä–∏–Ω—è—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'success');
          passwordFormEl.classList.add('hidden');
          
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å SSE –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
          if (!eventSource) {
            startSSE(sessionToken);
          }
        } else {
          throw new Error(response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (error) {
        console.error('Password submission error:', error);
        passwordErrorEl.textContent = error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∞—Ä–æ–ª—è';
        passwordErrorEl.style.display = 'block';
        passwordInputEl.value = '';
        passwordInputEl.focus();
      } finally {
        btnSubmitPasswordEl.disabled = false;
        btnSubmitPasswordEl.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –ø–∞—Ä–æ–ª—è
    btnSubmitPasswordEl.addEventListener('click', submitPassword);
    passwordInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });

    // Retry button handler
    btnRetryEl.addEventListener('click', () => {
      passwordFormEl.classList.add('hidden');
      passwordErrorEl.style.display = 'none';
      passwordInputEl.value = '';
      startQRLogin();
    });

    // Context7: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–∞–∫ WebApp, –∞ –Ω–µ –∫–∞–∫ MAF
    // –û—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ WebApp vs MAF ‚Äî –Ω–∞–ª–∏—á–∏–µ initData/initDataUnsafe
    // –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ù–ï –∫–∞–∫ WebApp
    function isWebAppInitialized() {
      if (!window.Telegram || !window.Telegram.WebApp) {
        return false;
      }
      // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ WebApp (–Ω–µ MAF)
      // –ï—Å–ª–∏ initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∑–Ω–∞—á–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ –∫–∞–∫ WebApp
      const hasInitData = window.Telegram.WebApp.initData || 
                         window.Telegram.WebApp.initDataUnsafe;
      // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é WebApp (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const hasVersion = window.Telegram.WebApp.version;
      return hasInitData || hasVersion;
    }
    
    // Context7: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp –ø–æ best practices
    // –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram Mini Apps, –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å ready() –∏ expand()
    // –í–ê–ñ–ù–û: –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ API, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –∑–∞–ø—É—Å–∫–∞–µ–º QR
    async function initTelegramWebApp() {
      // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω
      if (typeof window.Telegram === 'undefined') {
        // –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º
        await new Promise(resolve => {
          const checkInterval = setInterval(() => {
            if (typeof window.Telegram !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 50);
          // Timeout —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
            clearInterval(checkInterval);
            resolve();
          }, 2000);
        });
      }
      
      if (!window.Telegram?.WebApp) {
        console.error('Telegram WebApp not available - page may be opened as MAF, not WebApp');
        updateStatus('–û—à–∏–±–∫–∞: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ –∫–∞–∫ Mini App. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.', 'error');
        btnRetryEl.classList.remove('hidden');
        return false;
      }
      
      // Context7: —É–≤–µ–¥–æ–º–ª—è–µ–º Telegram, —á—Ç–æ Mini App –≥–æ—Ç–æ–≤
      window.Telegram.WebApp.ready();
      
      // Context7: –∂–¥–µ–º –ø–æ–∫–∞ WebApp –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å isReady)
      if (window.Telegram.WebApp.isReady !== undefined) {
        if (!window.Telegram.WebApp.isReady) {
          await new Promise(resolve => {
            const checkReady = setInterval(() => {
              if (window.Telegram.WebApp.isReady) {
                clearInterval(checkReady);
                resolve();
              }
            }, 50);
            setTimeout(() => {
              clearInterval(checkReady);
              resolve();
            }, 1000);
          });
        }
      } else {
        // –ï—Å–ª–∏ isReady –Ω–µ—Ç, –∂–¥–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Context7: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ WebApp –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–µ MAF)
      if (!isWebAppInitialized()) {
        console.error('WebApp not properly initialized - initData missing, page may be opened as MAF');
        updateStatus('–û—à–∏–±–∫–∞: Mini App –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.', 'error');
        btnRetryEl.classList.remove('hidden');
        return false;
      }
      
      // Context7: —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º Mini App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
      window.Telegram.WebApp.expand();
      
      // Context7: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–º—É, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
      if (window.Telegram.WebApp.themeParams) {
        const theme = window.Telegram.WebApp.themeParams;
        if (theme.bg_color) {
          document.documentElement.style.setProperty('--tg-theme-bg-color', theme.bg_color);
        }
        if (theme.text_color) {
          document.documentElement.style.setProperty('--tg-theme-text-color', theme.text_color);
        }
      }
      
      return true;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Context7: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp –∏ –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      const webAppInitialized = await initTelegramWebApp();
      
      // Context7: –∑–∞–ø—É—Å–∫–∞–µ–º QR login —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      if (webAppInitialized) {
        startQRLogin();
      } else {
        console.error('Cannot start QR login - WebApp not initialized');
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (eventSource) eventSource.close();
      if (countdownInterval) clearInterval(countdownInterval);
    });
  </script>
  <!-- Context7: telegram-web-app.js —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ <head>, —É–¥–∞–ª—è–µ–º –æ—Ç—Å—é–¥–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</body>
</html>
