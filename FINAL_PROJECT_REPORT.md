# üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç: Incremental Parsing Implementation

## üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞: 85% ‚úÖ

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (100%)

#### 1. Core Logic
- ‚úÖ `_get_since_date()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ starting point —Å Redis HWM
- ‚úÖ `_process_message_batch()` - tracking max_date –≤ –±–∞—Ç—á–∞—Ö
- ‚úÖ `_update_last_parsed_at()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ watermark –≤ –ë–î
- ‚úÖ Safeguard –º–µ—Ö–∞–Ω–∏–∑–º (LPA max age ‚Üí forced historical)
- ‚úÖ –†–µ–∂–∏–º—ã: historical, incremental, auto

#### 2. Database
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `last_parsed_at` –ø–æ–ª—è
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã: `idx_channels_last_parsed_at`, `idx_channels_active_unparsed`
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queries –¥–ª—è scheduler
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞

#### 3. Configuration
- ‚úÖ `ParserConfig` —Ä–∞—Å—à–∏—Ä–µ–Ω –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `PARSER_MODE_OVERRIDE`, `PARSER_HISTORICAL_HOURS`, etc.
- ‚úÖ Docker Compose –æ–±–Ω–æ–≤–ª—ë–Ω —Å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- ‚úÖ Feature flag: `FEATURE_INCREMENTAL_PARSING_ENABLED`

#### 4. Scheduler (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
- ‚úÖ `ParseAllChannelsTask` –∫–ª–∞—Å—Å —Å–æ–∑–¥–∞–Ω
- ‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- ‚úÖ –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–Ω–∞–ª–æ–≤
- ‚ö†Ô∏è –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChannelParser –æ—Ç–ª–æ–∂–µ–Ω–∞

## üîç Best Practices –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

### Context7
1. **Connection Pooling**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω asyncpg –¥–ª—è async –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π
2. **Error Handling**: Comprehensive try/except —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. **Metrics**: Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è observability
4. **Configuration**: ENV-based –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å defaults

### Supabase
1. **Indexes**: Partial indexes –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ scheduler queries
2. **Migrations**: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. **Connection Pooling**: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ pooling –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Scheduler Integration
**–ü—Ä–æ–±–ª–µ–º–∞**: ChannelParser —Ç—Ä–µ–±—É–µ—Ç AsyncSession –∏ EventPublisher
**–†–µ—à–µ–Ω–∏–µ**: –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è scheduler –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
**–°—Ç–∞—Ç—É—Å**: –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 2. TelegramClient
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù—É–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ TelegramClient –≤ scheduler
**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–ª–æ–∂–µ–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
**–°—Ç–∞—Ç—É—Å**: –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### Prometheus
- `parser_runs_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –ø–∞—Ä—Å–µ—Ä–∞
- `parsing_duration_seconds` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞
- `posts_parsed_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
- `incremental_watermark_age_seconds` - –≤–æ–∑—Ä–∞—Å—Ç watermark

## üöÄ Production Readiness

### –ì–æ—Ç–æ–≤–æ –∫ Production
- ‚úÖ Core logic –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Database migrations –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ Configuration –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- ‚úÖ Monitoring –º–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

### –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏
- ‚ö†Ô∏è –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è scheduler
- ‚ö†Ô∏è E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ö†Ô∏è Grafana dashboards

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1 –Ω–µ–¥–µ–ª—è)
1. –ü—Ä–æ–≤–µ—Å—Ç–∏ manual —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_parsed_at` –≤ –ë–î
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏)
1. –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é scheduler —Å ChannelParser
2. –î–æ–±–∞–≤–∏—Ç—å end-to-end —Ç–µ—Å—Ç—ã
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana dashboards

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (1+ –º–µ—Å—è—Ü)
1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
3. Multi-tenancy support

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ 85%**

Core —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –û—Å—Ç–∞–≤—à–∏–µ—Å—è 15% ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production deployment** –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ scheduler.

---

**–î–∞—Ç–∞**: 2025-10-27
**–í–µ—Ä—Å–∏—è**: 1.0.0
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
