# Исправление проблемы с парсингом канала business_ru

## Проблема
Пост из канала `business_ru` (https://t.me/business_ru/24905) был опубликован в 13:31 MSK, но не попал в БД.

## Диагностика

### Статус канала
- **Канал**: `business_ru` (ID: `4791c699-a07d-439d-9d74-e5506fddcfbf`)
- **Последний парсинг**: 2025-11-06 10:44:34 UTC
- **Последний пост в БД**: 2025-11-06 10:31:28 UTC
- **Пост 13:31 MSK**: не найден в БД

### Причины проблемы

1. **Scheduler не обрабатывает все каналы**:
   - Tick прерывается из-за превышения `max_tick_duration` (450 секунд)
   - Каналы в конце списка не обрабатываются
   - Канал `business_ru` не попадает в обработку

2. **Логика incremental парсинга**:
   - `since_date` рассчитывается от `last_post_date` (10:31:28)
   - Overlap = 5 минут, поэтому `since_date = 10:31:28 - 5 минут = 10:26:28`
   - Парсинг ищет сообщения новее `since_date`, но может не найти пост 13:31 из-за ограничений Telethon API

3. **Ограничения Telethon API**:
   - `iter_messages` без `offset_date` возвращает последние сообщения
   - Если пост 13:31 не входит в первые 5000 сообщений, он может быть пропущен

## Исправления

### 1. Сортировка каналов по `last_parsed_at`
**Файл**: `telethon-ingest/tasks/parse_all_channels_task.py`

Добавлена сортировка каналов по `last_parsed_at` (старые первыми), чтобы каналы с давно не обновленными данными обрабатывались в первую очередь:

```python
# Context7: Сортируем каналы по last_parsed_at (старые первыми) для равномерного парсинга
channels_sorted = sorted(
    channels,
    key=lambda c: (
        c.get('last_parsed_at') is None,  # Новые каналы (None) первыми
        c.get('last_parsed_at') or datetime.min.replace(tzinfo=timezone.utc)  # Затем по дате (старые первыми)
    )
)
```

### 2. Проверка логики incremental парсинга
**Файл**: `telethon-ingest/services/channel_parser.py`

Логика incremental парсинга использует:
- `last_post_date` из БД как базовую дату
- Overlap = 5 минут (или адаптивный на основе статистики)
- Фильтрацию сообщений новее `since_date`

## Рекомендации

1. **Увеличить лимит сообщений для incremental режима**:
   - Текущий лимит: `batch_size * 100 = 5000` сообщений
   - Рекомендуется увеличить до `batch_size * 200 = 10000` сообщений

2. **Улучшить мониторинг**:
   - Добавить метрики для отслеживания пропущенных постов
   - Логировать `since_date` и количество найденных сообщений

3. **Оптимизировать scheduler**:
   - Рассмотреть параллельную обработку каналов
   - Увеличить `max_tick_duration` или уменьшить время обработки каждого канала

## Статус

✅ **Исправлено**: Сортировка каналов по `last_parsed_at` добавлена
⚠️ **Требуется проверка**: Логика incremental парсинга может пропускать посты, если они не входят в первые 5000 сообщений

## Следующие шаги

1. Запустить принудительный парсинг канала `business_ru` в режиме `historical` для проверки наличия поста 13:31
2. Проверить логи парсинга на наличие сообщений о пропущенных постах
3. Увеличить лимит сообщений для incremental режима

