# ============================================================================
# TELEGRAM ASSISTANT - ENVIRONMENT CONFIGURATION
# ============================================================================
# Copy this file to .env and fill in your values

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================

# PostgreSQL Database
POSTGRES_USER=telegram_user
POSTGRES_PASSWORD=your_secure_password_here
DATABASE_URL=postgresql+asyncpg://telegram_user:your_secure_password_here@localhost:5432/postgres

# ============================================================================
# REDIS CONFIGURATION
# ============================================================================

REDIS_URL=redis://localhost:6379

# ============================================================================
# PARSER CONFIGURATION
# ============================================================================

# Feature flag для incremental парсинга
FEATURE_INCREMENTAL_PARSING_ENABLED=true

# Режим парсинга: auto (по умолчанию) | historical | incremental
PARSER_MODE_OVERRIDE=auto

# Интервал scheduler (секунды)
PARSER_SCHEDULER_INTERVAL_SEC=300

# Временные окна
PARSER_HISTORICAL_HOURS=24
PARSER_INCREMENTAL_MINUTES=5

# Safeguard: если last_parsed_at старше N часов, форсим historical
PARSER_LPA_MAX_AGE_HOURS=48

# Concurrency and retries
PARSER_MAX_CONCURRENCY=4
PARSER_RETRY_MAX=3

# Context7: Адаптивные пороги для предотвращения пропусков постов
FEATURE_ADAPTIVE_THRESHOLDS_ENABLED=true
PARSER_STATS_WINDOW_DAYS=14

# ============================================================================
# VECTOR AND GRAPH DATABASES
# ============================================================================

# Qdrant Vector Database
QDRANT_URL=http://localhost:6333

# Neo4j Graph Database (unified)
NEO4J_URI=neo4j://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=<generated_secure_password>
NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}

# ============================================================================
# AI PROVIDERS (GigaChat PRIMARY!)
# ============================================================================

# GigaChat Authentication (для gpt2giga-proxy)
# Документация: https://developers.sber.ru/docs/ru/gigachat/api/main
# Proxy: https://github.com/ai-forever/gpt2giga
# Credentials получить: https://developers.sber.ru/gigachat
GIGACHAT_CREDENTIALS=your_gigachat_credentials_base64_here
GIGACHAT_SCOPE=GIGACHAT_API_PERS

# gpt2giga Proxy Settings (OpenAI-compatible endpoint)
GIGACHAT_PROXY_HOST=0.0.0.0
GIGACHAT_PROXY_PORT=8090
GIGACHAT_BASE_URL=https://gigachat.devices.sberbank.ru/api/v1
GIGACHAT_MODEL=GigaChat
GIGACHAT_EMBEDDINGS_MODEL=EmbeddingsGigaR
# Context7: Модель для Vision анализа (GigaChat-Pro | GigaChat-Max | GigaChat | GigaChat-Multi)
# Приоритет: GIGACHAT_VISION_MODEL > GIGACHAT_MODEL > default (GigaChat-Pro)
GIGACHAT_VISION_MODEL=GigaChat-Pro
GPT2GIGA_TIMEOUT=600
GPT2GIGA_VERBOSE=False

# OpenAI-compatible URL для подключения из worker/api
OPENAI_API_BASE=http://gpt2giga-proxy:8090/v1
OPENAI_API_KEY=dummy  # gpt2giga игнорирует, использует GIGACHAT_CREDENTIALS
GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090  # URL gpt2giga-proxy сервиса (для embeddings)

# OpenRouter (FALLBACK, только бесплатные модели)
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_MODEL=qwen/qwen-2.5-72b-instruct:free

# ============================================================================
# TELEGRAM CONFIGURATION
# ============================================================================

# Telegram Bot API
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_API_ID=your_api_id_here
TELEGRAM_API_HASH=your_api_hash_here

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================

# JWT Secret for API authentication
JWT_SECRET=your_jwt_secret_key_here

# Supabase Keys
ANON_KEY=your_anon_key_here
SERVICE_KEY=your_service_key_here

# Supabase Host
SUPABASE_HOST=produman.studio

# ============================================================================
# CADDY CONFIGURATION
# ============================================================================

# Email для Let's Encrypt (обязательно!)
CADDY_TLS_EMAIL=hello@ilyasni.com

# Basic Auth для Prometheus metrics (опционально, если нужен внешний доступ)
# Сгенерировать: caddy hash-password --plaintext 'your_password'
PROM_BASICAUTH_USER=prometheus
PROM_BASICAUTH_HASH=$2a$14$...

# Database Configuration
POSTGRES_DB=postgres
POSTGRES_PASSWORD=your_secure_password_here

# Tenant ID for multi-tenancy
DEFAULT_TENANT_ID=default-tenant

# ============================================================================
# MONITORING CONFIGURATION
# ============================================================================

# Grafana Admin Password
GRAFANA_PASSWORD=your_grafana_password_here

# ============================================================================
# ENRICHMENT CONFIGURATION
# ============================================================================

# Enrichment Policy Configuration Path
ENRICHMENT_CONFIG_PATH=worker/config/enrichment_policy.yml

# ============================================================================
# DEVELOPMENT CONFIGURATION
# ============================================================================

# [C7-ID: dev-mode-005] Для dev используйте отдельный файл .env.development и передавайте
# его в docker compose через --env-file .env.development. В production используйте .env
# или .env.production. Ниже — значения по умолчанию.

# Environment flag
APP_ENV=production

# Debug Mode
DEBUG=false

# Log Level
LOG_LEVEL=INFO

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

# CORS Origins (comma-separated)
CORS_ORIGINS=http://localhost:3000,https://your-domain.com

# Rate Limiting
RATE_LIMIT_PER_MINUTE=100

# ============================================================================
# PERFORMANCE CONFIGURATION
# ============================================================================

# Worker Configuration
WORKER_REPLICAS=2
WORKER_BATCH_SIZE=10
WORKER_TIMEOUT=30

# Database Connection Pool
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=30

# Redis Connection Pool
REDIS_POOL_SIZE=10

# ============================================================================
# NEO4J GRAPH DATABASE
# ============================================================================

NEO4J_USER=neo4j
NEO4J_PASSWORD=your_neo4j_password_here
NEO4J_URL=bolt://neo4j:7687

# ============================================================================
# AI PROVIDERS (GigaChat PRIMARY!)
# ============================================================================

# GigaChat (PRIMARY для тегирования и embeddings)
GIGACHAT_API_KEY=your_gigachat_api_key_here
GIGACHAT_CREDENTIALS=your_gigachat_credentials_here

# OpenRouter (FALLBACK, только бесплатные модели)
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_MODEL=qwen/qwen-2.5-72b-instruct:free

# AI Provider Settings
AI_HTTP_TIMEOUT_SEC=30
AI_MAX_RETRIES=3
AI_RETRY_BACKOFF_SEC=5

# ============================================================================
# FEATURE FLAGS
# ============================================================================

# Neo4j GraphRAG
FEATURE_NEO4J_ENABLED=true

# AI Providers (GigaChat primary!)
FEATURE_GIGACHAT_ENABLED=true
FEATURE_OPENROUTER_ENABLED=true

# Crawl4AI Enrichment
FEATURE_CRAWL4AI_ENABLED=true

# ============================================================================
# LOGGING (Production with extended logs)
# ============================================================================

LOG_LEVEL=DEBUG
LOG_FORMAT=json
LOG_STRUCTURED=true

# ============================================================================
# EMBEDDINGS CONFIGURATION
# ============================================================================

# Embedding Model Configuration
# Context7: GigaChat Giga-Embeddings-instruct возвращает 2048 измерений
# Источник: https://gitverse.ru/GigaTeam/GigaEmbeddings
EMBEDDING_MODEL=gigachat-embeddings
EMBEDDING_DIMENSION=2048
EMBED_DIM=2048
INDEXER_EMBED_IF_MISSING=true

# ============================================================================
# QDRANT CONFIGURATION (Extended)
# ============================================================================

QDRANT_URL=http://qdrant:6333
QDRANT_COLLECTION=telegram_posts
QDRANT_READ_TIMEOUT_MS=5000
QDRANT_WRITE_TIMEOUT_MS=5000

# ============================================================================
# REDIS STREAMS CONFIGURATION
# ============================================================================

REDIS_URL=redis://redis:6379
REDIS_STREAM_MAXLEN=100000
INDEXING_CONSUMER_GROUP=indexing_workers
INDEXING_MAX_RETRIES=5
INDEXING_BACKOFF_MS=2000
INDEXING_BATCH_SIZE=32
INDEXING_CONCURRENCY=4

# ============================================================================
# DLQ CONFIGURATION
# ============================================================================

DLQ_ENABLED=true
DLQ_MAX_REASON_DETAILS=500

# ============================================================================
# METRICS CONFIGURATION
# ============================================================================

PROMETHEUS_NAMESPACE=telegram_assistant

# ============================================================================
# E2E TESTING CONFIGURATION
# ============================================================================

# E2E Testing Thresholds (override для config/e2e_thresholds.json)
E2E_MAX_WATERMARK_AGE_MIN=30
E2E_MAX_STREAM_PENDING=50
E2E_MIN_POSTS_24H=1
E2E_MAX_EMBED_DIM_MISMATCH=0
E2E_MAX_QDRANT_LAG_MIN=10
E2E_MAX_SKEW_VS_PG_MIN=5
E2E_QDRANT_MIN_PAYLOAD_COVERAGE=0.9

# E2E Testing Configuration
E2E_THRESHOLDS_PATH=config/e2e_thresholds.json
E2E_MODE=e2e

# Prometheus Pushgateway (для отправки метрик E2E)
PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091

# Embedding Dimension (для проверки Qdrant)
EMBEDDING_DIM=2560

# Environment Label (для метрик Pushgateway)
ENV=dev

# ============================================================================
# S3 STORAGE CONFIGURATION (Cloud.ru)
# ============================================================================
# Context7: Добавлены согласно плану Vision + S3 Integration

# S3 Connection
# Context7: Cloud.ru S3 Quickstart best practices
# Базовый endpoint для всех регионов
S3_ENDPOINT_URL=https://s3.cloud.ru
# Опционально: региональный endpoint (если требуется)
# S3_REGIONAL_ENDPOINT=https://s3.ru-central-1.cloud.ru
# Context7: Cloud.ru использует два имени для bucket:
# - S3_BUCKET_NAME: локальное имя (bucket-467940) - для SDK операций (path-style)
# - S3_BUCKET_DOMAIN: глобальное имя (test-467940) - для virtual-hosted URLs
S3_BUCKET_NAME=bucket-467940
S3_BUCKET_DOMAIN=https://test-467940.s3.cloud.ru
S3_REGION=ru-central-1
S3_SERVICE_NAME=s3
S3_FORCE_PATH_STYLE=true

# Credentials
S3_ACCESS_KEY_ID=your_access_key_here
S3_SECRET_ACCESS_KEY=your_secret_key_here

# Default tenant
S3_DEFAULT_TENANT_ID=877193ef-be80-4977-aaeb-8009c3d772ee

# Storage Limits (15 GB) - Критическое ограничение!
S3_TOTAL_LIMIT_GB=15.0
S3_EMERGENCY_THRESHOLD_GB=14.0
S3_PER_TENANT_LIMIT_GB=2.0
S3_MEDIA_MAX_GB=10.0
S3_VISION_MAX_GB=2.0
S3_CRAWL_MAX_GB=2.0

# Compression (обязательно для экономии места)
S3_USE_COMPRESSION=true
S3_COMPRESSION_LEVEL=6

# Lifecycle TTL
S3_MEDIA_TTL_DAYS=30
S3_VISION_TTL_DAYS=14
S3_CRAWL_TTL_DAYS=7
S3_ABORT_MULTIPART_DAYS=1

# Emergency cleanup
S3_ENABLE_EMERGENCY_CLEANUP=true
S3_CLEANUP_CHECK_INTERVAL_HOURS=6
S3_TARGET_AFTER_CLEANUP_GB=12.0

# Security
S3_PRESIGNED_URL_TTL=3600
S3_USE_SSL=true
S3_VERIFY_SSL=true

# S3 Addressing & Signature (Context7: для совместимости с различными S3 провайдерами)
S3_ADDRESSING_STYLE=virtual  # 'virtual' (по умолчанию) или 'path' для bucket-specific endpoints
AWS_SIGNATURE_VERSION=s3v4  # Версия подписи S3 запросов (s3v4 рекомендуется)

# Multipart upload
S3_MULTIPART_THRESHOLD_MB=5
S3_MULTIPART_CHUNKSIZE_MB=5

# Connection & Retry (Context7: для стабильности Cloud.ru S3)
S3_MAX_RETRY_ATTEMPTS=5
S3_RETRY_MODE=standard  # 'standard' | 'adaptive' | 'legacy'
S3_CONNECT_TIMEOUT_SEC=30
S3_READ_TIMEOUT_SEC=60
S3_MAX_POOL_CONNECTIONS=50
S3_MAX_CONCURRENCY=10

# ============================================================================
# SEARXNG CONFIGURATION
# ============================================================================
# Context7: SearXNG для внешнего поиска (external search grounding)
# Основано на best practices из n8n-installer: https://github.com/kossakovsky/n8n-installer
SEARXNG_HOSTNAME=searxng.produman.studio
SEARXNG_URL=https://searxng.produman.studio
SEARXNG_ENABLED=true
SEARXNG_CACHE_TTL=3600
SEARXNG_MAX_RESULTS=5
SEARXNG_RATE_LIMIT_PER_USER=10  # Запросов в минуту на пользователя
SEARXNG_UWSGI_WORKERS=4
SEARXNG_UWSGI_THREADS=4

# Context7: BasicAuth для SearXNG (опционально, для защиты внешнего доступа)
# Для генерации хеша: caddy hash-password --plaintext "your_password"
SEARXNG_PASSWORD_HASH=

# ============================================================================
# SALUTESPEECH CONFIGURATION (Voice Transcription)
# ============================================================================
# [required] SaluteSpeech API Configuration
SALUTESPEECH_CLIENT_ID=
SALUTESPEECH_CLIENT_SECRET=
SALUTESPEECH_SCOPE=SALUTE_SPEECH_PERS
SALUTESPEECH_URL=https://smartspeech.sber.ru/rest/v1

# [optional] Voice Settings
VOICE_TRANSCRIPTION_ENABLED=true
VOICE_MAX_DURATION_SEC=60
VOICE_CACHE_TTL=86400
VOICE_AI_CLASSIFIER_ENABLED=true

# ============================================================================
# CONTEXT7 BEST PRACTICES
# ============================================================================

# [C7-ID: ENV-SEC-001] - Secure password generation
# [C7-ID: ENV-SEC-002] - Environment-specific configuration
# [C7-ID: ENV-SEC-003] - Secret management
# [C7-ID: ENV-SEC-004] - Multi-tenant configuration
# [C7-ID: ENV-SEC-005] - Performance tuning parameters
