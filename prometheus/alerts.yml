groups:
  # Recording rules для квантилей
  - name: crawl_latency_quantiles
    interval: 30s
    rules:
      - record: job:crawl_trigger_processing_latency_seconds:p95
        expr: histogram_quantile(0.95, sum by (le) (rate(crawl_trigger_processing_latency_seconds_bucket[5m])))
      
      - record: job:crawl_processing_seconds:p95
        expr: histogram_quantile(0.95, sum by (le) (rate(crawl_processing_seconds_bucket[5m])))

  # Alerts
  - name: crawl_pipeline
    interval: 30s
    rules:
      # PEL backlog критичен
      - alert: CrawlPELBacklogHigh
        expr: crawl_pel_backlog_current > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокий PEL backlog ({{ $value }})"
      
      # Queue depth растёт
      - alert: CrawlTriggerQueueDepthHigh
        expr: crawl_trigger_queue_depth_current > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокая глубина очереди триггера ({{ $value }})"
      
      # Error rate > 10%
      - alert: CrawlErrorRateHigh
        expr: |
          rate(crawl_requests_total{status="failed"}[5m])
          /
          rate(crawl_requests_total[5m]) > 0.10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Crawl error-rate > 10%"
      
      # p95 latency > 2s
      - alert: CrawlP95LatencyHigh
        expr: job:crawl_trigger_processing_latency_seconds:p95 > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "p95 latency триггера > 2s ({{ $value }})"
      
      # TagPersistence PEL backlog
      - alert: TagPersistPELBacklogHigh
        expr: tags_persist_pel_backlog_current > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "TagPersist PEL backlog высокий ({{ $value }})"

  # Pipeline Coverage Alerts
  - name: pipeline_coverage
    interval: 30s
    rules:
      # Индексация: покрытие < 90%
      # Используем rate успешной индексации / rate успешного тегирования (ближайший proxy к общему парсингу)
      - alert: IndexingCoverageLow
        expr: |
          (
            sum(rate(indexing_processed_total{status="success"}[10m]))
            /
            (sum(rate(tagging_processed_total[10m])) + 1e-6)
          ) < 0.90
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Индексация < 90% (текущее: {{ $value | humanizePercentage }})"
          description: "Целевое покрытие: 90%+. Проверить логи worker и Qdrant."
      
      # Тегирование: покрытие < 80%
      # Используем rate успешного тегирования / rate успешного парсинга (stream_messages_total с phase=new)
      - alert: TaggingCoverageLow
        expr: |
          (
            sum(rate(tagging_processed_total{status="success"}[10m]))
            /
            (sum(rate(stream_messages_total{stream="posts.parsed", phase="new", status="ok"}[10m])) + 1e-6)
          ) < 0.80
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Тегирование < 80% (текущее: {{ $value | humanizePercentage }})"
          description: "Целевое покрытие: 80%+. Проверить AI провайдеры (GigaChat/OpenRouter)."
      
      # Redis Stream lag
      - alert: RedisStreamLagHigh
        expr: stream_pending_size{stream=~"posts\\.(parsed|tagged|enriched)"} > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Redis Stream lag высокий: {{ $labels.stream }} ({{ $value }} сообщений)"
          description: "Очередь растёт. Проверить производительность worker."
      
      # Worker задача упала
      - alert: WorkerTaskDown
        expr: up{job="worker"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Worker не отвечает на health check"
          description: "Worker контейнер недоступен. Проверить docker logs worker."
      
      # Индексация не обрабатывает события
      - alert: IndexingNoActivity
        expr: |
          sum(rate(indexing_processed_total[10m])) == 0
          and 
          sum(stream_pending_size{stream=~"posts\\.enriched"}) > 10
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Индексация не обрабатывает события (pending: {{ $value }})"
          description: "Есть события в posts.enriched, но indexing не обрабатывает. Проверить worker."
      
      # Тегирование не обрабатывает события
      - alert: TaggingNoActivity
        expr: |
          sum(rate(tagging_processed_total[10m])) == 0
          and 
          sum(stream_pending_size{stream=~"posts\\.parsed"}) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Тегирование не обрабатывает события (pending: {{ $value }})"
          description: "Есть события в posts.parsed, но tagging не обрабатывает. Проверить AI провайдеры."
