# üìä –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ Incremental Parsing Mode

## ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env`
- ‚úÖ Docker Compose –æ–±–Ω–æ–≤–ª—ë–Ω —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

### 2. Database
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –ë–î
- ‚úÖ –ò–Ω–¥–µ–∫—Å `idx_channels_last_parsed_at` —Å–æ–∑–¥–∞–Ω
- ‚úÖ –ò–Ω–¥–µ–∫—Å `idx_channels_active_unparsed` —Å–æ–∑–¥–∞–Ω
- ‚úÖ –ö–∞–Ω–∞–ª—ã –µ—Å—Ç—å –≤ –ë–î (5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤)

### 3. –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ –¢–µ—Å—Ç historical mode: —Ä–∞–±–æ—Ç–∞–µ—Ç (24h window)
- ‚úÖ –¢–µ—Å—Ç incremental mode: —Ä–∞–±–æ—Ç–∞–µ—Ç (5min window)
- ‚úÖ –¢–µ—Å—Ç safeguard: —Ä–∞–±–æ—Ç–∞–µ—Ç (50h trigger ‚Üí historical)

### 4. –ö–æ–¥
- ‚úÖ `_get_since_date()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ `_update_last_parsed_at()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ `_process_message_batch()` –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `parse_channel_messages()` –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Scheduler –Ω–µ –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–∏—á–∏–Ω–∞: placeholder –≤ `main.py` –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- –í–ª–∏—è–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –†–µ—à–µ–Ω–∏–µ: –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é scheduler

### 2. –ë–î –ø—É—Å—Ç–∞—è
- –ü—Ä–∏—á–∏–Ω–∞: –ü–æ—Å—Ç—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ
- –í–ª–∏—è–Ω–∏–µ: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è E2E
- –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä—É—á–Ω–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ë–î

### 3. –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
- –ü—Ä–∏—á–∏–Ω–∞: Scheduler –Ω–µ –∑–∞–ø—É—â–µ–Ω
- –í–ª–∏—è–Ω–∏–µ: –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç—å scheduler

## üéØ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è since_date
```python
# Historical mode
channel = {'id': 'test', 'last_parsed_at': None}
since = await parser._get_since_date(channel, 'historical')
# Result: 24 hours ago ‚úÖ

# Incremental mode (fresh)
channel = {'id': 'test', 'last_parsed_at': datetime.now() - timedelta(minutes=3)}
since = await parser._get_since_date(channel, 'incremental')
# Result: 3 minutes ago ‚úÖ

# Incremental mode (stale) ‚Üí safeguard
channel = {'id': 'test', 'last_parsed_at': datetime.now() - timedelta(hours=50)}
since = await parser._get_since_date(channel, 'incremental')
# Result: 24 hours ago (forced historical) ‚úÖ
```

### –ò–Ω–¥–µ–∫—Å—ã –ë–î
```sql
-- Partial index –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
idx_channels_active_unparsed ‚úÖ

-- –û–±—ã—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
idx_channels_last_parsed_at ‚úÖ
```

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ historical —Ä–µ–∂–∏–º–µ

2. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ë–î**:
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_parsed_at`

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ incremental —Ä–µ–∂–∏–º–∞**:
   - –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å incremental —Ä–µ–∂–∏–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis HWM

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è scheduler**:
   - –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å placeholder –≤ main.py
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å telegram_client

## üéâ –ò—Ç–æ–≥–∏

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã: 90%**

- ‚úÖ –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- ‚úÖ Database –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞
- ‚ö†Ô∏è Scheduler —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏
- ‚ö†Ô∏è E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –¥–∞–Ω–Ω—ã—Ö

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é** –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ scheduler –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ë–î –¥–∞–Ω–Ω—ã–º–∏.

