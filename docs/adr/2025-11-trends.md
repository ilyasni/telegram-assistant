---
title: "ADR 2025-11 — Модернизация пайплайна трендов"
status: "proposed"
context7: true
date: "2025-11-15"
---

## Контекст

Текущий `TrendDetectionService` (см. `api/services/trend_detection_service.py`) использует упрощённый подход:

- анализ только по ключевым словам из `PostEnrichment.keywords`,
- один агрегированный период (`days`), без базовых рядов и сезонности,
- нет учёта разнообразия источников и когерентности,
- тренды сохраняются сразу в Postgres без realtime валидации,
- уведомления (`send_trend_alerts_to_users`) опираются на статичный список каналов.

В результате:

1. **Отсутствует baseline** — нет сравнения частот (5m/1h/24h), поэтому всплески сложно отличить от фонового шума.
2. **Нет source diversity** — один канал может «создать тренд».
3. **Нет coherence/embedding cluster** — keywords → грубые токены, не учитываются новые формулировки/синонимы.
4. **Стадии A/B смешаны** — LLM классификация выполняется до проверки динамики.
5. **Невозможен reactive режим** — анализ запускается cron-ом раз в сутки, нет событий `trends.emerging`.

## Решение (high-level)

В рамках модернизации переходим к модели из спецификации:

1. **Embedding-кластеры + ANN**
   - новая коллекция Qdrant `trends_hot` для горячих кластеров,
   - кластеризация при каждом `posts.indexed` событии.

2. **Time-series baseline**
   - Redis time-series (`trend:{cluster_id}:freq:5m`, `:freq:1h`, `:freq:24h`) и показатели `burst_score`, `rate_of_change`.
   - Метрики: `freq_short/freq_long`, EWM, CUSUM, STL (batch).

3. **Source diversity & coherence**
   - Redis множества `trend:{cluster_id}:sources`,
   - хранение `coherence_score` и `novelty_score` в Postgres.

4. **Два режима**
   - Reactive worker → `trends.emerging` (Redis Stream) сразу после порога `freq_30m/freq_24h_avg > 3 & source_diversity ≥ 3 & coherence > 0.55`.
   - Stable batch (каждый час) → подтверждённые тренды (`trend_clusters` + `trend_metrics` таблицы).

5. **LLM слой**
   - GigaChat Prompt: именование трендов, justification, expected direction.

6. **API/бот**
   - новые эндпоинты `/api/trends/emerging`, `/api/trends/clusters`, поля `novelty_score`, `source_diversity`, `growth_direction`.

## Альтернативы

1. **Только keyword bursts (Kleinberg)** — проще, но не покрывает семантику и когерентность → отвергнуто.
2. **Использовать только Neo4j community detection** — тяжёлый граф, latency > SLO, нет realtime → отвергнуто.

## Риски

- Рост нагрузки на Redis/Qdrant (решение: TTL/Retention, Prometheus алерты).
- Сложность тестирования (решение: fake Redis/Qdrant, unit + integration pipelines).
- Пороговые значения могут требовать калибровки (решение: feature flags и canary tenants).

## Следующие шаги

1. Реализовать новые таблицы и Redis структуры.
2. Добавить `trends_worker.py` и почасовой агрегатор.
3. Обновить API/бот, наблюдаемость и документацию.


