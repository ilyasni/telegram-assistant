# –û—Å—Ç–∞–≤—à–∏–µ—Å—è —ç—Ç–∞–ø—ã –∏ –∑–∞–¥–∞—á–∏

**–î–∞—Ç–∞**: 2025-01-30  
**–°—Ç–∞—Ç—É—Å**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã (–∑–∞–≤–µ—Ä—à–µ–Ω—ã)

1. ‚úÖ –≠—Ç–∞–ø 1: –ú–∏–≥—Ä–∞—Ü–∏—è post_enrichment
2. ‚úÖ –≠—Ç–∞–ø 3: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–¥–∏–∞ –Ω–∞ CAS
3. ‚úÖ –≠—Ç–∞–ø 4: S3 –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
4. ‚úÖ –≠—Ç–∞–ø 5: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Crawl4ai
5. ‚úÖ –≠—Ç–∞–ø 6: –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
6. ‚úÖ –≠—Ç–∞–ø 7: Forwards/Reactions/Replies

---

## üü¢ –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–°–†–ï–î–ù–ò–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### 1. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è post_enrichment.kind

**–°—Ç–∞—Ç—É—Å**: –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint `ux_post_enrichment_post_kind`, –Ω–æ –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ `kind`.

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT indexname 
FROM pg_indexes 
WHERE tablename = 'post_enrichment' 
AND indexname LIKE '%kind%';
```

**–ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å:**
```sql
CREATE INDEX IF NOT EXISTS idx_post_enrichment_kind 
ON post_enrichment(kind) 
WHERE kind IS NOT NULL;
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –°–†–ï–î–ù–ò–ô (–≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ kind)

---

### 2. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è post_forwards, post_reactions, post_replies

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –ï–°–¢–¨**

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
- `ix_post_forwards_post_id` ‚úÖ
- `ix_post_reactions_post_id` ‚úÖ
- `ix_post_replies_post_id` ‚úÖ
- `ix_post_replies_reply_to` ‚úÖ

**–î–µ–π—Å—Ç–≤–∏–µ**: –ù–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

### 3. Foreign Key Constraints

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ü–†–û–í–ï–†–ï–ù–´ –ò –ö–û–†–†–ï–ö–¢–ù–´**

–í—Å–µ FK constraints –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ CASCADE:
- `post_forwards_post_id_fkey` ‚Üí CASCADE ‚úÖ
- `post_reactions_post_id_fkey` ‚Üí CASCADE ‚úÖ
- `post_replies_post_id_fkey` ‚Üí CASCADE ‚úÖ
- `post_replies_reply_to_post_id_fkey` ‚Üí CASCADE ‚úÖ
- `post_media_map_post_id_fkey` ‚Üí CASCADE ‚úÖ
- `post_media_map_file_sha256_fkey` ‚Üí NO ACTION ‚úÖ

**–î–µ–π—Å—Ç–≤–∏–µ**: –ù–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

### 4. –ú–∏–≥—Ä–∞—Ü–∏—è legacy –ø–æ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°—Ç–∞—Ç—É—Å**: üü° –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û

Legacy –ø–æ–ª—è –≤ `post_enrichment` –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ DEPRECATED, –Ω–æ –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:
- `ocr_text` ‚Üí –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `data->>'ocr'->>'text'`
- `vision_labels` ‚Üí –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `data->>'labels'`
- `crawl_md` ‚Üí –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `data->>'crawl'->>'markdown'`

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `data` JSONB
- –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ legacy –ø–æ–ª—è—Ö
- –ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±–∞ –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω):**
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è ocr_text –≤ data JSONB
UPDATE post_enrichment
SET data = jsonb_set(
    COALESCE(data, '{}'::jsonb),
    '{ocr,text}',
    to_jsonb(ocr_text)
)
WHERE ocr_text IS NOT NULL 
AND kind = 'vision'
AND data->'ocr'->>'text' IS NULL;

-- –ú–∏–≥—Ä–∞—Ü–∏—è vision_labels –≤ data JSONB
UPDATE post_enrichment
SET data = jsonb_set(
    COALESCE(data, '{}'::jsonb),
    '{labels}',
    vision_labels::jsonb
)
WHERE vision_labels IS NOT NULL 
AND kind = 'vision'
AND data->>'labels' IS NULL;

-- –ú–∏–≥—Ä–∞—Ü–∏—è crawl_md –≤ data JSONB
UPDATE post_enrichment
SET data = jsonb_set(
    COALESCE(data, '{}'::jsonb),
    '{crawl,markdown}',
    to_jsonb(crawl_md)
)
WHERE crawl_md IS NOT NULL 
AND kind = 'crawl'
AND data->'crawl'->>'markdown' IS NULL;
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –ù–ò–ó–ö–ò–ô (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å, —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å:**
- –ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—É—é —Å—Ö–µ–º—É
- –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º legacy –ø–æ–ª–µ–π (–µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü —É–∂–µ –µ—Å—Ç—å
- FK constraints –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### üü¢ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. **–ò–Ω–¥–µ–∫—Å –¥–ª—è `post_enrichment.kind`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **–ú–∏–≥—Ä–∞—Ü–∏—è legacy –ø–æ–ª–µ–π** - –æ—Ç–ª–æ–∂–∏—Ç—å –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–æ–≤—É—é —Å—Ö–µ–º—É

### üîç –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ `kind`:
   ```sql
   EXPLAIN ANALYZE 
   SELECT * FROM post_enrichment WHERE kind = 'vision';
   ```
   –ï—Å–ª–∏ –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç Seq Scan - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å.

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫**:
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ CAS –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å DLQ backlog
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `post_enrichment`

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞ –≤ CAS
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Crawl4ai —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å S3 –æ–ø–µ—Ä–∞—Ü–∏–π

---

## –í—ã–≤–æ–¥

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.**

–û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è `kind` (5 –º–∏–Ω—É—Ç)
- –ú–∏–≥—Ä–∞—Ü–∏—è legacy –ø–æ–ª–µ–π (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

