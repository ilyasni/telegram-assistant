# –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤

## Context

–í—ã–ø–æ–ª–Ω–µ–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ best practices (Context7), —Å —É—á–µ—Ç–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Trend Agents Monitoring.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è trends_stable_task

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç—ã `trends_stable_task`.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `trends_stable_` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
- `trends_stable_task_runs_total{outcome}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –∑–∞–¥–∞—á–∏
- `trends_stable_clusters_checked_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- `trends_stable_clusters_promoted_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- `trends_stable_clusters_skipped_total{reason}` - –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- `trends_stable_task_duration_seconds` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏

**–§–∞–π–ª**: `api/tasks/scheduler_tasks.py`

**Best Practice**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–µ—Ñ–∏–∫—Å `trends_stable_` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏–∑ `trends_worker.py`.

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—á–µ–º—É –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è stable.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
- `no_metrics` - –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
- `freq_too_low` - freq_long < min_freq (30)
- `sources_too_low` - source_diversity < min_sources (3)
- `burst_too_low` - burst_score < min_burst (1.5)
- `is_generic` - –∫–ª–∞—Å—Ç–µ—Ä –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ generic

**–§–∞–π–ª**: `api/tasks/scheduler_tasks.py`

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞**:
```python
logger.debug(
    "trends_stable_task_skipped",
    cluster_id=str(cluster.id),
    reason="freq_too_low",
    freq_long=metrics.freq_long,
    min_freq=min_freq,
    label=cluster.label,
)
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 3.1. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø—Ä–æ—Å—ã –≤ `trends_stable_task` –∏ `_find_cluster_by_label` –±—ã–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏.

**–†–µ—à–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏:
- `idx_trend_clusters_status_generic` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ status –∏ is_generic
- `idx_trend_clusters_label_status` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ label
- `idx_trend_clusters_primary_topic_status` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ primary_topic
- `idx_trend_metrics_cluster_metrics_at` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫

**–§–∞–π–ª**: `supabase/migrations/20250122_add_trend_clusters_performance_indexes.sql`

#### 3.2. –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è _find_cluster_by_label

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–µ—Ç–æ–¥ `_find_cluster_by_label` –≤—ã–ø–æ–ª–Ω—è–ª –∑–∞–ø—Ä–æ—Å –∫ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis (TTL 5 –º–∏–Ω—É—Ç):
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –∫—ç—à –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫—ç—à–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

**–§–∞–π–ª**: `api/worker/trends_worker.py`

**Best Practice**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å TTL, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö —Å–∏—Å—Ç–µ–º—ã.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `trends_stable_` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:

1. **trends_stable_task_runs_total{outcome}**
   - `success` - —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
   - `error` - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

2. **trends_stable_clusters_checked_total**
   - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

3. **trends_stable_clusters_promoted_total**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, –ø—Ä–æ–º–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ stable

4. **trends_stable_clusters_skipped_total{reason}**
   - `no_metrics` - –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫
   - `freq_too_low` - freq_long —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π
   - `sources_too_low` - source_diversity —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π
   - `burst_too_low` - burst_score —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π
   - `is_generic` - –∫–ª–∞—Å—Ç–µ—Ä –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ generic

5. **trends_stable_task_duration_seconds**
   - –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana

–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∞—à–±–æ—Ä–¥ `Trend Agents Monitoring`:
- –ü–∞–Ω–µ–ª—å –¥–ª—è `trends_stable_task_runs_total`
- –ü–∞–Ω–µ–ª—å –¥–ª—è `trends_stable_clusters_promoted_total`
- –ü–∞–Ω–µ–ª—å –¥–ª—è `trends_stable_clusters_skipped_total` –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º
- –ì—Ä–∞—Ñ–∏–∫ `trends_stable_task_duration_seconds`

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus
curl http://localhost:8001/metrics | grep trends_stable
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ trends_stable_task
docker logs api | grep "trends_stable_task"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞
docker logs api | grep "trends_stable_task_skipped"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
docker exec telegram-assistant-supabase-db-1 psql -U postgres -d postgres -f /path/to/20250122_add_trend_clusters_performance_indexes.sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
docker exec telegram-assistant-supabase-db-1 psql -U postgres -d postgres -c "\d+ trend_clusters" | grep idx_trend_clusters
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –≤ Redis
docker exec telegram-assistant-redis-1 redis-cli KEYS "trend:cluster_by_label:*"
```

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏–Ω–¥–µ–∫—Å–æ–≤**:
   ```bash
   docker exec telegram-assistant-supabase-db-1 psql -U postgres -d postgres -f supabase/migrations/20250122_add_trend_clusters_performance_indexes.sql
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞–Ω–µ–ª–∏ –≤ Grafana** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - –î–æ–±–∞–≤–∏—Ç—å –ø–∞–Ω–µ–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –≤ `grafana/dashboards/trend_agents.json`

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ `trends_stable_clusters_skipped_total` –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–∞
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ `trends_stable_task_duration_seconds` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üéØ –ò—Ç–æ–≥–∏

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è trends_stable_task (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è _find_cluster_by_label
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç best practices (Context7)

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

