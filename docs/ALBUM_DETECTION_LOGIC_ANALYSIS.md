# Анализ логики определения альбомов

**Дата**: 2025-11-05 20:05:00  
**Context7**: Анализ логики определения альбомов и выявление проблем

---

## Текущая логика определения альбомов

### 1. Определение `grouped_id`

**Место**: `telethon-ingest/services/channel_parser.py:1248`

```python
grouped_id = getattr(message, 'grouped_id', None)
```

**Контекст**: `grouped_id` извлекается из каждого сообщения Telegram. Если `grouped_id` не `None`, сообщение является частью альбома.

**Проблема**: Нет, работает корректно.

---

### 2. Сохранение постов в БД

**Место**: `telethon-ingest/services/channel_parser.py:1398-1408`

```python
success, error, inserted_count = await self.atomic_saver.save_batch_atomic(
    self.db_session,
    user_data,
    channel_data,
    posts_data
)
```

**Контекст**: Все посты сохраняются в БД с `grouped_id` в поле `posts.grouped_id`.

**Проблема**: Нет, работает корректно.

---

### 3. Сборка альбомов из текущего batch

**Место**: `telethon-ingest/services/channel_parser.py:1410-1506`

```python
# Context7: Группируем посты по grouped_id из сохранённых данных
# Используем grouped_id из posts_data, так как альбом может быть разбит на несколько сообщений
albums_data: Dict[int, Dict[str, Any]] = {}

for post_data in posts_data:
    grouped_id = post_data.get('grouped_id')
    if not grouped_id:
        continue
    
    if grouped_id not in albums_data:
        # ... получение user_uuid ...
        albums_data[grouped_id] = {
            'user_id': user_uuid,
            'channel_id': channel_id,
            'grouped_id': grouped_id,
            'post_ids': [],
            'media_types': [],
            'media_sha256s': [],
            'media_bytes': []
        }
    
    # Добавляем пост в альбом
    post_id = post_data.get('id')
    if post_id:
        albums_data[grouped_id]['post_ids'].append(post_id)
        # ... добавление медиа информации ...
```

**Проблема**: ❌ **КРИТИЧНО** — альбомы собираются ТОЛЬКО из текущего `posts_data` batch!

**Последствия**:
1. Если альбом разбит на несколько batches (например, из-за задержки Telegram API), то второй batch не знает о постах из первого batch
2. Альбомы, которые были в одном batch, должны сохраняться, но не сохраняются из-за SQL ошибок (уже исправлено)
3. Для альбомов, разбитых на несколько batches, альбом никогда не соберется полностью

---

### 4. Фильтрация альбомов

**Место**: `telethon-ingest/services/channel_parser.py:1508-1511`

```python
for grouped_id, album_data in albums_data.items():
    # Фильтруем альбомы с более чем одним элементом
    if len(album_data['post_ids']) <= 1:
        continue  # Одиночное медиа, не альбом
```

**Проблема**: ❌ Если альбом разбит на batches, то каждый batch видит только свои посты, и если в batch только 1 пост, альбом пропускается.

---

## Анализ реальных данных

### Альбомы в одном batch

- **grouped_id=14098870643862234**: 8 постов, время между первым и последним: 0.0 секунд
  - ✅ Вероятно один batch
  - ❌ Альбом НЕ сохранен (из-за SQL ошибки, уже исправлено)

- **grouped_id=14098869512647314**: 2 поста, время между первым и последним: 0.0 секунд
  - ✅ Вероятно один batch
  - ❌ Альбом НЕ сохранен (из-за SQL ошибки, уже исправлено)

### Альбомы в разных batches

- **grouped_id=14098828991549074**: 6 постов, время между первым и последним: 465.9 секунд
  - ⚠️ Возможно разные batches
  - ❌ Альбом НЕ сохранен (логика не собирает альбомы из разных batches)

---

## Context7 Best Practice: Сборка альбомов из БД

### Проблема

Текущая логика собирает альбомы только из текущего batch. Это работает только если:
1. Все посты альбома попадают в один batch
2. Batch обрабатывается полностью

### Решение

**Context7 best practice**: Собирать альбомы из БД, а не только из текущего batch.

**Алгоритм**:
1. После сохранения постов в БД, запросить все посты с `grouped_id` из текущего batch
2. Для каждого `grouped_id`:
   - Запросить ВСЕ посты с этим `grouped_id` из БД (не только из текущего batch)
   - Проверить, есть ли уже альбом в `media_groups`
   - Если альбома нет и постов > 1, создать альбом

**Преимущества**:
- ✅ Работает для альбомов, разбитых на несколько batches
- ✅ Идемпотентность через `UNIQUE (user_id, channel_id, grouped_id)`
- ✅ Не пропускает альбомы из-за разбиения на batches

---

## Рекомендации

### 1. Исправить логику сборки альбомов

**Место**: `telethon-ingest/services/channel_parser.py:1410-1582`

**Изменения**:
1. После сохранения постов, запросить все `grouped_id` из текущего batch
2. Для каждого `grouped_id`:
   - Запросить ВСЕ посты с этим `grouped_id` из БД (для данного канала)
   - Проверить, есть ли уже альбом в `media_groups`
   - Если альбома нет и постов > 1, собрать альбом из БД

### 2. Проверить SQL ошибки

**Статус**: ✅ Исправлено (`CAST(:meta AS jsonb)` вместо `:meta::jsonb`)

### 3. Мониторинг

Добавить метрики:
- Количество альбомов, собранных из одного batch
- Количество альбомов, собранных из нескольких batches
- Количество альбомов, пропущенных из-за разбиения на batches

---

## Следующие шаги

1. ✅ Исправлены SQL ошибки
2. ⏳ Исправить логику сборки альбомов из БД (не только из текущего batch)
3. ⏳ Протестировать на реальных данных
4. ⏳ Добавить метрики мониторинга

