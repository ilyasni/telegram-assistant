# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ OCR —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–î–∞—Ç–∞**: 2025-11-06 22:55  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞

## Context

–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è OCR-—Ç–µ–∫—Å—Ç–∞ –≤ –ë–î. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ `gigachat_vision.py`, –∫–æ—Ç–æ—Ä–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ `vision_analysis`.

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ `gigachat_vision.py`

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –°—Ç—Ä–æ–∫–∞ 329: `vision_cache_hits_total.labels(cache_type="s3").inc()` –∏–º–µ–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
- –°—Ç—Ä–æ–∫–∞ 926: –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ `if` –±–ª–æ–∫–∞

**–û—à–∏–±–∫–∞**:
```
SyntaxError: expected 'except' or 'finally' block (gigachat_vision.py, line 329)
```

**–†–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã –≤ –±–ª–æ–∫–µ `try-except` –¥–ª—è S3 –∫—ç—à–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã –≤ –±–ª–æ–∫–µ `if` –¥–ª—è OCR extraction

**–§–∞–π–ª—ã**:
- `worker/ai_adapters/gigachat_vision.py` (—Å—Ç—Ä–æ–∫–∏ 329, 926)

### 2. ‚ö†Ô∏è Vision Analysis Task –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- Task `vision_analysis` –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–ª –∏–∑-–∑–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Vision –±—ã–ª–æ **2025-11-06 09:28:06** (–±–æ–ª–µ–µ 13 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞

### 3. ‚ö†Ô∏è –ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–æ–¥—É–ª—å `shared.python`

**–ü—Ä–æ–±–ª–µ–º–∞**: 
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
```
ModuleNotFoundError: No module named 'shared.python'
```

**–¢—Ä–µ–±—É–µ—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—É—Ç–µ–π –∏–º–ø–æ—Ä—Ç–∞

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ OCR –≤ –ë–î

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```
–í—Å–µ–≥–æ Vision –∑–∞–ø–∏—Å–µ–π: 528
–° OCR —Ç–µ–∫—Å—Ç–æ–º: 204 (38.64%)
–ë–µ–∑ OCR: 324 (61.36%)
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-11-06 09:28:06
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º

| Provider | –í—Å–µ–≥–æ | –° OCR | –ü—Ä–æ—Ü–µ–Ω—Ç OCR | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ |
|----------|-------|-------|-------------|---------------------|
| gigachat | ~126  | ~113  | ~89.68%     | 2025-11-06 09:28:06 |
| ocr_fallback | ~266 | ~0   | 0%         | - |

### –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Å OCR

–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π —Å OCR —Ç–µ–∫—Å—Ç–æ–º:
- `5770174e-528a-438d-8eb0-232542f15068` - 608 —Å–∏–º–≤–æ–ª–æ–≤ OCR
- `8dd96610-efa4-40c5-b440-e7d47eed6619` - 608 —Å–∏–º–≤–æ–ª–æ–≤ OCR
- `917151d3-6777-4f00-992c-033e17ecba2b` - 443 —Å–∏–º–≤–æ–ª–∞ OCR

**–í—Å–µ –∑–∞–ø–∏—Å–∏ —Å OCR –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä `gigachat`**.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ OCR

**–§–∞–π–ª**: `shared/python/shared/schemas/enrichment_validation.py`

–î–æ–±–∞–≤–ª–µ–Ω –≤–∞–ª–∏–¥–∞—Ç–æ—Ä `validate_ocr()`, –∫–æ—Ç–æ—Ä—ã–π:
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ø—É—Å—Ç—ã–µ OCR –æ–±—ä–µ–∫—Ç—ã –≤ `None`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º `OCRData`
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

**–§–∞–π–ª**: `worker/ai_adapters/gigachat_vision.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
1. –°—Ç—Ä–æ–∫–∞ 329: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è `vision_cache_hits_total.labels()`
2. –°—Ç—Ä–æ–∫–∞ 926: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è `return` –≤ –±–ª–æ–∫–µ `if`

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ `gigachat_vision.py`
2. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –º–æ–¥—É–ª–µ–º `shared.python`
3. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è**: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –ø–∞–¥–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ `vision_analysis`
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ OCR
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ OCR
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ OCR –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### SQL –∑–∞–ø—Ä–æ—Å—ã

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å OCR
SELECT 
    post_id,
    updated_at,
    provider,
    LENGTH(data->'ocr'->>'text') as ocr_length
FROM post_enrichment 
WHERE kind = 'vision' 
  AND data->'ocr'->>'text' IS NOT NULL 
  AND LENGTH(data->'ocr'->>'text') > 0
ORDER BY updated_at DESC 
LIMIT 10;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
SELECT 
    COUNT(*) FILTER (WHERE data->'ocr'->>'text' IS NOT NULL AND LENGTH(data->'ocr'->>'text') > 0) as with_ocr,
    COUNT(*) FILTER (WHERE data->'ocr'->>'text' IS NULL OR LENGTH(data->'ocr'->>'text') = 0) as without_ocr
FROM post_enrichment 
WHERE kind = 'vision' 
  AND updated_at > NOW() - INTERVAL '24 hours';
```

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫ vision_analysis task
docker compose logs worker | grep -i "vision_analysis.*started"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏
docker compose logs worker | grep -i "vision_analysis.*error"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ OCR
docker compose logs worker | grep -i "ocr.*saved\|vision.*saved"
```

## –í—ã–≤–æ–¥—ã

1. ‚úÖ **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**: –§–∞–π–ª `gigachat_vision.py` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
2. ‚ö†Ô∏è **Vision Analysis –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**: –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –º–æ–¥—É–ª–µ–º `shared.python`
3. üìä **OCR —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**: 38.64% –∑–∞–ø–∏—Å–µ–π –∏–º–µ—é—Ç OCR —Ç–µ–∫—Å—Ç
4. üìÖ **–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ë–æ–ª–µ–µ 13 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥ (–∏–∑-–∑–∞ –ø–∞–¥–µ–Ω–∏—è –∑–∞–¥–∞—á–∏)

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –º–æ–¥—É–ª–µ–º `shared.python`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ `vision_analysis` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å OCR

