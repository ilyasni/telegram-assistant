# –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –≤ Telegram-–≥—Ä—É–ø–ø–∞—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω (4/6/12/24 —á–∞—Å–∞). –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ –±–∞–∑–µ LangGraph-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GigaChat —á–µ—Ä–µ–∑ `langchain_gigachat`.

## –û–±—â–∞—è —Å—Ö–µ–º–∞

```
–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí Ingestion ‚Üí –ê–≥—Ä–µ–≥–∞—Ü–∏—è –æ–∫–æ–Ω ‚Üí –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –î–æ—Å—Ç–∞–≤–∫–∞
```

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º

### 1. –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- –†—É—á–Ω–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ API (`/api/groups/{group_id}/digest`)
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (`scheduler_tasks.enqueue_group_digest`)
- –°–æ–±—ã—Ç–∏–µ `GroupDigestRequestedEventV1`

**–î–µ–π—Å—Ç–≤–∏—è:**
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è `digests.generate` —Å –ø–æ–ª—è–º–∏:
  - `group_window_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–∫–Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è
  - `window_size_hours` ‚Äî —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ (4/6/12/24)
  - `delivery_channel` ‚Äî –∫–∞–Ω–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏ (telegram)
  - `delivery_format` ‚Äî —Ñ–æ—Ä–º–∞—Ç (telegram_html/markdown)
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Redis Streams —á–µ—Ä–µ–∑ `EventPublisher`

**–§–∞–π–ª—ã:**
- `api/tasks/scheduler_tasks.py:enqueue_group_digest`
- `api/bot/handlers/group_handlers.py:cmd_group_digest`

---

### 2. Ingestion (–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö)

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- `telethon-ingest` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `group_messages` + `group_message_analytics`
- –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ `worker/tasks/embeddings.py` (`process_group_message_embeddings`)
- –í–µ–∫—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Qdrant (`t{tenant}_groups`)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–æ–±—â–µ–Ω–∏—è —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π (sentiment, emotions, tags, entities)
- –ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (mime_type, size, description, OCR)

**–§–∞–π–ª—ã:**
- `worker/tasks/embeddings.py`
- `api/models/database.py:GroupMessage`

---

### 3. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –æ–∫–æ–Ω

**–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:**
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ `group_conversation_windows` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
- –°—á–∏—Ç–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
  - `message_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
  - `participant_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  - `window_start`, `window_end` ‚Äî –≥—Ä–∞–Ω–∏—Ü—ã –æ–∫–Ω–∞

**–°—Ç–∞—Ç—É—Å—ã –æ–∫–Ω–∞:**
- `pending` ‚Äî –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `processing` ‚Äî –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- `completed` ‚Äî –¥–∞–π–¥–∂–µ—Å—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω
- `failed` ‚Äî –æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `api/models/database.py:GroupConversationWindow`

---

### 4. –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (LangGraph Workflow)

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä `GroupDigestOrchestrator` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–æ–≤:

#### 4.1. Ingest Validator (`_node_ingest_validator`)

**–¶–µ–ª—å:** –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω `DIGEST_CONTEXT_STORAGE_ENABLED`):
   - –ó–∞–ø—Ä–æ—Å –∫ Context7 Storage —á–µ—Ä–µ–∑ `Context7StorageClient.fetch_recent_context`
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –æ–∫–æ–Ω (`history_windows`) –∏ M —Å–æ–æ–±—â–µ–Ω–∏–π (`history_message_limit`)

2. **–°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ `GroupContextService.assemble`**:
   - **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:**
     - –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ PII (—Ç–µ–ª–µ—Ñ–æ–Ω—ã, email, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
     - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
     - –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –æ —Ä–µ–∞–∫—Ü–∏—è—Ö (`reaction_count`)
   
   - **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
     - –ñ—ë—Å—Ç–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø–æ—Ä–æ–≥ `DIGEST_CONTEXT_SIMILARITY` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.95)
     - –ú—è–≥–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø–æ—Ä–æ–≥ `DIGEST_CONTEXT_SOFT_SIMILARITY` (0.85)
     - –í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ—Ä–æ–≥: `DIGEST_CONTEXT_DEDUP_TIME` (5 –º–∏–Ω—É—Ç)
     - –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (`historical_links`)
   
   - **–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ:**
     - –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–æ—Ä–∏–Ω–≥ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
       ```
       score = (recency_weight * exp(-age/half_life)) +
               (reply_weight * has_replies) +
               (length_weight * normalized_length) +
               (reaction_weight * reaction_count)
       ```
     - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `DIGEST_CONTEXT_HALF_LIFE`, –≤–µ—Å–∞ –∏–∑ `ContextScoringWeights`
     - –í—ã–±–æ—Ä top-k —Å–æ–æ–±—â–µ–Ω–∏–π (`DIGEST_CONTEXT_TOP_RANKED`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 150)
   
   - **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞:**
     - –û–±—Ä–µ–∑–∫–∞ –¥–æ `max_messages` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 400) –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
     - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: `trimmed_for_max`, `duplicates_removed`

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç ‚Üí `skip=True`, `skip_reason="empty_window"`
   - –ï—Å–ª–∏ –º–µ–Ω—å—à–µ `min_messages` ‚Üí `skip=True`, `skip_reason="too_few_messages"`

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
   - –ó–∞–ø–∏—Å—å –≤ Context7 Storage —á–µ—Ä–µ–∑ `upsert_window_context` (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –≤ `group_digest_stage_artifacts`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `sanitized_messages` ‚Äî –æ—á–∏—â–µ–Ω–Ω—ã–µ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `context_stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (duplicates_removed, trimmed_for_max, historical_matches)
- `context_ranking` ‚Äî —Ç–æ–ø —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ—Ü–µ–Ω–∫–∞–º–∏
- `context_duplicates` ‚Äî –∫–∞—Ä—Ç–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- `context_history_links` ‚Äî —Å–≤—è–∑–∏ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- `media_stats`, `media_highlights` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ç–æ–ø –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_ingest_validator`
- `api/worker/services/group_context_service.py:assemble`
- `api/worker/services/context7_storage_client.py`

---

#### 4.2. Thread Builder (`_node_thread_builder`)

**–¶–µ–ª—å:** –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ –æ—Ç–≤–µ—Ç–æ–≤ (threads) –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Å–≤—è–∑—è–º `reply_to_message_id`
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã thread (`thread_max_len`)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `threads` ‚Äî —Å–ø–∏—Å–æ–∫ —Ü–µ–ø–æ—á–µ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_thread_builder`
- `api/worker/common/thread_builder.py:build_threads`

---

#### 4.3. Segmenter Agent (`_node_segmenter`)

**–¶–µ–ª—å:** –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –Ω–∞ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑–æ–≤ LLM (GigaChat) —á–µ—Ä–µ–∑ `LLMRouter` —Å –ø—Ä–æ–º–ø—Ç–æ–º `semantic_segmenter_prompt_v1`
2. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - `threads` ‚Äî —Ü–µ–ø–æ—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `window` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–∫–Ω–∞
3. –í–∞–ª–∏–¥–∞—Ü–∏—è JSON-–æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ `_ensure_valid_json`:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã `JSON_SCHEMAS["segmenter_agent"]`
   - –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö ‚Äî –ø–æ–ø—ã—Ç–∫–∞ —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `_run_repair` (–¥–æ 2 –ø–æ–ø—ã—Ç–æ–∫)
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `semantic_units` ‚Äî —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Å:
   - `title` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞
   - `message_ids` ‚Äî —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - `summary` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
   - `keywords` ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `semantic_units` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_segmenter`
- `api/worker/prompts/group_digest.py:semantic_segmenter_prompt_v1`

---

#### 4.4. Emotion Agent (`_node_emotion_profile`)

**–¶–µ–ª—å:** –ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º `emotion_analyzer_prompt_v1`
2. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - `semantic_units` ‚Äî —Å–µ–≥–º–µ–Ω—Ç—ã
   - `sanitized_messages` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:
   - `sentiment` ‚Äî –æ–±—â–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (positive/neutral/negative)
   - `intensity` ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–π (0.0-1.0)
   - `stress` ‚Äî –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–µ—Å—Å–∞
   - `collaboration` ‚Äî –∏–Ω–¥–µ–∫—Å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞
   - `conflict` ‚Äî –∏–Ω–¥–µ–∫—Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
   - `enthusiasm` ‚Äî –∏–Ω–¥–µ–∫—Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `emotion_profile` ‚Äî —Å–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —ç–º–æ—Ü–∏–π
- `metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_emotion_profile`
- `api/worker/prompts/group_digest.py:emotion_analyzer_prompt_v1`

---

#### 4.5. Roles Agent (`_node_roles`)

**–¶–µ–ª—å:** –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–æ–ª–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º `role_classifier_prompt_v1`
2. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - `sanitized_messages` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è
   - `participant_stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π:
   - `participant_tg_id` ‚Äî Telegram ID
   - `username` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `role` ‚Äî —Ä–æ–ª—å (leader, contributor, observer, etc.)
   - `message_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `summary` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∞

**Fallback:**
- –ï—Å–ª–∏ LLM –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–æ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞:
  - –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –¥–ª–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞
  - –ü–æ –Ω–∞–ª–∏—á–∏—é –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `participants` ‚Äî —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å —Ä–æ–ª—è–º–∏
- `role_profile` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Ä–æ–ª–µ–π

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_roles`
- `api/worker/prompts/group_digest.py:role_classifier_prompt_v1`

---

#### 4.6. Topic Agent (`_node_topics`)

**–¶–µ–ª—å:** –°–∏–Ω—Ç–µ–∑ —Ç–µ–º –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏–∑ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º `topic_synthesizer_prompt_v1`
2. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - `semantic_units` ‚Äî —Å–µ–≥–º–µ–Ω—Ç—ã
   - `emotion_profile` ‚Äî —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
   - `media_highlights` ‚Äî —Ç–æ–ø –º–µ–¥–∏–∞-—Ñ–∞–π–ª—ã
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–º:
   - `title` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
   - `priority` ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (high/medium/low)
   - `msg_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `threads` ‚Äî —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - `summary` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
   - `keywords` ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
   - `actions` ‚Äî –¥–µ–π—Å—Ç–≤–∏—è/—Ä–µ—à–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

**Fallback:**
- –ï—Å–ª–∏ LLM –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–º—ã –∏–ª–∏ –≤—Å–µ —Ç–µ–º—ã "–û–±—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ":
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `GroupContextService.build_keyword_topics`
  - –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–æ—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `topics` ‚Äî —Å–ø–∏—Å–æ–∫ —Ç–µ–º —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_topics`
- `api/worker/prompts/group_digest.py:topic_synthesizer_prompt_v1`
- `api/worker/services/group_context_service.py:build_keyword_topics`

---

#### 4.7. Synthesis Agent (`_node_synthesis`)

**–¶–µ–ª—å:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown/HTML.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. **–ó–∞–≥—Ä—É–∑–∫–∞ baseline (–ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞):**
   - –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `load_previous_snapshot` –∏–∑ `group_digest_stage_artifacts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

2. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**
   - `window_json` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–∫–Ω–∞
   - `topics_json` ‚Äî —Ç–µ–º—ã
   - `participants_json` ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫–∏
   - `role_profile_json` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Ä–æ–ª–µ–π
   - `metrics_json` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ —ç–º–æ—Ü–∏–π
   - `media_highlights_json` ‚Äî —Ç–æ–ø –º–µ–¥–∏–∞ (–¥–æ 4)
   - `media_stats_json` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–¥–∏–∞
   - `baseline_digest` ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∞–π–¥–∂–µ—Å—Ç (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
   - `group_title`, `period`, `message_count` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

3. **–í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º `digest_composer_prompt_v1`**

4. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   - –û–±—Ä–µ–∑–∫–∞ –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç Telegram)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ "üìä <b>–î–∞–π–¥–∂–µ—Å—Ç</b>\n" –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

5. **Retry –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ:**
   - –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `digest_composer_retry_prompt_v1`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è baseline –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `summary_html` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –≤ HTML
- `summary` ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
- `baseline_snapshot` ‚Äî —Å–Ω–∏–º–æ–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–∫–Ω–∞

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_synthesis`
- `api/worker/prompts/group_digest.py:digest_composer_prompt_v1`
- `api/worker/common/baseline_compare.py:load_previous_snapshot`

---

#### 4.8. Evaluation Agent (`_node_quality`)

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–π–¥–∂–µ—Å—Ç–∞ (LLM-as-judge).

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º `quality_evaluator_prompt_v1`
2. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - `conversation_excerpt` ‚Äî –≤—ã–¥–µ—Ä–∂–∫–∞ –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
   - `digest_html` ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:
   - `faithfulness` (0.0-1.0) ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
   - `coherence` (0.0-1.0) ‚Äî —Å–≤—è–∑–Ω–æ—Å—Ç—å –∏ –ª–æ–≥–∏—á–Ω–æ—Å—Ç—å
   - `coverage` (0.0-1.0) ‚Äî –ø–æ–ª–Ω–æ—Ç–∞ –æ—Ö–≤–∞—Ç–∞ —Ç–µ–º
   - `focus` (0.0-1.0) ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≤–∞–∂–Ω–æ–º
   - `quality_score` ‚Äî –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
   - `notes` ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞:**
   - –ü–æ—Ä–æ–≥ `QUALITY_THRESHOLD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.6)
   - –ï—Å–ª–∏ –º–∏–Ω–∏–º—É–º –º–µ—Ç—Ä–∏–∫ < –ø–æ—Ä–æ–≥–∞:
     - –ü–æ–ø—ã—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `_attempt_corrective_synthesis`
     - –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
     - –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–∏–∑–∫–æ ‚Üí `quality_below_threshold`, –∑–∞–ø–∏—Å—å –≤ DLQ

6. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å baseline:**
   - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `baseline_delta` —á–µ—Ä–µ–∑ `compute_delta`:
     - `coverage_change` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–∞
     - `topic_overlap` ‚Äî –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Ç–µ–º
     - `quality_delta` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `evaluation` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –æ—Ü–µ–Ω–∫–∏
- `baseline_delta` ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –¥–∞–π–¥–∂–µ—Å—Ç–æ–º

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_quality`
- `api/worker/prompts/group_digest.py:quality_evaluator_prompt_v1`
- `api/worker/common/baseline_compare.py:compute_delta`

---

#### 4.9. Delivery Manager (`_node_delivery`)

**–¶–µ–ª—å:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è workflow.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `skip`:
   - –ï—Å–ª–∏ `skip=True` ‚Üí `status="blocked_{skip_reason}"`
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ ‚Üí `status="blocked_failure"`
   - –ò–Ω–∞—á–µ ‚Üí `status="pending"`

2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏:
   - `delivery_channel` ‚Äî –∫–∞–Ω–∞–ª (telegram)
   - `delivery_format` ‚Äî —Ñ–æ—Ä–º–∞—Ç (telegram_html)
   - `trace_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–µ–π—Å–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `delivery` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- `dlq_events` ‚Äî —Å–æ–±—ã—Ç–∏—è –¥–ª—è DLQ (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏)

**–§–∞–π–ª—ã:**
- `api/worker/tasks/group_digest_agent.py:_node_delivery`

---

### 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–°–µ—Ä–≤–∏—Å:** `GroupDigestService.generate`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞:**
   - –¢–∞–±–ª–∏—Ü–∞ `group_digests`:
     - `window_id` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–∫–Ω–æ
     - `summary` ‚Äî —Ç–µ–∫—Å—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞
     - `payload` ‚Äî JSON —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (topics, participants, metrics, evaluation, baseline_delta, context_stats, etc.)
     - `evaluation_scores` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –æ—Ü–µ–Ω–∫–∏
     - `delivery_status` ‚Äî —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏
     - `delivery_metadata` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º:**
   - –¢–∞–±–ª–∏—Ü–∞ `group_digest_topics`:
     - `digest_id` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞–π–¥–∂–µ—Å—Ç
     - `topic` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
     - `priority` ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
     - `message_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
     - `representative_messages` ‚Äî ID —Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
     - `keywords` ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
     - `actions` ‚Äî –¥–µ–π—Å—Ç–≤–∏—è/—Ä–µ—à–µ–Ω–∏—è

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:**
   - –¢–∞–±–ª–∏—Ü–∞ `group_digest_participants`:
     - `digest_id` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞–π–¥–∂–µ—Å—Ç
     - `participant_tg_id` ‚Äî Telegram ID
     - `participant_username` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - `role` ‚Äî —Ä–æ–ª—å
     - `message_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
     - `contribution_summary` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∞

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:**
   - –¢–∞–±–ª–∏—Ü–∞ `group_digest_metrics`:
     - `digest_id` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞–π–¥–∂–µ—Å—Ç
     - `sentiment` ‚Äî —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
     - `stress_index` ‚Äî –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–µ—Å—Å–∞
     - `collaboration_index` ‚Äî –∏–Ω–¥–µ–∫—Å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞
     - `conflict_index` ‚Äî –∏–Ω–¥–µ–∫—Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
     - `enthusiasm_index` ‚Äî –∏–Ω–¥–µ–∫—Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞
     - `raw_scores` ‚Äî –ø–æ–ª–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞:**
   - `window.status = "completed"`
   - `window.generated_at = datetime.utcnow()`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `message_count`, `participant_count`

6. **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Neo4j (GraphRAG):**
   - –í—ã–∑–æ–≤ `GraphService.upsert_group_conversation`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–µ–π: —É—á–∞—Å—Ç–Ω–∏–∫–∏ ‚Üí —Ç–µ–º—ã ‚Üí –¥–∞–π–¥–∂–µ—Å—Ç
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

7. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è DLQ-—Å–æ–±—ã—Ç–∏–π:**
   - –ï—Å–ª–∏ –µ—Å—Ç—å `dlq_events` ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ `digests.generate.dlq`

**–§–∞–π–ª—ã:**
- `api/services/group_digest_service.py:generate`
- `api/models/database.py:GroupDigest, GroupDigestTopic, GroupDigestParticipant, GroupDigestMetric`

---

### 6. –î–æ—Å—Ç–∞–≤–∫–∞

**–í–æ—Ä–∫–µ—Ä:** `DigestWorker._send_digest`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–π–¥–∂–µ—Å—Ç–∞ –∏–∑ –ë–î –ø–æ `digest_id`
2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
   - –ï—Å–ª–∏ `delivery_format="telegram_html"` ‚Üí HTML-—Ä–∞–∑–º–µ—Ç–∫–∞
   - –ï—Å–ª–∏ `delivery_format="markdown"` ‚Üí Markdown
3. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ `user_id` –∏–∑ `requested_by_user_id` –∏–ª–∏ `group_id`
   - –í—ã–∑–æ–≤ `bot.send_message` —Å HTML/Markdown
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:
   - `group_digests.delivered_at = datetime.utcnow()`
   - `group_digests.delivery_status = "sent"` (–∏–ª–∏ `"failed"` –ø—Ä–∏ –æ—à–∏–±–∫–µ)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `digest_worker_send_seconds{status="success|failed|telegram_error"}` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏

**–§–∞–π–ª—ã:**
- `api/worker/tasks/digest_worker.py:_send_digest`

---

## –ú–µ—Ö–∞–Ω–∏–∑–º—ã –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `group_digest_stage_artifacts`
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞ —á–µ—Ä–µ–∑ `_load_cached_stage`
- –ö–ª—é—á: `digest:{tenant_id}:{group_id}:{window_id}:{stage}`

### –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `_run_repair`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç `*_repair_prompt_v1`
- –î–æ 2 –ø–æ–ø—ã—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### Circuit Breaker –∏ Retry
- `_generation_cb` ‚Äî circuit breaker –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ LLM
- `_generation_retry` ‚Äî retry-–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### DLQ (Dead Letter Queue)
- –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö ‚Üí –∑–∞–ø–∏—Å—å –≤ `digests.generate.dlq`
- –°–æ–±—ã—Ç–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç:
  - `error_code`, `error_details`
  - `stack_trace`
  - `retry_count`
  - `first_seen_at`, `next_retry_at`

### Baseline Comparison
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –¥–∞–π–¥–∂–µ—Å—Ç–æ–º –¥–ª—è:
  - –í—ã–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (`baseline_delta`)
  - –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
  - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `worker/config/group_digest_models.yml`

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `max_messages` ‚Äî –º–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (400)
- `min_messages` ‚Äî –º–∏–Ω–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (5)
- `chunk_size` ‚Äî —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `max_retries` ‚Äî –º–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (2)
- `context.*` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (dedup, ranking, storage)
- `resilience.*` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ (retry, circuit breaker)

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `DIGEST_CONTEXT_STORAGE_ENABLED` ‚Äî –≤–∫–ª—é—á–∏—Ç—å Context7 Storage
- `DIGEST_CONTEXT_SIMILARITY` ‚Äî –ø–æ—Ä–æ–≥ –∂—ë—Å—Ç–∫–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (0.95)
- `DIGEST_CONTEXT_SOFT_SIMILARITY` ‚Äî –ø–æ—Ä–æ–≥ –º—è–≥–∫–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (0.85)
- `DIGEST_CONTEXT_TOP_RANKED` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø —Å–æ–æ–±—â–µ–Ω–∏–π (150)
- `DIGEST_CONTEXT_MAX_MESSAGES` ‚Äî –º–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π (400)

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

**Prometheus –º–µ—Ç—Ä–∏–∫–∏:**
- `digest_stage_status_total{stage, status}` ‚Äî —Å—Ç–∞—Ç—É—Å—ã —ç—Ç–∞–ø–æ–≤
- `digest_stage_latency_seconds{stage, status}` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–æ–≤
- `digest_messages_processed_total{tenant}` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `digest_quality_score{metric}` ‚Äî –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (faithfulness, coherence, coverage, focus, overall)
- `digest_skipped_total{reason}` ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã
- `digest_dlq_total{stage, error_code}` ‚Äî —Å–æ–±—ã—Ç–∏—è DLQ
- `digest_worker_generation_seconds{status}` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- `digest_worker_send_seconds{status}` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ `structlog`
- –¢—Ä–µ–π—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ OpenTelemetry (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
- –°—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ (`LOG_SAMPLE_RATE`)

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **LLM:** –¢–æ–ª—å–∫–æ GigaChat —á–µ—Ä–µ–∑ `langchain_gigachat` (–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π)
2. **–ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ç—Ä–æ–ª—å `tenant_id` –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
3. **–†–∞–∑–º–µ—Ä –¥–∞–π–¥–∂–µ—Å—Ç–∞:** –ú–∞–∫—Å–∏–º—É–º 4096 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç Telegram)
4. **–ú–∏–Ω–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π:** –ù–µ –º–µ–Ω–µ–µ `min_messages` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
5. **–ö–∞—á–µ—Å—Ç–≤–æ:** –ú–∏–Ω–∏–º—É–º –º–µ—Ç—Ä–∏–∫ –æ—Ü–µ–Ω–∫–∏ >= `QUALITY_THRESHOLD` (0.6)

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/GROUP_DIGEST_PIPELINE.md` ‚Äî –æ–±–∑–æ—Ä –ø–∞–π–ø–ª–∞–π–Ω–∞
- `docs/GROUP_DIGEST_EVENT_FLOW.md` ‚Äî –ø–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π
- `docs/GROUP_DIGEST_INTEGRATION_SCHEME.md` ‚Äî —Å—Ö–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- `docs/DATABASE_SCHEMA.md` ‚Äî —Å—Ö–µ–º–∞ –ë–î
- `docs/API_CONTRACTS.md` ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã API

