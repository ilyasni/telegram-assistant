# –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏

**–î–∞—Ç–∞**: 2025-01-22  
**Context7**: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å—Ç–æ–≤ –∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏

---

## Context

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

---

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ü–∞—Ä—Å–∏–Ω–≥**: –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è (28 –ø–æ—Å—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å)
2. **Tagging**: –†–∞–±–æ—Ç–∞–µ—Ç, —Å–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ `posts.tagged` (5160 —Å–æ–±—ã—Ç–∏–π)
3. **Indexing**: –†–∞–±–æ—Ç–∞–µ—Ç, —Å–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ `posts.indexed` (7014 —Å–æ–±—ã—Ç–∏–π)
4. **Trend Agents**: –†–∞–±–æ—Ç–∞—é—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ `posts.indexed`

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: `posts.enriched` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ 5 —Å–æ–±—ã—Ç–∏–π, —Ö–æ—Ç—è `posts.tagged` —Å–æ–¥–µ—Ä–∂–∏—Ç 5160 —Å–æ–±—ã—Ç–∏–π.

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
1. **Stream –æ—á–∏—â–∞–µ—Ç—Å—è**: `REDIS_STREAM_MAXLEN=100000` –º–æ–∂–µ—Ç –æ—á–∏—â–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è
2. **–°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è, –Ω–æ –±—ã—Å—Ç—Ä–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è**: Consumer groups –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –æ–Ω–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è
3. **–°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ –¥—Ä—É–≥–æ–π stream**: –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –ª–∏ —Å–æ–±—ã—Ç–∏—è –≤ –¥—Ä—É–≥–æ–π stream

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
- Consumer group `enrich_workers`: `lag=0` - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- Consumer group `indexing_workers`: `lag=0` - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è `posts.enriched` –∏ `posts.indexed` —Å–≤–µ–∂–∏–µ (10:20-10:21)

**–í—ã–≤–æ–¥**: –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, stream –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑-–∑–∞ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.

---

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ EnrichmentTask - –ø—É–±–ª–∏–∫–∞—Ü–∏—è skipped enrichment

**–ü—Ä–æ–±–ª–µ–º–∞**: EnrichmentTask –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ —Ü–µ–ø–æ—á–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è skipped enrichment –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è skipped enrichment –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ post_id
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è skipped enrichment –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è skipped enrichment –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è post_id –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –ë–î

**–§–∞–π–ª**: `api/worker/tasks/enrichment_task.py`

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/ENRICHMENT_TASK_AUDIT_FIXES.md`

---

### 2. ‚úÖ Trend Agents Monitoring

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–µ—Ç—Ä–∏–∫–∏ `rate()` –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ 0, –∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞–Ω–µ–ª–∏ —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–±—ã—Ç–∏–π (–Ω–µ rate)
- –£–ª—É—á—à–µ–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫ –≤ Grafana

**–§–∞–π–ª**: `grafana/dashboards/trend_agents.json`

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/ENRICHMENT_TASK_FIX_AND_TREND_AGENTS_MONITORING.md`

---

### 3. ‚úÖ Parsing fixes

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–æ—Å—Ç–æ–≤ –≤ –ë–î.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `last_parsed_at`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `processed`
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ª—å–±–æ–º–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/PARSING_FULL_AUDIT_FIXES.md`

---

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ò–Ω–¥–µ–∫—Å –¥–ª—è post_enrichment.kind**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞
   - –î–æ–±–∞–≤–∏—Ç—å, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–∏–∑–∫–∏–π (–≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

2. **–ú–∏–≥—Ä–∞—Ü–∏—è legacy –ø–æ–ª–µ–π –≤ post_enrichment**
   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `ocr_text`, `vision_labels`, `crawl_md` –≤ `data` JSONB
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–∏–∑–∫–∏–π (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

3. **–£–ª—É—á—à–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Vision –æ—Ç–≤–µ—Ç–æ–≤**
   - –£–ª—É—á—à–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ GigaChat Vision
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–∏–∑–∫–∏–π (—Ç–µ–∫—É—â–∏–π –ø–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Grafana
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å lag –≤ consumer groups
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ streams

### 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ worker
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å consumer groups lag
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ `REDIS_STREAM_MAXLEN` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤
docker compose exec -T supabase-db psql -U postgres -d postgres -c "SELECT COUNT(*) as posts_count, MAX(created_at) as last_post FROM posts WHERE created_at >= NOW() - INTERVAL '1 hour';"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ streams
docker compose exec -T redis redis-cli XLEN stream:posts:parsed
docker compose exec -T redis redis-cli XLEN stream:posts:tagged
docker compose exec -T redis redis-cli XLEN stream:posts:enriched
docker compose exec -T redis redis-cli XLEN stream:posts:indexed

# –ü—Ä–æ–≤–µ—Ä–∫–∞ consumer groups
docker compose exec -T redis redis-cli XINFO GROUPS stream:posts:tagged
docker compose exec -T redis redis-cli XINFO GROUPS stream:posts:enriched
docker compose exec -T redis redis-cli XINFO GROUPS stream:posts:indexed

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫
docker compose exec -T worker curl -s http://localhost:8001/metrics | grep posts_processed_total
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

- –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### üîÑ –¢—Ä–µ–±—É–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ streams
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å lag –≤ consumer groups
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Grafana

### üü¢ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å legacy –ø–æ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –£–ª—É—á—à–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ Vision –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

