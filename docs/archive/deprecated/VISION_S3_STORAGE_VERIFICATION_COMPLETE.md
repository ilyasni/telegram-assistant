# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Vision & S3 Storage: –∑–∞–≤–µ—Ä—à–µ–Ω–æ

**–î–∞—Ç–∞**: 2025-01-22  
**Context7**: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Vision Analysis Task —Å S3 Storage Service –∏ Storage Quota Tracking.

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è S3StorageService
- ‚úÖ `S3StorageService` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `api/worker/tasks/vision_analysis_task.py`
- ‚úÖ `S3StorageService` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ `create_vision_analysis_task()` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `s3_config`
- ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä `s3_service` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `VisionAnalysisTask`

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è StorageQuotaService
- ‚úÖ `StorageQuotaService` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `api/worker/tasks/vision_analysis_task.py`
- ‚úÖ `StorageQuotaService` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å `db_pool` (asyncpg) –¥–ª—è tenant usage tracking
- ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä `storage_quota` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `VisionAnalysisTask`
- ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä `storage_quota` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `GigaChatVisionAdapter` (—Å—Ç—Ä–æ–∫–∞ 3203)

### 3. GigaChatVisionAdapter: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
- ‚úÖ `storage_quota: Optional[StorageQuotaService]` –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä—É `__init__`
- ‚úÖ `self.storage_quota = storage_quota` —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `storage_quota_enabled` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ S3StorageService –≤ VisionAnalysisTask
- ‚úÖ `self.s3_service` –¥–æ—Å—Ç—É–ø–µ–Ω –≤ `VisionAnalysisTask`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `head_object()` –∏ `get_object()` –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–¥–∏–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `get_json()` –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ phash –∫—ç—à–∞ –∏–∑ S3
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `put_json()` –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ phash –∫—ç—à–∞ –≤ S3

### 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ S3StorageService –≤ GigaChatVisionAdapter
- ‚úÖ `self.s3_service` –¥–æ—Å—Ç—É–ø–µ–Ω –≤ `GigaChatVisionAdapter`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `build_vision_key()` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞ S3 –∫—ç—à–∞ –¥–ª—è vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `head_object()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ S3 –∫—ç—à–µ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `get_json()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑ S3 –∫—ç—à–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `put_json()` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ S3 –∫—ç—à –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞

### 6. –§–æ—Ä–º–∞—Ç—ã –∫–ª—é—á–µ–π S3
- ‚úÖ –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã: `media/{tenant_id}/{sha256[:2]}/{sha256}.{ext}`
- ‚úÖ Vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∫—ç—à): `vision/{tenant_id}/{sha256}_{provider}_{model}_v{schema_version}.json`

### 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ vision_analysis_task.py
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ `channel_username` –∏–∑ –ë–î –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫–∏ Vision (—Å—Ç—Ä–æ–∫–∏ 543-579)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `quota_exhausted` —á–µ—Ä–µ–∑ `budget_gate` (–æ–¥–∏–Ω –≤—ã–∑–æ–≤, —Å—Ç—Ä–æ–∫–∏ 582-589)
- ‚úÖ –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–¥–∏–∞ (–¥–ª—è –∞–ª—å–±–æ–º–æ–≤) –≤ `_save_to_db`

### 8. Storage Quota Tracking –¥–ª—è Vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### 8.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- ‚úÖ –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ JSON –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ S3 (—Å—Ç—Ä–æ–∫–∏ 600-605)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã —á–µ—Ä–µ–∑ `storage_quota.check_quota_before_upload()` (—Å—Ç—Ä–æ–∫–∏ 608-638)
- ‚úÖ Fail-open —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–≤–æ—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (—Å—Ç—Ä–æ–∫–∏ 630-638)
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ S3 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–æ—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 617-629)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ 619-627)

#### 8.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tenant usage –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚úÖ –í—ã–∑–æ–≤ `storage_quota.update_tenant_usage()` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `put_json` (—Å—Ç—Ä–æ–∫–∏ 652-674)
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ `tenant_id`, `content_type="vision"`, `size_bytes`, `objects_count=1`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è usage —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Å—Ç—Ä–æ–∫–∏ 667-674)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prometheus –º–µ—Ç—Ä–∏–∫ `tenant_storage_usage_gb` —á–µ—Ä–µ–∑ StorageQuotaService

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. **S3StorageService**: ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
2. **StorageQuotaService**: ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å `db_pool` –∏ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∞–¥–∞–ø—Ç–µ—Ä
3. **GigaChatVisionAdapter**: ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `storage_quota` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º vision —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ usage**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ S3
6. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: ‚úÖ `channel_username` –∏–∑ –ë–î, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `budget_gate`
7. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: ‚úÖ Fail-open —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–≤–æ—Ç—ã, –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ùå **–ù–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è tenant usage** ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `update_tenant_usage()` –ø–æ—Å–ª–µ `put_json`
2. ‚ùå **–ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å –∫–≤–æ—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º** ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `check_quota_before_upload()`
3. ‚ùå **GigaChatVisionAdapter –Ω–µ –∏–º–µ–ª –¥–æ—Å—Ç—É–ø–∞ –∫ storage_quota** ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `storage_quota` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫**:
   ```promql
   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ storage –¥–ª—è vision –ø–æ tenant
   tenant_storage_usage_gb{content_type="vision", tenant_id="..."}
   
   # –û–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ vision storage
   sum(tenant_storage_usage_gb{content_type="vision"})
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**:
   ```bash
   # –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–≤–æ—Ç—ã
   docker compose logs worker | grep "Quota check"
   
   # –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è usage
   docker compose logs worker | grep "Tenant usage updated for vision result"
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã tenant_storage_usage**:
   ```sql
   SELECT * FROM tenant_storage_usage 
   WHERE content_type = 'vision' 
   ORDER BY last_updated DESC 
   LIMIT 10;
   ```

## Context7 Best Practices

- ‚úÖ **Fail-open —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**: –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–≤–æ—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑)
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å `trace_id`, `tenant_id`, `sha256`
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å `exc_info=True` –∏ `error_type`
- ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ usage –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã
- ‚úÖ **Prometheus –º–µ—Ç—Ä–∏–∫–∏**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤–µ—Ä–Ω–æ.

