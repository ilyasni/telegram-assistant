# –°—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞**: 2025-01-21  
**Context7**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–∞–¥–∞—á —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º best practices

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ RAG –∑–∞–ø—Ä–æ—Å–æ–º

**–§–∞–π–ª**: `api/routers/rag.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Qdrant –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º RAG –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (`points_count`)
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ 503 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- ‚úÖ Fail-open –ø–æ–¥—Ö–æ–¥: –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –≤ –ª–æ–≥–∞—Ö

**–î–µ—Ç–∞–ª–∏**:
```python
# Context7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
collection_name = f"t{tenant_id}_posts"
collections = rag_service.qdrant_client.get_collections()
collection_exists = collection_name in [c.name for c in collections.collections]

if collection_exists:
    collection_info = rag_service.qdrant_client.get_collection(collection_name)
    indexed_count = collection_info.points_count if collection_info else 0
    
    if indexed_count == 0:
        raise HTTPException(
            status_code=503,
            detail={
                "error": "Indexation not ready",
                "message": "–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                "status": "not_indexed",
                "indexed_posts": 0
            }
        )
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ RAG –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (< 10)

### 2. DLQ –¥–ª—è failed —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤

**–§–∞–π–ª**: `api/tasks/scheduler_tasks.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ failed —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π –≤ Redis Stream `stream:user_interests.sync.failed`
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (user_id, error, error_type, timestamp, interests_count)
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ stream (maxlen=10000)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ DLQ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏

**–î–µ—Ç–∞–ª–∏**:
```python
# Context7: DLQ –¥–ª—è failed —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
try:
    import redis.asyncio as redis
    redis_client = redis.from_url(settings.redis_url, decode_responses=True)
    
    await redis_client.xadd(
        "stream:user_interests.sync.failed",
        {
            "user_id": str(user_id),
            "error": str(e),
            "error_type": type(e).__name__,
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "interests_count": str(len(interests) if 'interests' in locals() else 0)
        },
        maxlen=10000
    )
except Exception as dlq_error:
    logger.warning("Failed to send to DLQ", user_id=str(user_id), error=str(dlq_error))
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ failed —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ retry
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ DLQ

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç—Ä–µ–Ω–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

**–§–∞–π–ª**: `api/tasks/scheduler_tasks.py`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (—Ñ—É–Ω–∫—Ü–∏—è `send_trend_alerts_to_users`)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–∞–Ω–∞–ª—ã
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `TrendAlert`
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç—Ä–µ–Ω–¥–µ

**–î–µ—Ç–∞–ª–∏**:
```python
async def send_trend_alerts_to_users(trends: List, db: Session):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ç—Ä–µ–Ω–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ Telegram.
    
    Context7: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª—ã/—Ç–µ–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç—Ä–µ–Ω–¥–∞–º–∏,
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
    """
    # –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–∞–Ω–∞–ª—ã
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ TrendAlert
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
    # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ `detect_trends_task()` –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É `TrendAlert` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## üìã –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ vision_analysis_task.py

**–¢—Ä–µ–±—É–µ—Ç—Å—è**:
- –ü–æ–ª—É—á–µ–Ω–∏–µ `channel_username` –∏–∑ –ë–î (–≤–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `quota_exhausted` —á–µ—Ä–µ–∑ `budget_gate` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–¥–∏–∞ –≤ –æ–¥–Ω–æ–º –ø–æ—Å—Ç–µ

**–§–∞–π–ª**: `api/worker/tasks/vision_analysis_task.py`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN —Å —Ç–∞–±–ª–∏—Ü–µ–π `channels` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `channel_username`
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `budget_gate.is_quota_exhausted(tenant_id)` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ—Å—Ç–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º–µ–¥–∏–∞ (`grouped_id`)

### 2. Storage quota tracking

**–¢—Ä–µ–±—É–µ—Ç—Å—è**:
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è tenant usage tracking —á–µ—Ä–µ–∑ –ë–î
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è S3

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `tenant_storage_usage` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ `StorageQuotaService`
- –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è S3
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å `budget_gate` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–≤–æ—Ç

## üéØ –°—Ç–∞—Ç—É—Å

- ‚úÖ **–°—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏**: –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- ‚è≥ **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**: –¢—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìù Next Steps

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ vision_analysis_task.py**:
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ `channel_username` –∏–∑ –ë–î
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É quota —á–µ—Ä–µ–∑ `budget_gate`
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–¥–∏–∞

2. **Storage quota tracking**:
   - –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `tenant_storage_usage`
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É
   - –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å `budget_gate`

## ‚úÖ Context7 Best Practices

- ‚úÖ Fail-open –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `exc_info=True` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ DLQ –¥–ª—è failed –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ stream
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ë–î
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

