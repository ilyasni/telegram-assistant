# Активация всех неактивных подписок пользователей

**Дата**: 2025-11-27  
**Context7**: Активация подписок с исключением дубликатов каналов

---

## Контекст

В БД было обнаружено 87 неактивных подписок пользователей. Все подписки были проверены на наличие дубликатов каналов (по `username` или `tg_channel_id`), и все неактивные подписки активированы.

---

## Результаты

### До активации
- **Активных подписок**: 56
- **Неактивных подписок**: 87
- **Всего подписок**: 143

### После активации
- **Активных подписок**: 143 ✅
- **Неактивных подписок**: 0 ✅
- **Всего подписок**: 143
- **Обновлено подписок**: 87

---

## Логика активации

### Проверка дубликатов каналов

Подписки активировались только для каналов **без дубликатов**:

1. **Дубликат по username**: если существует другой канал с таким же `username`
2. **Дубликат по tg_channel_id**: если существует другой канал с таким же `tg_channel_id`

### SQL запрос

```sql
WITH channels_with_duplicates AS (
  SELECT DISTINCT c.id
  FROM channels c
  WHERE EXISTS (
    SELECT 1 FROM channels c2
    WHERE c2.id != c.id
      AND (
        (c.username IS NOT NULL AND c2.username = c.username)
        OR (c.tg_channel_id IS NOT NULL AND c2.tg_channel_id = c.tg_channel_id)
      )
  )
)
UPDATE user_channel uc
SET is_active = true
WHERE uc.is_active = false
  AND uc.channel_id NOT IN (SELECT id FROM channels_with_duplicates);
```

---

## Проверка дубликатов

### Результат проверки
- **Дубликатов каналов**: 0 ✅
- **Дубликатов подписок**: 0 ✅
- Все каналы уникальны по `username` и `tg_channel_id`

### Примеры активированных подписок
- `ai_newz` - 3 подписки (все активны)
- `b_goncharenko` - 3 подписки (все активны)
- `beer_for_all` - 1 подписка (активна)
- `business_ru` - 2 подписки (все активны)

---

## Context7 Best Practices

### ✅ Безопасность
- Исключены подписки на дубликаты каналов
- Защита от создания дубликатов подписок

### ✅ Идемпотентность
- Запрос можно выполнять многократно без побочных эффектов
- Учитывается только `is_active = false`

### ✅ Observability
- Подсчет обновленных записей
- Проверка результата после выполнения

---

## Checks

### Проверка результата

```sql
-- Проверка статистики подписок
SELECT 
    COUNT(*) FILTER (WHERE is_active = true) as active,
    COUNT(*) FILTER (WHERE is_active = false) as inactive,
    COUNT(*) as total
FROM user_channel;

-- Проверка дубликатов каналов
SELECT 
    c.username,
    c.tg_channel_id,
    COUNT(DISTINCT c.id) as channel_count
FROM channels c
GROUP BY c.username, c.tg_channel_id
HAVING COUNT(DISTINCT c.id) > 1;
```

### Ожидаемый результат
- `active`: 143
- `inactive`: 0
- `total`: 143
- Дубликатов каналов: 0

---

## Impact

### Положительные эффекты
- ✅ Все неактивные подписки активированы
- ✅ Посты начнут сохраняться для всех подписок
- ✅ Парсинг каналов будет работать для всех подписок

### Риски
- ⚠️ Нет рисков, так как дубликаты каналов исключены
- ⚠️ Все подписки проверены на уникальность

---

## Rollback

Если нужно откатить изменения:

```sql
-- Откат: деактивация всех подписок, которые были активированы
-- (требуется backup или логирование изменений)
UPDATE user_channel
SET is_active = false
WHERE channel_id IN (
  -- Список channel_id, которые были активированы
);
```

**Примечание**: Откат возможен только если есть backup или логи изменений.

---

## Рекомендации

1. **Мониторинг**: Следить за метрикой `db_subscription_check_failures_total{reason="subscription_inactive"}` - должна быть 0
2. **Парсинг**: Проверить, что парсинг каналов работает для всех активированных подписок
3. **Логи**: Проверить логи на наличие ошибок после активации





