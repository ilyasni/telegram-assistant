# Очистка истории Git от чувствительных данных

**Дата:** 2025-10-28  
**Статус:** ✅ Выполнено

## Проблема

В истории Git присутствовали коммиты с чувствительными данными:
- Реальные `GIGACHAT_CREDENTIALS` в `env.example`
- Access tokens в документации
- Credentials в тестовых файлах

## Выполненные действия

### 1. Идентификация проблемных коммитов

Проверка показала наличие чувствительных данных в:
- Коммит `243a37e` - содержал реальные credentials в `env.example`
- Коммит `a0e36b4` - уже был очищен перед очисткой истории

### 2. Очистка истории

Использован `git filter-branch` для переписывания всей истории:
- Все коммиты переписаны с заменой чувствительных данных на placeholders
- Хеши всех коммитов изменились (это нормально при переписывании истории)

**До очистки:**
```
243a37e chore: обновление конфигурации и документации проекта
```

**После очистки:**
```
e177cd3 chore: обновление конфигурации и документации проекта
```

### 3. Проверка результатов

```bash
# Проверка отсутствия чувствительных данных в истории
git log --all --full-history -S "N2MwNTA0NGMtZTM4Yy00YjRhLTliZjEtYTI5YzVmMWE4ZWMyOmRmM2Q3MWY1LTI2ZDItNDA2MS04NzVjLTIyYzNkM2YwMWRjMg=="
# Результат: только очищенные коммиты (с placeholders)
```

## Резервные копии

Созданы резервные ветки перед очисткой:
- `backup-before-cleanup-20251028_162753`
- `backup-before-cleanup-20251028_162812`
- `backup-before-history-cleanup-20251028_162752`

Эти ветки сохраняют оригинальную историю на случай необходимости восстановления.

## Применение изменений на GitHub

⚠️ **ВАЖНО**: Для применения очищенной истории на GitHub требуется force push:

```bash
# Force push основной ветки
git push origin --force main

# Force push всех веток (если есть другие)
git push origin --force --all

# Force push всех тегов (если есть)
git push origin --force --tags
```

### Предупреждения

1. **Force push перезаписывает историю на GitHub** - все кто клонировал репозиторий должны переклонировать или выполнить:
   ```bash
   git fetch origin
   git reset --hard origin/main
   ```

2. **Коммиты с чувствительными данными удалены из истории**, но:
   - Старые коммиты могли быть скопированы (fork'и, зеркала)
   - Для полной безопасности рекомендуется ротация всех credentials

3. **Локальные копии** других разработчиков будут не синхронизированы

## Ротация секретов

После очистки истории рекомендуется:

1. ✅ **GIGACHAT_CREDENTIALS** - уже пересозданы и сохранены локально
2. Проверить другие секреты:
   - `JWT_SECRET`
   - `POSTGRES_PASSWORD`
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_API_HASH`

## Восстановление (если необходимо)

Если что-то пошло не так, можно восстановиться из резервной ветки:

```bash
# Просмотр резервных веток
git branch | grep backup

# Восстановление из резервной копии
git checkout backup-before-cleanup-20251028_162812
git branch -f main backup-before-cleanup-20251028_162812
git checkout main
```

## Проверка безопасности

Команды для проверки:

```bash
# Поиск чувствительных данных в истории
git log --all --full-history -S "your_real_credential_here"

# Проверка конкретного файла в истории
git log --all --full-history -- env.example

# Поиск по паттерну
git log --all --full-history -p | grep -i "password\|secret\|token\|key"
```

## Заметки

- Скрипт очистки сохранён: `scripts/clean_git_history.sh`
- Вся история переписана, хеши коммитов изменились
- Резервные ветки содержат оригинальную историю
- После force push на GitHub старые коммиты будут недоступны через обычные команды, но могут оставаться в архивах GitHub

