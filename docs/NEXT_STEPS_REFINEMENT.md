# –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:**
   - –ü–æ–ª—è –º–µ—Ç—Ä–∏–∫ –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `trend_clusters`
   - –ü–æ–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
   - –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã

2. **–ú–æ–¥—É–ª–∏ —Å–æ–∑–¥–∞–Ω—ã:**
   - `trends_coherence_metrics.py` - –º–µ—Ç—Ä–∏–∫–∏ –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
   - `trends_keyword_extractor.py` - c-TF-IDF –¥–ª—è keywords
   - `trends_split_agent.py` - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - `trends_merge_agent.py` - —Å–ª–∏—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - `trends_refinement_service.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
   - `trends_refinement_task.py` - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:**
   - Refinement task –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `run_all_tasks.py`
   - API –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–µ—Ä–∞—Ä—Ö–∏–∏
   - Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã

## üöÄ –®–∞–≥–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å hdbscan (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
docker compose exec worker pip install hdbscan>=0.8.33

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
docker compose exec worker pip list | grep -E "hdbscan|scikit-learn"
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ worker

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker:

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker compose restart worker

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞
docker compose logs -f worker | grep -E "refinement|split|merge|coherence"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ refinement task –∑–∞–ø—É—â–µ–Ω
docker compose logs worker | grep -i "trend_refinement.*started"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus
curl http://localhost:8001/metrics | grep trend_refinement

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î
docker compose exec supabase-db psql -U postgres -d postgres -c "\d trend_clusters" | grep -E "coherence|parent|level"
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ `/metrics` endpoint worker'–∞ (–æ–±—ã—á–Ω–æ –ø–æ—Ä—Ç 8001):

- `trend_refinement_runs_total{status="success|error"}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤
- `trend_refinement_clusters_split_total` - —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã
- `trend_refinement_clusters_merged_total` - —Å–ª–∏—Ç—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã
- `trend_refinement_duration_seconds` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç–∞

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∏–ª–∏ –º—è–≥–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –í .env –∏–ª–∏ docker-compose.yml
TREND_REFINEMENT_INTERVAL_HOURS=3  # –ß–∞—â–µ –∑–∞–ø—É—Å–∫
TREND_MIN_COHERENCE_FOR_SPLIT=0.4  # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä–æ–≥
TREND_MERGE_MIN_KEYWORD_OVERLAP=0.6  # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–µ —Å–ª–∏—è–Ω–∏–µ
```

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

1. **–†–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `TREND_REFINEMENT_INTERVAL_HOURS`)

2. **–ü–∞–π–ø–ª–∞–π–Ω —Ä–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç–∞:**
   - –û—Ü–µ–Ω–∫–∞ –º–µ—Ç—Ä–∏–∫ –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å –Ω–∏–∑–∫–æ–π –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é (< 0.3)
   - –°–ª–∏—è–Ω–∏–µ –ø–æ—Ö–æ–∂–∏—Ö/–º–µ–ª–∫–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (keyword overlap > 0.5)
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–µ–º –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (>10 –ø–æ—Å—Ç–æ–≤)

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:**
   - `coherence_score` - –æ–±—â–∞—è –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
   - `silhouette_score` - —Ä–∞–∑–¥–µ–ª–∏–º–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - `npmi_score` - Topic Coherence
   - `intra_cluster_similarity` - —Å—Ä–µ–¥–Ω—è—è –±–ª–∏–∑–æ—Å—Ç—å –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
   - `last_refinement_at` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç–∞

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ —Ä–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
docker compose logs worker | grep -i refinement
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ task –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:
```bash
docker compose logs worker | grep -i "trend_refinement.*registered"
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
docker compose exec worker env | grep TREND_REFINEMENT
```

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏:

1. **–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ worker

2. **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î –∏–∑ worker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

3. **–û—à–∏–±–∫–∞ LLM-–≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GigaChat API
   - –ú–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å: `TREND_SPLIT_LLM_VALIDATION=false`

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: `docs/TREND_REFINEMENT_CONFIG.md`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º: `docs/TREND_DETECTION_ALGORITHM.md`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–†–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å—Ç–æ–≤
2. **LLM-–≤–∞–ª–∏–¥–∞—Ü–∏—è** —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GigaChat API
3. **HDBSCAN** –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è sub-clustering (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å K-Means)
4. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–Ω–æ–≥–æ
5. –†–µ—Ñ–∞–π–Ω–º–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 50 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞ –∑–∞–ø—É—Å–∫ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

