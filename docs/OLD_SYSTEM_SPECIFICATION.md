# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞
https://github.com/ilyasni/t-bot-for-channels/tree/test-cleanup-fresh

# Telegram Channel Parser Bot - –°–∏—Å—Ç–µ–º–Ω–∞—è –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

> **–í–µ—Ä—Å–∏—è:** 3.1  
> **–î–∞—Ç–∞:** 12 –æ–∫—Ç—è–±—Ä—è 2025  
> **–ü—Ä–æ–µ–∫—Ç:** n8n-server / Telegram Channel Parser + RAG System + QR Login + Admin Panel

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#1-–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
4. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#4-–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
5. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#5-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
6. [Deployment](#6-deployment)
7. [–ü–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#7-–ø–∞–π–ø–ª–∞–π–Ω-—Ä–∞–±–æ—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
8. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ Observability](#8-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-observability)

---

## 1. –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

### 1.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ü–µ–ª–∏

**Telegram Channel Parser Bot** - —ç—Ç–æ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ RAG (Retrieval-Augmented Generation).

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:**
- ü§ñ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- üîç **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫** - RAG-—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
- üë• **–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º** - –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - QR-–ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ Telegram Mini App (–±–µ–∑ SMS)
- üíé **–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫** - —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
- üëë **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ Telegram Mini App

### 1.2 –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Mini App
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- **RAG-–ø–æ–∏—Å–∫** - `/ask <–≤–æ–ø—Ä–æ—Å>` –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –ø–æ—Å—Ç–∞—Ö
- **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫** - `/search <–∑–∞–ø—Ä–æ—Å>` (–ø–æ—Å—Ç—ã + –≤–µ–± —á–µ—Ä–µ–∑ Searxng)
- **AI-–¥–∞–π–¥–∂–µ—Å—Ç—ã** - –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–æ–¥–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** - `/recommend` –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

#### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **Admin Panel** - –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è SPA —á–µ—Ä–µ–∑ Telegram Mini App
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏** - —Ä–æ–ª–∏, –ø–æ–¥–ø–∏—Å–∫–∏, –ª–∏–º–∏—Ç—ã
- **Invite codes** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –ø–æ–¥–ø–∏—Å–æ–∫
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **Event-Driven Architecture** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- **Vector Search** - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Qdrant
- **AI Integration** - GigaChat, OpenRouter, Ollama
- **Webhook Integration** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ n8n/Flowise

### 1.3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

#### Backend
- **Python 3.11+** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **FastAPI** - REST API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8010)
- **Telethon** - Telegram API –∫–ª–∏–µ–Ω—Ç
- **python-telegram-bot** - Telegram Bot API
- **SQLAlchemy 2.0** - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- **PostgreSQL** - –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase)

#### RAG System
- **Qdrant** - –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Ä—Ç 6333)
- **Redis/Valkey** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–µ—Å—Å–∏–∏ (–ø–æ—Ä—Ç 6379)
- **GigaChat** - embeddings –∏ LLM (—á–µ—Ä–µ–∑ gpt2giga-proxy)
- **OpenRouter** - fallback LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä

#### Frontend
- **Telegram Mini Apps** - SPA –¥–ª—è QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- **Tailwind CSS** - —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
- **JavaScript ES6+** - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞

#### Infrastructure
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- **Caddy** - reverse proxy —Å HTTPS
- **Prometheus** - –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **Grafana** - –¥–∞—à–±–æ—Ä–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1.4 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

#### –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram Bot  ‚îÇ    ‚îÇ   FastAPI API   ‚îÇ    ‚îÇ   RAG Service   ‚îÇ
‚îÇ   (bot.py)      ‚îÇ    ‚îÇ   (main.py)     ‚îÇ    ‚îÇ   (rag_service) ‚îÇ
‚îÇ   Port: -       ‚îÇ    ‚îÇ   Port: 8010    ‚îÇ    ‚îÇ   Port: 8020    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   PostgreSQL    ‚îÇ
                    ‚îÇ   (Supabase)    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Event-Driven Processing
- **–ü–∞—Ä—Å–∏–Ω–≥** ‚Üí **–¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è** ‚Üí **RAG Ready**
- **Webhooks** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å n8n/Flowise
- **Background Tasks** –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### Security First
- **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (crypto_utils)
- **–ò–∑–æ–ª—è—Ü–∏—è** –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **Rate Limiting** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- **Session Management** —á–µ—Ä–µ–∑ Redis

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 2.1 –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "User Layer"
        U1[üë§ User 1]
        U2[üë§ User 2]
        U3[üëë Admin]
    end
    
    subgraph "Telegram Layer"
        TG[üì± Telegram]
        MA[Mini Apps]
    end
    
    subgraph "Bot Layer"
        BOT[ü§ñ Telegram Bot]
        AUTH[üîê QR Auth Manager]
        ADMIN[üëë Admin Panel Manager]
    end
    
    subgraph "API Layer"
        API[üåê FastAPI Server<br/>Port: 8010]
        RAG[üß† RAG Service<br/>Port: 8020]
        AUTH_WEB[üîë Auth Web Server<br/>Port: 8001]
    end
    
    subgraph "Processing Layer"
        PARSER[üì• Parser Service]
        TAG[üè∑Ô∏è Tagging Service]
        CLEANUP[üßπ Cleanup Service]
    end
    
    subgraph "Storage Layer"
        DB[(üóÑÔ∏è PostgreSQL<br/>Supabase)]
        REDIS[(‚ö° Redis/Valkey)]
        QDRANT[(üîç Qdrant<br/>Vector DB)]
    end
    
    subgraph "External Services"
        GIGA[ü§ñ GigaChat<br/>gpt2giga-proxy]
        OPENAI[üß† OpenRouter]
        SEARX[üîç Searxng]
        CRAWL[üï∑Ô∏è Crawl4AI]
        N8N[‚ö° n8n/Flowise]
    end
    
    %% User interactions
    U1 --> TG
    U2 --> TG
    U3 --> TG
    TG --> BOT
    TG --> MA
    
    %% Bot to API
    BOT --> API
    AUTH --> API
    ADMIN --> API
    
    %% API to Processing
    API --> PARSER
    API --> TAG
    API --> CLEANUP
    API --> RAG
    
    %% Processing to Storage
    PARSER --> DB
    TAG --> DB
    CLEANUP --> DB
    RAG --> QDRANT
    RAG --> REDIS
    
    %% API to Storage
    API --> DB
    AUTH --> REDIS
    ADMIN --> REDIS
    
    %% External integrations
    TAG --> GIGA
    TAG --> OPENAI
    RAG --> GIGA
    RAG --> OPENAI
    RAG --> SEARX
    RAG --> CRAWL
    API --> N8N
    
    %% Styling
    classDef userClass fill:#e1f5fe
    classDef telegramClass fill:#f3e5f5
    classDef botClass fill:#e8f5e8
    classDef apiClass fill:#fff3e0
    classDef processClass fill:#fce4ec
    classDef storageClass fill:#f1f8e9
    classDef externalClass fill:#fff8e1
    
    class U1,U2,U3 userClass
    class TG,MA telegramClass
    class BOT,AUTH,ADMIN botClass
    class API,RAG,AUTH_WEB apiClass
    class PARSER,TAG,CLEANUP processClass
    class DB,REDIS,QDRANT storageClass
    class GIGA,OPENAI,SEARX,CRAWL,N8N externalClass
```

### 2.2 Event-Driven Architecture

```mermaid
graph LR
    subgraph "Event Sources"
        TG_EVENT[üì± Telegram Event]
        SCHEDULER[‚è∞ Scheduler]
        USER_ACTION[üë§ User Action]
    end
    
    subgraph "Event Processing"
        EVENT_HANDLER[üéØ Event Handler]
        BACKGROUND[‚ö° Background Tasks]
        WEBHOOK[üîó Webhook]
    end
    
    subgraph "Event Sinks"
        DB_UPDATE[üóÑÔ∏è Database Update]
        CACHE_UPDATE[‚ö° Cache Update]
        VECTOR_UPDATE[üîç Vector Update]
        EXTERNAL[üåê External Service]
    end
    
    TG_EVENT --> EVENT_HANDLER
    SCHEDULER --> EVENT_HANDLER
    USER_ACTION --> EVENT_HANDLER
    
    EVENT_HANDLER --> BACKGROUND
    EVENT_HANDLER --> WEBHOOK
    
    BACKGROUND --> DB_UPDATE
    BACKGROUND --> CACHE_UPDATE
    BACKGROUND --> VECTOR_UPDATE
    WEBHOOK --> EXTERNAL
    
    %% Event flow examples
    TG_EVENT -.->|"New Message"| EVENT_HANDLER
    SCHEDULER -.->|"Every 30min"| EVENT_HANDLER
    USER_ACTION -.->|"/ask question"| EVENT_HANDLER
    
    EVENT_HANDLER -.->|"Parse Channel"| BACKGROUND
    EVENT_HANDLER -.->|"Generate Tags"| BACKGROUND
    EVENT_HANDLER -.->|"Index Post"| BACKGROUND
    EVENT_HANDLER -.->|"Send to n8n"| WEBHOOK
```

### 2.3 Data Flow

```mermaid
sequenceDiagram
    participant U as üë§ User
    participant B as ü§ñ Bot
    participant A as üåê API
    participant P as üì• Parser
    participant T as üè∑Ô∏è Tagging
    participant R as üß† RAG
    participant Q as üîç Qdrant
    participant D as üóÑÔ∏è Database
    
    Note over U,D: User Registration & Channel Setup
    U->>B: /start
    B->>U: Request invite code
    U->>B: /login INVITE_CODE
    B->>A: Create QR session
    A->>D: Save user + auth
    B->>U: QR Mini App
    U->>B: Scan QR ‚Üí Authorized
    B->>U: ‚úÖ Welcome!
    
    U->>B: /add_channel @channel_name
    B->>A: Add channel
    A->>D: Save channel
    A->>P: Trigger first parse
    P->>D: Get messages
    P->>D: Save posts
    P->>T: Tag new posts
    T->>R: Index posts
    R->>Q: Store vectors
    B->>U: ‚úÖ Channel added
    
    Note over U,D: RAG Query Flow
    U->>B: /ask What's new in AI?
    B->>A: POST /rag/query
    A->>R: Process query
    R->>Q: Vector search
    Q->>R: Top results
    R->>A: Generate answer
    A->>B: Answer + sources
    B->>U: üìù Response
```

---

## 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 3.1 Telegram Bot Service

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–æ—Ç–∞

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `TelegramBot` - –≥–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –±–æ—Ç–∞
- `ConversationHandler` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `CommandHandler` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
- `CallbackQueryHandler` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ inline –∫–Ω–æ–ø–æ–∫

```python
class TelegramBot:
    def __init__(self):
        # Persistence –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
        persistence = PicklePersistence(filepath='data/bot_persistence.pkl')
        
        self.application = (
            Application.builder()
            .token(BOT_TOKEN)
            .persistence(persistence)
            .build()
        )
        self.setup_handlers()
```

#### –ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
|---------|----------|-------------|
| `/start` | –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã | –¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `/login INVITE_CODE` | QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | –¢—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π invite code |
| `/add_channel` | –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ |
| `/my_channels` | –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∫–∞–Ω–∞–ª—ã |
| `/remove_channel` | –£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ |
| `/ask <–≤–æ–ø—Ä–æ—Å>` | RAG-–ø–æ–∏—Å–∫ | –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ |
| `/search <–∑–∞–ø—Ä–æ—Å>` | –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ | –ü–æ—Å—Ç—ã + –≤–µ–± —á–µ—Ä–µ–∑ Searxng |
| `/recommend` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `/digest` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ | –¢–æ–ª—å–∫–æ –¥–ª—è premium+ |
| `/subscription` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ |

#### –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –î–æ—Å—Ç—É–ø |
|---------|----------|--------|
| `/admin` | –û—Ç–∫—Ä—ã—Ç—å Admin Panel | –¢–æ–ª—å–∫–æ role="admin" |
| `/admin_invite` | –°–æ–∑–¥–∞—Ç—å invite code | –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã |
| `/admin_users` | –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã |
| `/admin_stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã | –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã |

#### QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Mini App

**–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/login INVITE_CODE`
2. –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç QR —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ `QRAuthManager`
3. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É —Å `WebAppInfo`
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∫–æ–¥ –≤ Telegram
6. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç callback –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

```python
# –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è QR —Å–µ—Å—Å–∏–∏
async def create_qr_session(self, telegram_id: int, invite_code: str):
    # –°–æ–∑–¥–∞–µ–º Telethon –∫–ª–∏–µ–Ω—Ç
    client = await shared_auth_manager._create_client(telegram_id)
    await client.connect()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR login
    qr_login = await client.qr_login()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis —Å TTL 10 –º–∏–Ω—É—Ç
    session_data = {
        "telegram_id": telegram_id,
        "invite_code": invite_code,
        "qr_login": qr_login,
        "created_at": datetime.now(timezone.utc).isoformat()
    }
    
    self.redis_client.setex(
        f"qr_session:{session_id}",
        600,  # 10 –º–∏–Ω—É—Ç
        json.dumps(session_data)
    )
```

### 3.2 FastAPI Server (main.py)

#### REST API Endpoints

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- `GET /users/{user_id}/auth_status` - —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `POST /users/{user_id}/logout` - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
- `GET /qr-auth` - QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Mini App)
- `GET /qr-auth-status` - —Å—Ç–∞—Ç—É—Å QR —Å–µ—Å—Å–∏–∏

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏:**
- `GET /users/{user_id}/channels` - —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /users/{user_id}/channels` - –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª
- `DELETE /users/{user_id}/channels/{channel_id}` - —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª
- `GET /users/{user_id}/channels/{channel_id}/posts` - –ø–æ—Å—Ç—ã –∫–∞–Ω–∞–ª–∞

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏:**
- `GET /users/{user_id}/posts` - –≤—Å–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /posts/{post_id}` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Å—Ç
- `POST /posts/{post_id}/tags` - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥–∏
- `DELETE /users/{user_id}/posts/cleanup` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ—Å—Ç–æ–≤

**–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:**
- `GET /admin-panel` - SPA –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- `GET /api/admin/users` - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `POST /api/admin/user/{id}/role` - –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
- `POST /api/admin/user/{id}/subscription` - –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
- `POST /api/admin/invite/create` - —Å–æ–∑–¥–∞—Ç—å invite code

#### Request/Response —Å—Ö–µ–º—ã

```python
# –ü—Ä–∏–º–µ—Ä Pydantic –º–æ–¥–µ–ª–∏
class ChannelCreate(BaseModel):
    channel_username: str = Field(..., min_length=1, max_length=50)
    description: Optional[str] = Field(None, max_length=500)

class ChannelResponse(BaseModel):
    id: int
    channel_username: str
    channel_title: str
    is_active: bool
    posts_count: int
    last_parsed_at: Optional[datetime]
    created_at: datetime
```

#### OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- Swagger UI: `http://localhost:8010/docs`
- ReDoc: `http://localhost:8010/redoc`
- OpenAPI JSON: `http://localhost:8010/openapi.json`

### 3.3 Parser Service

#### –ê–ª–≥–æ—Ä–∏—Ç–º –ø–∞—Ä—Å–∏–Ω–≥–∞

**–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –µ–≥–æ Telethon –∫–ª–∏–µ–Ω—Ç–∞
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
   - –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤
   - –ó–∞–ø—É—Å–∫ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ–Ω–µ

```python
async def parse_user_channels(self, user: User, db: SessionLocal) -> int:
    """–ü–∞—Ä—Å–∏—Ç—å –∫–∞–Ω–∞–ª—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    client = await shared_auth_manager.get_user_client(user.telegram_id)
    
    if not client or not client.is_connected():
        return 0
    
    channels = user.get_active_channels(db)
    total_posts = 0
    
    for channel in channels:
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = await client.get_messages(
                channel.channel_username,
                limit=MAX_POSTS_PER_CHANNEL
            )
            
            new_posts = await self._process_messages(messages, channel, user, db)
            total_posts += new_posts
            
        except FloodWaitError as e:
            logger.warning(f"FloodWait: {e.seconds} —Å–µ–∫—É–Ω–¥")
            await asyncio.sleep(e.seconds)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞ {channel.channel_username}: {e}")
    
    return total_posts
```

#### Multi-user support

**–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∫–∞–Ω–∞–ª—ã
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `user_id` –≤–æ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –û—Ç–¥–µ–ª—å–Ω—ã–µ Telethon –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### Rate limiting –∏ FloodWait handling

```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ FloodWaitError
try:
    messages = await client.get_messages(channel, limit=50)
except FloodWaitError as e:
    logger.warning(f"FloodWait: –æ–∂–∏–¥–∞–Ω–∏–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    await asyncio.sleep(e.seconds)
    # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
    messages = await client.get_messages(channel, limit=50)
```

#### Batch processing

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- Bulk insert –¥–ª—è –ø–æ—Å—Ç–æ–≤ (–¥–æ 100 –∑–∞ —Ä–∞–∑)
- Batch —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–æ 10 –ø–æ—Å—Ç–æ–≤)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤

### 3.4 RAG Service (–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å)

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ RAG

```mermaid
graph TB
    subgraph "Input Layer"
        QUERY[üë§ User Query]
        POST[üìù New Post]
    end
    
    subgraph "Processing Layer"
        EMB[üß† Embeddings<br/>GigaChat]
        SEARCH[üîç Vector Search<br/>Qdrant]
        GEN[ü§ñ Answer Generation<br/>OpenRouter]
    end
    
    subgraph "Storage Layer"
        CACHE[(‚ö° Redis Cache)]
        VECTOR[(üîç Qdrant Vectors)]
        DB[(üóÑÔ∏è PostgreSQL)]
    end
    
    subgraph "Output Layer"
        ANSWER[üìù Generated Answer]
        SOURCES[üìö Source Links]
    end
    
    QUERY --> EMB
    POST --> EMB
    EMB --> CACHE
    EMB --> SEARCH
    SEARCH --> VECTOR
    SEARCH --> GEN
    GEN --> ANSWER
    GEN --> SOURCES
    
    %% Cache flow
    QUERY -.->|"Check cache"| CACHE
    CACHE -.->|"Cache hit"| ANSWER
    CACHE -.->|"Cache miss"| EMB
    
    %% Styling
    classDef inputClass fill:#e3f2fd
    classDef processClass fill:#f3e5f5
    classDef storageClass fill:#e8f5e8
    classDef outputClass fill:#fff3e0
    
    class QUERY,POST inputClass
    class EMB,SEARCH,GEN processClass
    class CACHE,VECTOR,DB storageClass
    class ANSWER,SOURCES outputClass
```

#### API Endpoints

**–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è:**
- `POST /rag/index/post/{post_id}` - –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç
- `POST /rag/index/batch` - batch –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- `GET /rag/index/status/{user_id}` - —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–ü–æ–∏—Å–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:**
- `POST /rag/query` - RAG-–∑–∞–ø—Ä–æ—Å
- `POST /rag/search` - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- `GET /rag/recommend/{user_id}` - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–î–∞–π–¥–∂–µ—Å—Ç—ã:**
- `POST /rag/digest/settings/{user_id}` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
- `POST /rag/digest/generate/{user_id}` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞

#### –ê–ª–≥–æ—Ä–∏—Ç–º—ã

**Hybrid Search:**
```python
async def hybrid_search(user_id: int, query: str, top_k: int = 10):
    # 1. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    query_embedding = await embeddings_service.generate(query)
    vector_results = await qdrant_search(user_id, query_embedding, top_k)
    
    # 2. Keyword search (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    keyword_results = await keyword_search(user_id, query)
    
    # 3. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ re-ranking
    combined_results = merge_and_rerank(vector_results, keyword_results)
    
    return combined_results[:top_k]
```

**Context Assembly:**
```python
def assemble_context(posts: List[Post], max_tokens: int = 4000) -> str:
    """–°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤"""
    context_parts = []
    current_tokens = 0
    
    for post in posts:
        post_text = f"[{post.channel.channel_username}] {post.text}"
        post_tokens = count_tokens(post_text)
        
        if current_tokens + post_tokens > max_tokens:
            break
            
        context_parts.append(post_text)
        current_tokens += post_tokens
    
    return "\n\n".join(context_parts)
```

### 3.5 Auth System

#### QR Login —á–µ—Ä–µ–∑ Mini App

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `QRAuthManager` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ QR —Å–µ—Å—Å–∏—è–º–∏
- `SharedAuthManager` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telethon –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- Redis –¥–ª—è shared state –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- TTL –¥–ª—è QR —Å–µ—Å—Å–∏–π: 10 –º–∏–Ω—É—Ç
- –ü—Ä–æ–≤–µ—Ä–∫–∞ ownership –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### Shared Auth Manager

```python
class SharedAuthManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telethon –∫–ª–∏–µ–Ω—Ç–∞–º–∏ —Å master credentials"""
    
    def __init__(self):
        self.master_api_id = os.getenv("MASTER_API_ID")
        self.master_api_hash = os.getenv("MASTER_API_HASH")
        self.active_clients: Dict[int, TelegramClient] = {}
    
    async def get_user_client(self, telegram_id: int) -> Optional[TelegramClient]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if telegram_id in self.active_clients:
            return self.active_clients[telegram_id]
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å master credentials
        client = await self._create_client(telegram_id)
        await client.connect()
        
        if client.is_connected():
            self.active_clients[telegram_id] = client
            return client
        
        return None
```

#### Session Management (Redis)

**QR Sessions:**
```python
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ QR —Å–µ—Å—Å–∏–∏
session_data = {
    "telegram_id": telegram_id,
    "invite_code": invite_code,
    "qr_login": qr_login,
    "created_at": datetime.now(timezone.utc).isoformat()
}

redis_client.setex(
    f"qr_session:{session_id}",
    600,  # 10 –º–∏–Ω—É—Ç
    json.dumps(session_data)
)
```

**Admin Sessions:**
```python
# –ê–¥–º–∏–Ω —Å–µ—Å—Å–∏–∏ —Å TTL 1 —á–∞—Å
admin_data = {
    "admin_id": admin_id,
    "role": "admin",
    "created_at": datetime.now(timezone.utc).isoformat()
}

redis_client.setex(
    f"admin_session:{token}",
    3600,  # 1 —á–∞—Å
    json.dumps(admin_data)
)
```

### 3.6 Subscription & Roles System

#### –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

```python
SUBSCRIPTION_TIERS = {
    "free": {
        "max_channels": 3,
        "max_posts_per_day": 100,
        "rag_queries_per_day": 10,
        "ai_digest": False,
        "price_rub": 0
    },
    "trial": {
        "max_channels": 10,
        "duration_days": 7,
        "price_rub": 0
    },
    "basic": {
        "max_channels": 10,
        "max_posts_per_day": 500,
        "rag_queries_per_day": 50,
        "ai_digest": True,
        "price_rub": 500
    },
    "premium": {
        "max_channels": 50,
        "max_posts_per_day": 2000,
        "rag_queries_per_day": 200,
        "ai_digest": True,
        "price_rub": 1500
    },
    "enterprise": {
        "max_channels": 999,
        "max_posts_per_day": 99999,
        "rag_queries_per_day": 999,
        "ai_digest": True,
        "price_rub": 5000
    }
}
```

#### Invite Codes

```python
class InviteCode(Base):
    __tablename__ = "invite_codes"
    
    code = Column(String, primary_key=True)
    created_by = Column(Integer, ForeignKey("users.id"))
    expires_at = Column(DateTime, nullable=False)
    max_uses = Column(Integer, default=1)
    uses_count = Column(Integer, default=0)
    default_subscription = Column(String, default="free")
    default_trial_days = Column(Integer, default=0)
    
    @staticmethod
    def generate_code() -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 12-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥: ABC123XYZ456"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
```

#### Limits Enforcement

```python
async def check_subscription_limits(user: User, action: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏"""
    tier = get_subscription_info(user.subscription_type)
    
    if action == "add_channel":
        if len(user.channels) >= tier["max_channels"]:
            return False
    
    elif action == "rag_query":
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å
        today_queries = get_today_rag_queries(user.id)
        if today_queries >= tier["rag_queries_per_day"]:
            return False
    
    return True
```

### 3.7 Tagging Service

#### AI-—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- **GigaChat** (–æ—Å–Ω–æ–≤–Ω–æ–π) - —á–µ—Ä–µ–∑ gpt2giga-proxy
- **OpenRouter** (fallback) - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏

**Batch Processing:**
```python
async def process_posts_batch(post_ids: List[int]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–∞ –ø–æ—Å—Ç–æ–≤"""
    posts = db.query(Post).filter(Post.id.in_(post_ids)).all()
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏
    texts = [post.text for post in posts]
    
    try:
        # –ü—Ä–æ–±—É–µ–º GigaChat
        tags = await gigachat_tagging.batch_generate_tags(texts)
    except Exception as e:
        logger.warning(f"GigaChat failed: {e}, trying OpenRouter")
        # Fallback –Ω–∞ OpenRouter
        tags = await openrouter_tagging.batch_generate_tags(texts)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥–∏
    for post, post_tags in zip(posts, tags):
        post.tags = post_tags
        db.commit()
```

#### Retry Mechanism

```python
async def generate_tags_with_retry(text: str, max_retries: int = 3) -> List[str]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    for attempt in range(max_retries):
        try:
            return await ai_provider.generate_tags(text)
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            
            delay = 2 ** attempt  # Exponential backoff
            logger.warning(f"Attempt {attempt + 1} failed: {e}, retrying in {delay}s")
            await asyncio.sleep(delay)
```

### 3.8 Cleanup Service

#### Retention Policies

```python
async def cleanup_old_posts():
    """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ—Å—Ç–æ–≤ –ø–æ retention –ø–æ–ª–∏—Ç–∏–∫–∞–º"""
    db = SessionLocal()
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        users = db.query(User).all()
        
        for user in users:
            retention_days = user.retention_days or DEFAULT_RETENTION_DAYS
            cutoff_date = datetime.now(timezone.utc) - timedelta(days=retention_days)
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ—Å—Ç—ã
            old_posts = db.query(Post).filter(
                Post.user_id == user.id,
                Post.posted_at < cutoff_date
            ).all()
            
            for post in old_posts:
                # –£–¥–∞–ª—è–µ–º –∏–∑ Qdrant
                await rag_service.delete_post_from_index(post.id)
                # –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
                db.delete(post)
            
            db.commit()
            logger.info(f"Cleaned {len(old_posts)} posts for user {user.telegram_id}")
    
    finally:
        db.close()
```

#### Scheduled Cleanup

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
CLEANUP_SCHEDULE_TIME = os.getenv("CLEANUP_SCHEDULE_TIME", "03:00")

def schedule_cleanup():
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—á–∏—Å—Ç–∫–∏"""
    schedule.every().day.at(CLEANUP_SCHEDULE_TIME).do(cleanup_old_posts)
    
    while True:
        schedule.run_pending()
        time.sleep(60)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

---

## 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### 4.1 –°—Ö–µ–º–∞ –ë–î

```mermaid
erDiagram
    User ||--o{ Post : "creates"
    User ||--o{ Channel : "subscribes"
    User ||--o{ InviteCode : "creates"
    User ||--o{ SubscriptionHistory : "has"
    User ||--o{ DigestSettings : "configures"
    User ||--o{ RAGQueryHistory : "makes"
    User ||--o{ IndexingStatus : "tracks"
    
    Channel ||--o{ Post : "contains"
    Channel }o--o{ User : "subscribed_by"
    
    Post ||--o{ IndexingStatus : "indexed"
    
    User {
        int id PK
        bigint telegram_id UK
        string username
        string first_name
        string last_name
        datetime created_at
        boolean is_active
        int retention_days
        string api_id "encrypted"
        text api_hash "encrypted"
        text phone_number "encrypted"
        string session_file
        boolean is_authenticated
        datetime last_auth_check
        text auth_error
        string auth_session_id
        datetime auth_session_expires
        int failed_auth_attempts
        datetime last_auth_attempt
        boolean is_blocked
        datetime block_expires
        string role "admin/user"
        string subscription_type
        datetime subscription_expires
        datetime subscription_started_at
        int max_channels
        int invited_by FK
    }
    
    Channel {
        int id PK
        string channel_username UK
        string channel_title
        bigint channel_id
        boolean is_active
        datetime created_at
        datetime last_parsed_at
        int posts_count
        text description
    }
    
    Post {
        int id PK
        int user_id FK
        int channel_id FK
        bigint post_id
        text text
        text enriched_content
        string url
        datetime posted_at
        datetime created_at
        text tags "JSON array"
        boolean is_parsed
        text media_type
        text media_url
    }
    
    InviteCode {
        string code PK
        int created_by FK
        datetime expires_at
        int max_uses
        int uses_count
        string default_subscription
        int default_trial_days
        datetime created_at
    }
    
    SubscriptionHistory {
        int id PK
        int user_id FK
        string action
        string old_type
        string new_type
        int changed_by FK
        datetime changed_at
        text notes
    }
    
    DigestSettings {
        int id PK
        int user_id FK
        boolean enabled
        string frequency
        string time
        string days_of_week
        text channels "JSON array"
        text tags "JSON array"
        string format
        int max_posts
        string delivery_method
        boolean ai_summarize
        text preferred_topics "JSON array"
        string summary_style
        string timezone
    }
    
    RAGQueryHistory {
        int id PK
        int user_id FK
        text query
        datetime created_at
        text extracted_topics "JSON array"
    }
    
    IndexingStatus {
        int id PK
        int user_id FK
        int post_id FK
        string vector_id
        string status
        text error
        datetime created_at
        datetime updated_at
    }
```

### 4.2 PostgreSQL (Supabase)

#### Connection Pooling

```python
# database.py
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

def get_database_url() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¢–û–õ–¨–ö–û PostgreSQL)"""
    database_url = os.getenv("TELEGRAM_DATABASE_URL")
    
    if not database_url:
        raise ValueError("TELEGRAM_DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    
    if "sqlite" in database_url.lower():
        raise ValueError("SQLite –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostgreSQL.")
    
    return database_url

# Connection pooling –¥–ª—è production
engine = create_engine(
    get_database_url(),
    pool_size=20,           # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ
    max_overflow=10,        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ
    pool_pre_ping=True,     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    pool_recycle=3600,      # –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3600 —Å–µ–∫—É–Ω–¥
    echo=False              # –û—Ç–∫–ª—é—á–∏—Ç—å SQL –ª–æ–≥–∏ –≤ production
)
```

#### Timezone Handling

```python
from datetime import datetime, timezone
from zoneinfo import ZoneInfo

# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º UTC –≤ –ë–î
def to_utc(dt: datetime) -> datetime:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å datetime –≤ UTC"""
    if dt.tzinfo is None:
        return dt.replace(tzinfo=timezone.utc)
    return dt.astimezone(timezone.utc)

# –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
LOCAL_TZ = ZoneInfo('Europe/Moscow')

def to_local_time(dt: datetime) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å UTC –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"""
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    
    local_dt = dt.astimezone(LOCAL_TZ)
    return local_dt.isoformat()
```

#### Performance Tuning

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
CREATE INDEX IF NOT EXISTS idx_posts_user_id ON posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_channel_id ON posts(channel_id);
CREATE INDEX IF NOT EXISTS idx_posts_posted_at ON posts(posted_at);
CREATE INDEX IF NOT EXISTS idx_posts_user_posted ON posts(user_id, posted_at);
CREATE INDEX IF NOT EXISTS idx_channels_username ON channels(channel_username);
CREATE INDEX IF NOT EXISTS idx_invite_codes_expires ON invite_codes(expires_at);
CREATE INDEX IF NOT EXISTS idx_subscription_history_user ON subscription_history(user_id);
```

**Query Optimization:**
```python
# –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
def get_user_posts_optimized(user_id: int, limit: int = 50):
    """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return db.query(Post)\
        .filter(Post.user_id == user_id)\
        .order_by(Post.posted_at.desc())\
        .limit(limit)\
        .all()

# Bulk operations
def bulk_insert_posts(posts_data: List[Dict]):
    """–ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –ø–æ—Å—Ç–æ–≤"""
    db.bulk_insert_mappings(Post, posts_data)
    db.commit()
```

### 4.3 Redis/Valkey

#### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**Embeddings Cache (24h TTL):**
```python
import redis
import json
import hashlib

redis_client = redis.Redis(host='redis', port=6379, decode_responses=True)

async def get_cached_embedding(text: str) -> Optional[List[float]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π embedding"""
    text_hash = hashlib.md5(text.encode()).hexdigest()
    cache_key = f"embedding:{text_hash}"
    
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    return None

async def cache_embedding(text: str, embedding: List[float]):
    """–ö–µ—à–∏—Ä–æ–≤–∞—Ç—å embedding –Ω–∞ 24 —á–∞—Å–∞"""
    text_hash = hashlib.md5(text.encode()).hexdigest()
    cache_key = f"embedding:{text_hash}"
    
    redis_client.setex(
        cache_key,
        86400,  # 24 —á–∞—Å–∞
        json.dumps(embedding)
    )
```

**RAG Answers Cache (1h TTL):**
```python
async def get_cached_rag_answer(user_id: int, query: str) -> Optional[str]:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RAG –æ—Ç–≤–µ—Ç"""
    query_hash = hashlib.md5(f"{user_id}:{query}".encode()).hexdigest()
    cache_key = f"rag:{user_id}:{query_hash}"
    
    return redis_client.get(cache_key)

async def cache_rag_answer(user_id: int, query: str, answer: str):
    """–ö–µ—à–∏—Ä–æ–≤–∞—Ç—å RAG –æ—Ç–≤–µ—Ç –Ω–∞ 1 —á–∞—Å"""
    query_hash = hashlib.md5(f"{user_id}:{query}".encode()).hexdigest()
    cache_key = f"rag:{user_id}:{query_hash}"
    
    redis_client.setex(cache_key, 3600, answer)  # 1 —á–∞—Å
```

#### Session Management

**QR Sessions (10min TTL):**
```python
def save_qr_session(session_id: str, session_data: dict):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å QR —Å–µ—Å—Å–∏—é"""
    redis_client.setex(
        f"qr_session:{session_id}",
        600,  # 10 –º–∏–Ω—É—Ç
        json.dumps(session_data)
    )

def get_qr_session(session_id: str) -> Optional[dict]:
    """–ü–æ–ª—É—á–∏—Ç—å QR —Å–µ—Å—Å–∏—é"""
    data = redis_client.get(f"qr_session:{session_id}")
    return json.loads(data) if data else None
```

**Admin Sessions (1h TTL):**
```python
def save_admin_session(token: str, admin_data: dict):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥–º–∏–Ω —Å–µ—Å—Å–∏—é"""
    redis_client.setex(
        f"admin_session:{token}",
        3600,  # 1 —á–∞—Å
        json.dumps(admin_data)
    )
```

#### Rate Limiting

```python
def check_rate_limit(user_id: int, endpoint: str, limit: int = 10) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit"""
    key = f"rate:{user_id}:{endpoint}"
    current = redis_client.incr(key)
    
    if current == 1:
        redis_client.expire(key, 60)  # 1 –º–∏–Ω—É—Ç–∞
    
    return current <= limit
```

### 4.4 Qdrant (Vector DB)

#### –ö–æ–ª–ª–µ–∫—Ü–∏–∏ per-user

```python
from qdrant_client import QdrantClient, models

qdrant_client = QdrantClient(
    url=os.getenv("QDRANT_URL", "http://qdrant:6333"),
    api_key=os.getenv("QDRANT_API_KEY")
)

def create_user_collection(user_id: int):
    """–°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    collection_name = f"user_{user_id}_posts"
    
    qdrant_client.create_collection(
        collection_name=collection_name,
        vectors_config=models.VectorParams(
            size=1536,  # –†–∞–∑–º–µ—Ä embedding (GigaChat)
            distance=models.Distance.COSINE
        )
    )
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    qdrant_client.create_payload_index(
        collection_name=collection_name,
        field_name="channel_id",
        field_schema=models.PayloadSchemaType.INTEGER
    )
    
    qdrant_client.create_payload_index(
        collection_name=collection_name,
        field_name="tags",
        field_schema=models.PayloadSchemaType.KEYWORD
    )
```

#### Metadata Filters

```python
from qdrant_client.models import Filter, FieldCondition, MatchValue, MatchAny

def search_with_filters(user_id: int, query_vector: List[float], 
                        channel_id: Optional[int] = None,
                        tags: Optional[List[str]] = None):
    """–ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º"""
    collection_name = f"user_{user_id}_posts"
    
    # –°—Ç—Ä–æ–∏–º —Ñ–∏–ª—å—Ç—Ä
    must_conditions = []
    
    if channel_id:
        must_conditions.append(
            FieldCondition(key="channel_id", match=MatchValue(value=channel_id))
        )
    
    if tags:
        must_conditions.append(
            FieldCondition(key="tags", match=MatchAny(any=tags))
        )
    
    query_filter = Filter(must=must_conditions) if must_conditions else None
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
    results = qdrant_client.search(
        collection_name=collection_name,
        query_vector=query_vector,
        query_filter=query_filter,
        limit=10,
        score_threshold=0.7
    )
    
    return results
```

#### HNSW Configuration

```python
def optimize_collection_for_user(user_id: int):
    """–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    collection_name = f"user_{user_id}_posts"
    
    # –û–±–Ω–æ–≤–ª—è–µ–º HNSW –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    qdrant_client.update_collection(
        collection_name=collection_name,
        hnsw_config=models.HnswConfigDiff(
            payload_m=16,  # –†–∞–∑–º–µ—Ä payload –≤ HNSW
            m=0,           # –û—Ç–∫–ª—é—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π HNSW (–¥–ª—è per-user –∫–æ–ª–ª–µ–∫—Ü–∏–π)
            ef_construct=200,  # –†–∞–∑–º–µ—Ä candidate list –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏
            full_scan_threshold=10000  # –ü–æ—Ä–æ–≥ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        )
    )
```

#### Backup & Restore

```python
def backup_user_collection(user_id: int) -> dict:
    """–ë—ç–∫–∞–ø –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    collection_name = f"user_{user_id}_posts"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
    points = qdrant_client.scroll(
        collection_name=collection_name,
        limit=10000,
        with_payload=True,
        with_vectors=True
    )[0]
    
    return {
        "user_id": user_id,
        "collection_name": collection_name,
        "points": points,
        "backup_date": datetime.now(timezone.utc).isoformat()
    }

def restore_user_collection(backup_data: dict):
    """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    collection_name = backup_data["collection_name"]
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é
    qdrant_client.create_collection(
        collection_name=collection_name,
        vectors_config=models.VectorParams(size=1536, distance=models.Distance.COSINE)
    )
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–∫–∏
    qdrant_client.upsert(
        collection_name=collection_name,
        points=backup_data["points"]
    )
```

---

## 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 5.1 –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã

#### gpt2giga-proxy (GigaChat ‚Üí OpenAI API)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–∫—Å–∏ –¥–ª—è GigaChat API —Å OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
# docker-compose.override.yml
gpt2giga-proxy:
  build: ./gpt2giga
  ports:
    - "8090:8090"
  environment:
    - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
    - GPT2GIGA_PASS_MODEL=true
    - GPT2GIGA_EMBEDDINGS=EmbeddingsGigaR
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –í RAG Service
GIGACHAT_PROXY_URL = "http://gpt2giga-proxy:8090"

async def generate_embedding_gigachat(text: str) -> List[float]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding —á–µ—Ä–µ–∑ GigaChat"""
    async with httpx.AsyncClient() as client:
        response = await client.post(
            f"{GIGACHAT_PROXY_URL}/v1/embeddings",
            json={
                "model": "EmbeddingsGigaR",
                "input": text
            }
        )
        return response.json()["data"][0]["embedding"]
```

#### Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–µ LLM)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
async def process_with_ollama(text: str, model: str = "llama3.2") -> str:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π Ollama"""
    async with httpx.AsyncClient(timeout=60.0) as client:
        response = await client.post(
            "http://ollama:11434/api/generate",
            json={
                "model": model,
                "prompt": text,
                "stream": False
            }
        )
        return response.json()["response"]
```

#### Telegram Mini Apps (WebAppInfo)

**QR Auth Mini App:**
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å Mini App
keyboard = InlineKeyboardMarkup([
    [InlineKeyboardButton(
        "üîê QR –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
        web_app=WebAppInfo(url=f"{AUTH_BASE_URL}/qr-auth?session_id={session_id}")
    )]
])
```

**Admin Panel Mini App:**
```python
# –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
admin_keyboard = InlineKeyboardMarkup([
    [InlineKeyboardButton(
        "üëë Admin Panel",
        web_app=WebAppInfo(url=f"{AUTH_BASE_URL}/admin-panel?token={admin_token}")
    )]
])
```

### 5.2 –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã

#### Searxng (–º–µ—Ç–∞–ø–æ–∏—Å–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–µ–±-–ø–æ–∏—Å–∫–æ–º

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
async def search_web(query: str) -> List[str]:
    """–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —á–µ—Ä–µ–∑ Searxng"""
    auth = httpx.BasicAuth(
        os.getenv("SEARXNG_USER"),
        os.getenv("SEARXNG_PASSWORD")
    )
    
    async with httpx.AsyncClient(auth=auth, timeout=10.0) as client:
        response = await client.get(
            f"{SEARXNG_URL}/search",
            params={
                "q": query,
                "format": "json",
                "categories": "general",
                "engines": "google,bing,duckduckgo"
            }
        )
        results = response.json()["results"][:5]
        return [r["content"] for r in results if r.get("content")]
```

#### Crawl4AI (–≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ —Å—Å—ã–ª–æ–∫ –≤ –ø–æ—Å—Ç–∞—Ö

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
async def enrich_post_with_links(post: Post):
    """–û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏–∑ —Å—Å—ã–ª–æ–∫"""
    urls = extract_urls(post.text)
    
    if not urls:
        return
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(
            "http://crawl4ai:11235/crawl",
            json={
                "url": urls[0],
                "word_count_threshold": 100
            }
        )
        content = response.json()["markdown"]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫ —Ç–µ–∫—Å—Ç—É –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
    post.enriched_content = f"{post.text}\n\n{content}"
    await rag_service.reindex_post(post.id)
```

#### n8n/Flowise (automation workflows)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —á–µ—Ä–µ–∑ webhooks

**Webhook Events:**
```python
# –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ n8n
WEBHOOK_EVENTS = {
    "new_post": "–ù–æ–≤—ã–π –ø–æ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω",
    "post_tagged": "–ü–æ—Å—Ç –ø–æ–ª—É—á–∏–ª AI-—Ç–µ–≥–∏", 
    "post_indexed": "–ü–æ—Å—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ Qdrant",
    "digest_sent": "–î–∞–π–¥–∂–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
}

async def notify_webhooks(event: str, data: dict):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –≤ n8n"""
    webhook_url = os.getenv(f"WEBHOOK_{event.upper()}")
    
    if webhook_url:
        async with httpx.AsyncClient() as client:
            await client.post(
                webhook_url,
                json={
                    "event": event,
                    "timestamp": datetime.now().isoformat(),
                    "data": data
                }
            )
```

#### OpenRouter (LLM API)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Fallback LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
async def generate_answer_openrouter(prompt: str) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenRouter"""
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": "google/gemini-2.0-flash-exp:free",
                "messages": [{"role": "user", "content": prompt}],
                "max_tokens": 500,
                "temperature": 0.3
            }
        )
        return response.json()["choices"][0]["message"]["content"]
```

### 5.3 Webhooks

#### –°–æ–±—ã—Ç–∏—è –¥–ª—è n8n

**Payload —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
# –ü—Ä–∏–º–µ—Ä webhook payload
{
    "event": "new_post",
    "timestamp": "2025-10-12T15:30:00Z",
    "data": {
        "user_id": 123,
        "post_id": 456,
        "channel_username": "@ai_news",
        "post_text": "–ù–æ–≤–æ—Å—Ç–∏ –æ–± –ò–ò...",
        "tags": ["–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–Ω–æ–≤–æ—Å—Ç–∏"],
        "url": "https://t.me/ai_news/123",
        "posted_at": "2025-10-12T15:25:00Z"
    }
}
```

**–ü—Ä–∏–º–µ—Ä—ã workflows:**

**1. –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –ê–Ω–∞–ª–∏–∑:**
```json
{
    "name": "Telegram Post Analysis",
    "nodes": [
        {
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "parameters": {
                "path": "telegram-post",
                "httpMethod": "POST"
            }
        },
        {
            "name": "Analyze Sentiment",
            "type": "n8n-nodes-base.openAi",
            "parameters": {
                "operation": "chat",
                "model": "gpt-3.5-turbo",
                "messages": {
                    "values": [
                        {
                            "role": "system",
                            "content": "Analyze sentiment of the post"
                        },
                        {
                            "role": "user", 
                            "content": "{{ $json.data.post_text }}"
                        }
                    ]
                }
            }
        }
    ]
}
```

**2. –î–∞–π–¥–∂–µ—Å—Ç—ã ‚Üí Email:**
```json
{
    "name": "Daily Digest Email",
    "nodes": [
        {
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "parameters": {
                "path": "digest-sent",
                "httpMethod": "POST"
            }
        },
        {
            "name": "Send Email",
            "type": "n8n-nodes-base.emailSend",
            "parameters": {
                "to": "{{ $json.data.user_email }}",
                "subject": "Daily AI Digest",
                "text": "{{ $json.data.digest_content }}"
            }
        }
    ]
}
```

**3. Webhooks ‚Üí Slack:**
```json
{
    "name": "Telegram to Slack",
    "nodes": [
        {
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook"
        },
        {
            "name": "Slack",
            "type": "n8n-nodes-base.slack",
            "parameters": {
                "channel": "#ai-news",
                "text": "üì± New post: {{ $json.data.post_text }}"
            }
        }
    ]
}
```

---

## 6. Deployment

### 6.1 Docker Architecture

#### docker-compose.override.yml

```yaml
services:
  telethon:
    build:
      context: ./telethon
      dockerfile: Dockerfile.telethon
    container_name: telethon
    ports:
      - "8010:8010"  # FastAPI API
      - "8001:8001"  # Auth Web Server
    volumes:
      - ./telethon/sessions:/app/sessions
      - ./telethon/data:/app/data
      - ./telethon/logs:/app/logs
    environment:
      - TELEGRAM_DATABASE_URL=${TELEGRAM_DATABASE_URL}
      - BOT_TOKEN=${BOT_TOKEN}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - MASTER_API_ID=${MASTER_API_ID}
      - MASTER_API_HASH=${MASTER_API_HASH}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    restart: unless-stopped
    networks:
      - localai_default

  rag-service:
    build:
      context: ./telethon/rag_service
      dockerfile: Dockerfile.rag
    container_name: rag-service
    ports:
      - "8020:8020"
    environment:
      - QDRANT_URL=http://qdrant:6333
      - REDIS_HOST=redis
      - GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090
    networks:
      - localai_default

  gpt2giga-proxy:
    build:
      context: ./gpt2giga
      dockerfile: Dockerfile.gpt2giga
    container_name: gpt2giga-proxy
    ports:
      - "8090:8090"
    environment:
      - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
    networks:
      - localai_default
```

#### –°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
networks:
  localai_default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

#### Volumes –∏ Persistency

```yaml
volumes:
  # Telegram sessions (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
  - ./telethon/sessions:/app/sessions
  
  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  - ./telethon/data:/app/data
  
  # –õ–æ–≥–∏
  - ./telethon/logs:/app/logs
  
  # Redis –¥–∞–Ω–Ω—ã–µ
  - redis_data:/data
  
  # Qdrant –¥–∞–Ω–Ω—ã–µ
  - qdrant_data:/qdrant/storage
```

### 6.2 Build Process

#### Dockerfile.telethon

```dockerfile
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ requirements
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
COPY . .

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p sessions data logs

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -m -u 1000 telethon && chown -R telethon:telethon /app
USER telethon

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8010/health || exit 1

# –ó–∞–ø—É—Å–∫
CMD ["python", "run_system.py"]
```

#### Dockerfile.rag

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è RAG
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
COPY . .

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p data logs

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8020/health || exit 1

# –ó–∞–ø—É—Å–∫
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8020"]
```

#### Multi-stage builds

```dockerfile
# –°—Ç–∞–¥–∏—è —Å–±–æ—Ä–∫–∏
FROM python:3.11-slim as builder

WORKDIR /app
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# –°—Ç–∞–¥–∏—è production
FROM python:3.11-slim

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
COPY --from=builder /root/.local /root/.local

# –û—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è...
```

### 6.3 Production Deployment

#### Caddy Reverse Proxy

```caddy
{$TELEGRAM_AUTH_HOSTNAME:telegram-auth.produman.studio} {
    # Admin Panel Mini App
    reverse_proxy /admin-panel* telethon:8010
    reverse_proxy /api/admin/* telethon:8010
    
    # QR Auth Mini App  
    reverse_proxy /qr-auth* telethon:8010
    
    # OAuth web server (legacy)
    reverse_proxy telethon:8001
    
    # API endpoints
    reverse_proxy /users/* telethon:8010
    reverse_proxy /posts/* telethon:8010
    reverse_proxy /channels/* telethon:8010
}

# RAG Service
rag.produman.studio {
    reverse_proxy /rag/* rag-service:8020
    reverse_proxy /health rag-service:8020
}
```

#### HTTPS/SSL

```caddy
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π SSL —á–µ—Ä–µ–∑ Let's Encrypt
{$TELEGRAM_AUTH_HOSTNAME:telegram-auth.produman.studio} {
    tls {
        dns cloudflare {$CLOUDFLARE_API_TOKEN}
    }
    
    # –û—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è...
}
```

#### Domain Routing

```caddy
# –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
{$DOMAIN:produman.studio} {
    # Redirect to admin panel
    redir / /admin-panel 301
    
    # API endpoints
    reverse_proxy /api/* telethon:8010
    reverse_proxy /health telethon:8010
}

# RAG Service subdomain
rag.{$DOMAIN:produman.studio} {
    reverse_proxy rag-service:8020
}
```

#### Health Checks

```python
# –í FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
@app.get("/health")
async def health_check():
    """Comprehensive health check"""
    checks = {
        "database": await check_database(),
        "redis": await check_redis(),
        "qdrant": await check_qdrant(),
        "gigachat_proxy": await check_gigachat()
    }
    
    all_healthy = all(checks.values())
    status = "healthy" if all_healthy else "degraded"
    
    return {
        "status": status,
        "timestamp": datetime.now().isoformat(),
        "checks": checks,
        "version": "3.1.0"
    }

async def check_database() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
    try:
        db = SessionLocal()
        db.execute("SELECT 1")
        db.close()
        return True
    except:
        return False

async def check_redis() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Redis"""
    try:
        redis_client.ping()
        return True
    except:
        return False

async def check_qdrant() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Qdrant"""
    try:
        qdrant_client.get_collections()
        return True
    except:
        return False
```

### 6.4 Scaling Strategies

#### Horizontal Scaling –¥–ª—è RAG

```yaml
# docker-compose.scale.yml
services:
  rag-service:
    deploy:
      replicas: 3
    environment:
      - RAG_INSTANCE_ID=${HOSTNAME}
      - LOAD_BALANCER_MODE=true
```

#### Database Read Replicas

```python
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è read replicas
DATABASE_READ_URL = os.getenv("TELEGRAM_DATABASE_READ_URL")
DATABASE_WRITE_URL = os.getenv("TELEGRAM_DATABASE_URL")

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ read/write –æ–ø–µ—Ä–∞—Ü–∏–π
def get_read_db():
    return create_engine(DATABASE_READ_URL)

def get_write_db():
    return create_engine(DATABASE_WRITE_URL)
```

#### Redis Cluster

```yaml
# redis-cluster.yml
services:
  redis-node-1:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7001:7001"
      - "17001:17001"
  
  redis-node-2:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7002:7002"
      - "17002:17002"
```

#### Load Balancing

```nginx
# nginx.conf –¥–ª—è load balancing
upstream rag_backend {
    server rag-service-1:8020;
    server rag-service-2:8020;
    server rag-service-3:8020;
}

server {
    listen 80;
    server_name rag.produman.studio;
    
    location / {
        proxy_pass http://rag_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 7. –ü–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 7.1 User Journey: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```mermaid
sequenceDiagram
    participant U as üë§ User
    participant B as ü§ñ Bot
    participant Q as üîê QR Manager
    participant R as ‚ö° Redis
    participant D as üóÑÔ∏è Database
    participant T as üì± Telegram
    
    Note over U,T: QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Mini App
    U->>B: /start
    B->>U: "–í–≤–µ–¥–∏—Ç–µ invite code"
    U->>B: /login INVITE_CODE
    B->>Q: create_qr_session(telegram_id, invite_code)
    Q->>R: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å session (TTL: 10min)
    Q->>T: client.qr_login()
    T->>Q: QR login object
    Q->>B: session_id + deep_link
    B->>U: Mini App button (WebAppInfo)
    
    U->>T: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
    T->>U: QR –∫–æ–¥ + deep link
    U->>T: –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR –≤ Telegram
    T->>Q: Authorization callback
    Q->>D: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ownership
    Q->>D: Update user.is_authenticated = true
    Q->>D: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ invite code
    Q->>B: Authorization complete
    B->>U: ‚úÖ "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞: {type}"
```

### 7.2 User Journey: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞

```mermaid
sequenceDiagram
    participant U as üë§ User
    participant B as ü§ñ Bot
    participant A as üåê API
    participant S as üîê Shared Auth
    participant T as üì± Telegram API
    participant D as üóÑÔ∏è Database
    participant P as üì• Parser
    participant R as üß† RAG
    
    U->>B: /add_channel
    B->>A: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å max_channels
    A->>D: SELECT COUNT(*) FROM channels WHERE user_id = ?
    D->>A: current_count
    A->>B: current_count < max_channels
    
    B->>U: "–í–≤–µ–¥–∏—Ç–µ username –∫–∞–Ω–∞–ª–∞"
    U->>B: @channel_name
    B->>A: POST /users/{user_id}/channels
    A->>S: get_user_client(telegram_id)
    S->>T: resolve_username(@channel_name)
    T->>S: channel_info
    S->>A: channel_info
    A->>D: INSERT INTO channels
    A->>P: Trigger first parse
    P->>T: get_messages(channel)
    P->>D: INSERT INTO posts (bulk)
    P->>R: index_batch(post_ids)
    R->>R: Generate embeddings
    R->>R: Store in Qdrant
    A->>B: Channel added successfully
    B->>U: ‚úÖ "–ö–∞–Ω–∞–ª @channel_name –¥–æ–±–∞–≤–ª–µ–Ω! –ù–∞–π–¥–µ–Ω–æ {count} –ø–æ—Å—Ç–æ–≤"
```

### 7.3 User Journey: RAG –∑–∞–ø—Ä–æ—Å

```mermaid
sequenceDiagram
    participant U as üë§ User
    participant B as ü§ñ Bot
    participant A as üåê API
    participant R as üß† RAG Service
    participant C as ‚ö° Redis Cache
    participant E as üß† Embeddings
    participant G as ü§ñ GigaChat
    participant Q as üîç Qdrant
    participant O as üß† OpenRouter
    
    U->>B: /ask –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ AI?
    B->>A: POST /rag/query
    A->>R: Process query
    R->>C: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cache
    C-->>R: Cache miss
    
    R->>E: generate_embedding(query)
    E->>G: POST /v1/embeddings
    G->>E: embedding vector
    E->>C: –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å embedding (24h)
    E->>R: embedding vector
    
    R->>Q: search(vector, user_filters)
    Q->>R: Top 10 posts + scores
    R->>R: assemble_context(posts)
    R->>O: POST /chat/completions
    O->>R: generated answer
    R->>C: –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç (1h)
    R->>A: answer + sources
    A->>B: Response data
    B->>U: üìù "–û—Ç–≤–µ—Ç: {answer}\n\nüìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏: {sources}"
```

### 7.4 Background Process: –ü–∞—Ä—Å–∏–Ω–≥

```mermaid
sequenceDiagram
    participant S as ‚è∞ Scheduler
    participant P as üì• Parser
    participant D as üóÑÔ∏è Database
    participant A as üîê Shared Auth
    participant T as üì± Telegram API
    participant G as üè∑Ô∏è Tagging
    participant R as üß† RAG
    participant Q as üîç Qdrant
    
    Note over S,Q: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    S->>P: parse_all_channels()
    P->>D: get_authenticated_users()
    D->>P: List[User]
    
    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        P->>A: get_user_client(telegram_id)
        A->>P: Telethon client
        P->>D: get_active_channels(user_id)
        D->>P: List[Channel]
        
        loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            P->>T: get_messages(channel, limit=50)
            T->>P: List[Message]
            P->>D: bulk_insert(posts)
            P->>G: add_task(post_ids)
        end
    end
    
    Note over G,Q: –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤
    G->>G: batch_generate_tags(posts)
    G->>D: update posts.tags
    G->>R: index_batch(post_ids)
    R->>R: generate_embeddings(posts)
    R->>Q: upsert(vectors)
    R->>D: update indexing_status
```

### 7.5 Admin Process: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```mermaid
sequenceDiagram
    participant A as üëë Admin
    participant B as ü§ñ Bot
    participant M as üîê Admin Manager
    participant R as ‚ö° Redis
    participant W as üåê Browser
    participant F as üåê FastAPI
    participant D as üóÑÔ∏è Database
    
    A->>B: /admin
    B->>M: create_admin_session(admin_id)
    M->>R: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å token (TTL: 1h)
    M->>B: admin_token
    B->>A: Mini App button (WebAppInfo)
    
    A->>W: –û—Ç–∫—Ä—ã—Ç—å Mini App
    W->>F: GET /admin-panel?token=...
    F->>M: verify_admin_session(token, admin_id)
    M->>R: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å token
    R->>M: session_data
    M->>F: ‚úÖ Verified
    F->>W: SPA (HTML/CSS/JS)
    
    W->>F: GET /api/admin/users
    F->>D: query users with filters
    D->>F: users_data
    F->>W: JSON response
    W->>A: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    
    A->>W: –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    W->>F: POST /api/admin/user/{id}/subscription
    F->>D: UPDATE user SET subscription_type = ?
    F->>D: INSERT INTO subscription_history
    D->>F: Success
    F->>W: Success response
    W->>A: ‚úÖ "–ü–æ–¥–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞"
```

### 7.6 AI Digest Generation

```mermaid
sequenceDiagram
    participant S as ‚è∞ Scheduler
    participant R as üß† RAG Service
    participant D as üóÑÔ∏è Database
    participant H as üìä Query History
    participant Q as üîç Qdrant
    participant G as ü§ñ GigaChat
    participant B as ü§ñ Bot
    
    Note over S,B: –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
    S->>R: generate_digest(user_id)
    R->>D: get_digest_settings(user_id)
    D->>R: DigestSettings
    
    R->>H: get_query_history(user_id, days=30)
    H->>R: List[queries]
    R->>R: extract_topics(queries)
    
    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–ø–∏–∫–∞
        R->>Q: search_by_topic(user_id, topic)
        Q->>R: relevant_posts
    end
    
    R->>R: rank_posts_by_relevance()
    R->>G: POST /chat/completions (summarize)
    G->>R: digest_content
    R->>D: save_digest(user_id, content)
    R->>B: send_digest(user_id, content)
    B->>B: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

## 8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ Observability

### 8.1 –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```python
from prometheus_client import Counter, Histogram, Gauge, Info

# –°—á–µ—Ç—á–∏–∫–∏
rag_queries_total = Counter(
    'rag_queries_total', 
    'Total RAG queries',
    ['user_id', 'status']
)

posts_parsed_total = Counter(
    'posts_parsed_total',
    'Total posts parsed',
    ['user_id', 'channel_id']
)

embeddings_generated_total = Counter(
    'embeddings_generated_total',
    'Total embeddings generated',
    ['provider']  # gigachat, openrouter
)

# –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
rag_query_duration = Histogram(
    'rag_query_duration_seconds',
    'RAG query processing time',
    ['user_id']
)

parsing_duration = Histogram(
    'parsing_duration_seconds',
    'Channel parsing duration',
    ['user_id', 'channel_id']
)

embedding_generation_duration = Histogram(
    'embedding_generation_duration_seconds',
    'Embedding generation time',
    ['provider']
)

# Gauges
active_users = Gauge(
    'active_users_total',
    'Number of active users'
)

posts_in_queue = Gauge(
    'posts_in_queue_total',
    'Posts waiting for processing'
)

embeddings_cache_hit_rate = Gauge(
    'embeddings_cache_hit_rate',
    'Embeddings cache hit rate'
)

# Info
system_info = Info(
    'system_info',
    'System information'
)
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

```python
# –í RAG Service
@app.post("/rag/query")
async def rag_query(request: QueryRequest):
    with rag_query_duration.labels(user_id=request.user_id).time():
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        result = await process_rag_query(request)
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
        rag_queries_total.labels(
            user_id=request.user_id,
            status="success"
        ).inc()
        
        return result

# –í Parser Service
async def parse_channel(user_id: int, channel_id: int):
    with parsing_duration.labels(user_id=user_id, channel_id=channel_id).time():
        posts = await get_channel_messages(channel_id)
        
        posts_parsed_total.labels(
            user_id=user_id,
            channel_id=channel_id
        ).inc(len(posts))
```

#### Grafana Dashboards

**Dashboard: Telegram Parser Overview**
```json
{
  "dashboard": {
    "title": "Telegram Parser Bot - Overview",
    "panels": [
      {
        "title": "RAG Queries Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(rag_queries_total[5m])",
            "legendFormat": "{{status}}"
          }
        ]
      },
      {
        "title": "Posts Parsed Rate", 
        "type": "graph",
        "targets": [
          {
            "expr": "rate(posts_parsed_total[5m])",
            "legendFormat": "User {{user_id}}"
          }
        ]
      },
      {
        "title": "RAG Query Duration",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rag_query_duration_seconds_bucket)",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "Active Users",
        "type": "singlestat",
        "targets": [
          {
            "expr": "active_users_total"
          }
        ]
      }
    ]
  }
}
```

#### Alerting Rules

```yaml
# prometheus-alerts.yml
groups:
  - name: telegram-parser
    rules:
      - alert: HighRAGQueryLatency
        expr: histogram_quantile(0.95, rag_query_duration_seconds_bucket) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "RAG query latency is high"
          description: "95th percentile latency is {{ $value }}s"
      
      - alert: EmbeddingsCacheMissRate
        expr: embeddings_cache_hit_rate < 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Embeddings cache hit rate is low"
          description: "Cache hit rate is {{ $value }}"
      
      - alert: ParsingErrors
        expr: rate(posts_parsed_total{status="error"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High parsing error rate"
          description: "Error rate is {{ $value }} per second"
```

### 8.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### Structured Logging

```python
import logging
import json
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ structured logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/telethon.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def log_event(event: str, user_id: int, **metadata):
    """Structured log –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
    log_data = {
        "timestamp": datetime.now().isoformat(),
        "event": event,
        "user_id": user_id,
        **metadata
    }
    logger.info(json.dumps(log_data))

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
log_event("rag_query", user_id=123, query="AI –Ω–æ–≤–æ—Å—Ç–∏", duration_ms=450)
log_event("post_indexed", user_id=123, post_id=456, vector_id="vec_789")
log_event("channel_added", user_id=123, channel="@ai_news", posts_count=25)
```

#### Log Levels

```python
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
LOGGING_CONFIG = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "detailed": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        },
        "json": {
            "format": "%(message)s",
            "class": "pythonjsonlogger.jsonlogger.JsonFormatter"
        }
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "level": "INFO",
            "formatter": "detailed"
        },
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "filename": "logs/telethon.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "formatter": "json"
        }
    },
    "loggers": {
        "": {
            "handlers": ["console", "file"],
            "level": "INFO"
        },
        "telethon": {
            "level": "WARNING"  # –ú–µ–Ω—å—à–µ –ª–æ–≥–æ–≤ –æ—Ç Telethon
        },
        "httpx": {
            "level": "WARNING"  # –ú–µ–Ω—å—à–µ –ª–æ–≥–æ–≤ –æ—Ç HTTP –∫–ª–∏–µ–Ω—Ç–∞
        }
    }
}
```

#### Log Rotation

```python
from logging.handlers import RotatingFileHandler, TimedRotatingFileHandler

# –ü–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–∞
size_handler = RotatingFileHandler(
    'logs/telethon.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)

# –ü–æ –≤—Ä–µ–º–µ–Ω–∏
time_handler = TimedRotatingFileHandler(
    'logs/telethon.log',
    when='midnight',
    interval=1,
    backupCount=30  # –•—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π
)
```

### 8.3 Tracing

#### Request Tracing

```python
import uuid
from contextvars import ContextVar

# Context variable –¥–ª—è trace ID
trace_id_var: ContextVar[str] = ContextVar('trace_id')

def get_trace_id() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å trace ID"""
    try:
        return trace_id_var.get()
    except LookupError:
        trace_id = str(uuid.uuid4())
        trace_id_var.set(trace_id)
        return trace_id

# Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ trace ID
@app.middleware("http")
async def add_trace_id(request: Request, call_next):
    trace_id = get_trace_id()
    response = await call_next(request)
    response.headers["X-Trace-ID"] = trace_id
    return response

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
def log_with_trace(level: str, message: str, **kwargs):
    trace_id = get_trace_id()
    logger.log(level, f"[{trace_id}] {message}", **kwargs)
```

#### Performance Tracing

```python
import time
from functools import wraps

def trace_performance(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        trace_id = get_trace_id()
        
        try:
            result = await func(*args, **kwargs)
            duration = time.time() - start_time
            
            log_with_trace(
                "INFO",
                f"Function {func.__name__} completed",
                duration_ms=duration * 1000,
                status="success"
            )
            
            return result
        except Exception as e:
            duration = time.time() - start_time
            
            log_with_trace(
                "ERROR", 
                f"Function {func.__name__} failed",
                duration_ms=duration * 1000,
                error=str(e),
                status="error"
            )
            raise
    
    return wrapper

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
@trace_performance
async def process_rag_query(query: str, user_id: int):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    pass
```

### 8.4 Health Checks

#### Comprehensive Health Check

```python
@app.get("/health")
async def health_check():
    """Comprehensive health check"""
    checks = {
        "database": await check_database(),
        "redis": await check_redis(),
        "qdrant": await check_qdrant(),
        "gigachat_proxy": await check_gigachat(),
        "telegram_api": await check_telegram_api()
    }
    
    all_healthy = all(checks.values())
    status = "healthy" if all_healthy else "degraded"
    
    return {
        "status": status,
        "timestamp": datetime.now().isoformat(),
        "checks": checks,
        "version": "3.1.0",
        "uptime": get_uptime()
    }

async def check_database() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
    try:
        db = SessionLocal()
        db.execute("SELECT 1")
        db.close()
        return True
    except Exception as e:
        logger.error(f"Database check failed: {e}")
        return False

async def check_redis() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Redis"""
    try:
        redis_client.ping()
        return True
    except Exception as e:
        logger.error(f"Redis check failed: {e}")
        return False

async def check_qdrant() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Qdrant"""
    try:
        qdrant_client.get_collections()
        return True
    except Exception as e:
        logger.error(f"Qdrant check failed: {e}")
        return False

async def check_gigachat() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ GigaChat proxy"""
    try:
        async with httpx.AsyncClient(timeout=5.0) as client:
            response = await client.get(f"{GIGACHAT_PROXY_URL}/health")
            return response.status_code == 200
    except Exception as e:
        logger.error(f"GigaChat check failed: {e}")
        return False

async def check_telegram_api() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram API"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ shared_auth_manager
        client = await shared_auth_manager.get_master_client()
        if client and client.is_connected():
            return True
        return False
    except Exception as e:
        logger.error(f"Telegram API check failed: {e}")
        return False
```

#### Dependencies Check

```python
@app.get("/health/dependencies")
async def dependencies_check():
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"""
    dependencies = {
        "postgresql": {
            "status": await check_database(),
            "response_time": await measure_db_response_time()
        },
        "redis": {
            "status": await check_redis(),
            "memory_usage": await get_redis_memory_usage()
        },
        "qdrant": {
            "status": await check_qdrant(),
            "collections_count": await get_qdrant_collections_count()
        },
        "gigachat_proxy": {
            "status": await check_gigachat(),
            "response_time": await measure_gigachat_response_time()
        }
    }
    
    return {
        "timestamp": datetime.now().isoformat(),
        "dependencies": dependencies
    }
```

#### Graceful Degradation

```python
# –í RAG Service
async def generate_answer_with_fallback(query: str, context: str) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å fallback"""
    try:
        # –ü—Ä–æ–±—É–µ–º GigaChat
        return await gigachat_generate(query, context)
    except Exception as e:
        logger.warning(f"GigaChat failed: {e}, trying OpenRouter")
        
        try:
            # Fallback –Ω–∞ OpenRouter
            return await openrouter_generate(query, context)
        except Exception as e:
            logger.error(f"All LLM providers failed: {e}")
            
            # –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            return f"–ù–∞–π–¥–µ–Ω–æ {len(context.split())} —Å–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. " \
                   f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç."

# –í Parser Service
async def parse_with_retry(channel_id: int, max_retries: int = 3) -> List[Post]:
    """–ü–∞—Ä—Å–∏–Ω–≥ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    for attempt in range(max_retries):
        try:
            return await parse_channel(channel_id)
        except FloodWaitError as e:
            if attempt == max_retries - 1:
                raise
            
            logger.warning(f"FloodWait: {e.seconds}s, attempt {attempt + 1}")
            await asyncio.sleep(e.seconds)
        except Exception as e:
            if attempt == max_retries - 1:
                logger.error(f"Parsing failed after {max_retries} attempts: {e}")
                raise
            
            logger.warning(f"Parsing attempt {attempt + 1} failed: {e}")
            await asyncio.sleep(2 ** attempt)  # Exponential backoff
```

---

## 9. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 9.1 –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –í–µ—Ä—Å–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|--------|----------|
| **Telegram Bot** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π |
| **FastAPI Server** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | REST API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π |
| **Parser Service** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤ |
| **RAG Service** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ |
| **QR Auth Manager** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Mini App |
| **Admin Panel** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | SPA –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ |
| **Tagging Service** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | AI-—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ |
| **Cleanup Service** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | –°–∏—Å—Ç–µ–º–∞ retention |
| **Subscription System** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | 3.1 | –†–æ–ª–∏, –ø–æ–¥–ø–∏—Å–∫–∏, invite codes |

### 9.2 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    retention_days INTEGER DEFAULT 30,
    api_id VARCHAR(255),  -- encrypted
    api_hash TEXT,        -- encrypted
    phone_number TEXT,    -- encrypted
    session_file VARCHAR(255),
    is_authenticated BOOLEAN DEFAULT FALSE,
    last_auth_check TIMESTAMP WITH TIME ZONE,
    auth_error TEXT,
    auth_session_id VARCHAR(255),
    auth_session_expires TIMESTAMP WITH TIME ZONE,
    failed_auth_attempts INTEGER DEFAULT 0,
    last_auth_attempt TIMESTAMP WITH TIME ZONE,
    is_blocked BOOLEAN DEFAULT FALSE,
    block_expires TIMESTAMP WITH TIME ZONE,
    role VARCHAR(50) DEFAULT 'user',
    subscription_type VARCHAR(50) DEFAULT 'free',
    subscription_expires TIMESTAMP WITH TIME ZONE,
    subscription_started_at TIMESTAMP WITH TIME ZONE,
    max_channels INTEGER DEFAULT 3,
    invited_by INTEGER REFERENCES users(id)
);

CREATE TABLE channels (
    id SERIAL PRIMARY KEY,
    channel_username VARCHAR(255) UNIQUE NOT NULL,
    channel_title VARCHAR(255),
    channel_id BIGINT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_parsed_at TIMESTAMP WITH TIME ZONE,
    posts_count INTEGER DEFAULT 0,
    description TEXT
);

CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    channel_id INTEGER REFERENCES channels(id),
    post_id BIGINT,
    text TEXT,
    enriched_content TEXT,  -- NEW in v3.1
    url VARCHAR(500),
    posted_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    tags JSONB,  -- Array of strings
    is_parsed BOOLEAN DEFAULT FALSE,
    media_type VARCHAR(100),
    media_url VARCHAR(500)
);

-- RAG System —Ç–∞–±–ª–∏—Ü—ã (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)
CREATE TABLE digest_settings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    enabled BOOLEAN DEFAULT FALSE,
    frequency VARCHAR(20) DEFAULT 'daily',
    time VARCHAR(10) DEFAULT '09:00',
    days_of_week JSONB,  -- Array of strings
    channels JSONB,      -- Array of channel IDs
    tags JSONB,          -- Array of strings
    format VARCHAR(20) DEFAULT 'markdown',
    max_posts INTEGER DEFAULT 20,
    delivery_method VARCHAR(20) DEFAULT 'telegram',
    ai_summarize BOOLEAN DEFAULT TRUE,
    preferred_topics JSONB,  -- Array of strings
    summary_style VARCHAR(20) DEFAULT 'concise',
    timezone VARCHAR(50) DEFAULT 'Europe/Moscow'
);

CREATE TABLE indexing_status (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    post_id INTEGER REFERENCES posts(id),
    vector_id VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    error TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE rag_query_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    query TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    extracted_topics JSONB  -- Array of strings
);

-- Subscription & Roles (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)
CREATE TABLE invite_codes (
    code VARCHAR(255) PRIMARY KEY,
    created_by INTEGER REFERENCES users(id),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    max_uses INTEGER DEFAULT 1,
    uses_count INTEGER DEFAULT 0,
    default_subscription VARCHAR(50) DEFAULT 'free',
    default_trial_days INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE subscription_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    action VARCHAR(50) NOT NULL,  -- created/upgraded/downgraded/renewed
    old_type VARCHAR(50),
    new_type VARCHAR(50),
    changed_by INTEGER REFERENCES users(id),
    changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    notes TEXT
);
```

#### –ò–Ω–¥–µ–∫—Å—ã (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_users_telegram_id ON users(telegram_id);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_subscription ON users(subscription_type);
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_channel_id ON posts(channel_id);
CREATE INDEX idx_posts_posted_at ON posts(posted_at);
CREATE INDEX idx_posts_user_posted ON posts(user_id, posted_at);
CREATE INDEX idx_channels_username ON channels(channel_username);
CREATE INDEX idx_invite_codes_expires ON invite_codes(expires_at);
CREATE INDEX idx_subscription_history_user ON subscription_history(user_id);
CREATE INDEX idx_indexing_status_user ON indexing_status(user_id);
CREATE INDEX idx_indexing_status_post ON indexing_status(post_id);
```

### 9.3 –°–µ—Ä–≤–∏—Å—ã - —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### Telegram Bot Service (`bot.py`)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
# ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
class TelegramBot:
    def __init__(self):
        self.application = Application.builder().token(BOT_TOKEN).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
        self.application.add_handler(CommandHandler("start", start_command))
        self.application.add_handler(CommandHandler("login", login_command))
        self.application.add_handler(CommandHandler("add_channel", add_channel_command))
        self.application.add_handler(CommandHandler("my_channels", my_channels_command))
        self.application.add_handler(CommandHandler("ask", ask_command))
        self.application.add_handler(CommandHandler("search", search_command))
        self.application.add_handler(CommandHandler("recommend", recommend_command))
        self.application.add_handler(CommandHandler("digest", digest_command))
        
        # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
        self.application.add_handler(CommandHandler("admin", admin_command))
        self.application.add_handler(CommandHandler("admin_invite", admin_invite_command))
```

#### FastAPI Server (`main.py`)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ endpoints:**
```python
# ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
@app.get("/users/{user_id}/auth_status")
@app.post("/users/{user_id}/logout")
@app.get("/qr-auth")  # Mini App
@app.get("/qr-auth-status")
@app.get("/users/{user_id}/channels")
@app.post("/users/{user_id}/channels")
@app.delete("/users/{user_id}/channels/{channel_id}")
@app.get("/users/{user_id}/posts")
@app.get("/posts/{post_id}")
@app.post("/posts/{post_id}/tags")
@app.get("/admin-panel")  # Mini App
@app.get("/api/admin/users")
@app.post("/api/admin/user/{id}/role")
@app.post("/api/admin/user/{id}/subscription")
@app.post("/api/admin/invite/create")
```

#### RAG Service (`rag_service/main.py`)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ endpoints:**
```python
# ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
@app.post("/rag/index/post/{post_id}")
@app.post("/rag/index/batch")
@app.get("/rag/index/status/{user_id}")
@app.post("/rag/query")
@app.post("/rag/search")
@app.get("/rag/recommend/{user_id}")
@app.post("/rag/digest/settings/{user_id}")
@app.post("/rag/digest/generate/{user_id}")
@app.get("/rag/health")
```

#### QR Auth Manager (`qr_auth_manager.py`)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
# ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
class QRAuthManager:
    async def create_qr_session(self, telegram_id: int, invite_code: str):
        # –°–æ–∑–¥–∞–Ω–∏–µ QR —Å–µ—Å—Å–∏–∏ —Å TTL 10 –º–∏–Ω—É—Ç
        pass
    
    async def _poll_authorization(self, session_id: str, qr_login):
        # Polling –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        pass
    
    async def _finalize_authorization(self, session_id: str):
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        pass
```

#### Admin Panel Manager (`admin_panel_manager.py`)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
# ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
class AdminPanelManager:
    def create_admin_session(self, admin_id: int) -> Optional[str]:
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω —Å–µ—Å—Å–∏–∏ —Å TTL 1 —á–∞—Å
        pass
    
    def verify_admin_session(self, token: str, admin_id: int) -> bool:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω —Å–µ—Å—Å–∏–∏
        pass
```

### 9.4 Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

```yaml
# docker-compose.override.yml (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
services:
  telethon:
    build: ./telethon
    ports:
      - "8010:8010"  # FastAPI API
      - "8001:8001"  # Auth Web Server
    volumes:
      - ./telethon/sessions:/app/sessions
      - ./telethon/data:/app/data
      - ./telethon/logs:/app/logs
    environment:
      - TELEGRAM_DATABASE_URL=${TELEGRAM_DATABASE_URL}
      - BOT_TOKEN=${BOT_TOKEN}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - MASTER_API_ID=${MASTER_API_ID}
      - MASTER_API_HASH=${MASTER_API_HASH}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - localai_default

  rag-service:
    build: ./telethon/rag_service
    ports:
      - "8020:8020"
    environment:
      - QDRANT_URL=http://qdrant:6333
      - REDIS_HOST=redis
      - GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090
    networks:
      - localai_default

  gpt2giga-proxy:
    build: ./gpt2giga
    ports:
      - "8090:8090"
    environment:
      - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
    networks:
      - localai_default
```

### 9.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
|------------|--------|--------------|
| **PostgreSQL** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | Supabase —á–µ—Ä–µ–∑ `TELEGRAM_DATABASE_URL` |
| **Redis/Valkey** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | `redis:6379` –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–µ—Å—Å–∏–π |
| **Qdrant** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | `qdrant:6333` –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ |
| **GigaChat** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | –ß–µ—Ä–µ–∑ `gpt2giga-proxy:8090` |
| **OpenRouter** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | Fallback LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä |
| **Searxng** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | –í–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ RAG |
| **Crawl4AI** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å—Å—ã–ª–∫–∞–º–∏ |
| **n8n/Flowise** | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | Webhooks –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ |

### 9.6 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)
TELEGRAM_DATABASE_URL=postgresql://postgres:password@db:5432/postgres
BOT_TOKEN=1234567890:ABC...
ENCRYPTION_KEY=your-32-char-encryption-key
MASTER_API_ID=12345678
MASTER_API_HASH=abcdef1234567890abcdef1234567890

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Qdrant
QDRANT_URL=http://qdrant:6333
QDRANT_API_KEY=your-qdrant-api-key

# GigaChat
GIGACHAT_CREDENTIALS=your-gigachat-credentials

# OpenRouter
OPENROUTER_API_KEY=your-openrouter-api-key

# Searxng
SEARXNG_URL=https://searxng.produman.studio
SEARXNG_USER=your-username
SEARXNG_PASSWORD=your-password

# Webhooks
WEBHOOK_NEW_POST=https://n8n.produman.studio/webhook/telegram-new-post
WEBHOOK_POST_TAGGED=https://n8n.produman.studio/webhook/telegram-post-tagged
WEBHOOK_POST_INDEXED=https://n8n.produman.studio/webhook/telegram-post-indexed
WEBHOOK_DIGEST_SENT=https://n8n.produman.studio/webhook/telegram-digest-sent
```

### 9.7 –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```
telethon/
‚îú‚îÄ‚îÄ README.md                    # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω
‚îú‚îÄ‚îÄ TESTING_GUIDE.md            # ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç
‚îú‚îÄ‚îÄ QUICK_REFERENCE.md          # ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ SYSTEM_SPECIFICATION.md # ‚úÖ –°–æ–∑–¥–∞–Ω (2700+ —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ SYSTEM_PIPELINE.md      # ‚úÖ –°–æ–∑–¥–∞–Ω (700+ —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ [–æ—Å—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]
‚îú‚îÄ‚îÄ rag_service/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # ‚úÖ RAG –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ vector_db.py            # ‚úÖ Qdrant –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ embeddings.py           # ‚úÖ Embeddings –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ search.py               # ‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
‚îÇ   ‚îú‚îÄ‚îÄ generator.py            # ‚úÖ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt        # ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ bot.py                      # ‚úÖ Telegram Bot
‚îú‚îÄ‚îÄ main.py                     # ‚úÖ FastAPI Server
‚îú‚îÄ‚îÄ parser_service.py           # ‚úÖ –ü–∞—Ä—Å–µ—Ä –∫–∞–Ω–∞–ª–æ–≤
‚îú‚îÄ‚îÄ qr_auth_manager.py          # ‚úÖ QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ admin_panel_manager.py      # ‚úÖ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
‚îú‚îÄ‚îÄ shared_auth_manager.py      # ‚úÖ Telethon –∫–ª–∏–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ subscription_config.py     # ‚úÖ –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
‚îú‚îÄ‚îÄ models.py                   # ‚úÖ SQLAlchemy –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ database.py                 # ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îú‚îÄ‚îÄ tagging_service.py          # ‚úÖ AI —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ cleanup_service.py          # ‚úÖ –°–∏—Å—Ç–µ–º–∞ retention
‚îú‚îÄ‚îÄ auth.py                     # ‚úÖ –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îú‚îÄ‚îÄ secure_auth_manager.py      # ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îú‚îÄ‚îÄ auth_web_server.py          # ‚úÖ Web —Å–µ—Ä–≤–µ—Ä OAuth
‚îú‚îÄ‚îÄ user_auth_manager.py        # ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îú‚îÄ‚îÄ crypto_utils.py             # ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ run_system.py               # ‚úÖ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ requirements.txt            # ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile.telethon         # ‚úÖ Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ sessions/                   # ‚úÖ Telegram —Å–µ—Å—Å–∏–∏
‚îú‚îÄ‚îÄ data/                       # ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ logs/                       # ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

### 9.8 –°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–æ –≤–µ—Ä—Å–∏—è–º

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
|--------|------|-------------------|
| **3.1** | 12.10.2025 | ‚úÖ QR Login, Admin Panel, RAG System, Subscription System |
| **2.2** | 11.10.2025 | ‚úÖ RAG System, AI-–¥–∞–π–¥–∂–µ—Å—Ç—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
| **2.1** | 10.10.2025 | ‚úÖ Docker –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, dev.sh —Å–∫—Ä–∏–ø—Ç—ã |
| **2.0** | 09.10.2025 | ‚úÖ –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ |
| **1.0** | 08.10.2025 | ‚úÖ –ë–∞–∑–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä –∫–∞–Ω–∞–ª–æ–≤ |

---

> **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç...**  
> –°–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã: Security, Performance, Testing, Troubleshooting, API Reference, Code Examples
