# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

**–î–∞—Ç–∞**: 2025-11-05  
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: 8124731874, 139883458 (—Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

## ‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

### 1. RAG –∑–∞–ø—Ä–æ—Å—ã

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç**

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç (`rag_query_history`)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–Ω—Ç–µ–Ω—Ç—ã –∏ confidence
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 8124731874: 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 139883458: 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã** (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ):
- ‚ö†Ô∏è Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø—É—Å—Ç—ã–µ (0 —Ç–æ—á–µ–∫) - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- ‚ö†Ô∏è GigaChat Proxy –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 307 (Temporary Redirect)
- ‚ö†Ô∏è Intent Classifier –æ—à–∏–±–∫–∞: `'str' object has no attribute 'messages'`
- ‚ö†Ô∏è Neo4j event loop –ø—Ä–æ–±–ª–µ–º—ã (–≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ backlog (868 —Å–æ–±—ã—Ç–∏–π)
- –ü–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ RAG –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ RAG –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç**

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `rag_query_history`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤—Å–µ –ø–æ–ª—è: `query_text`, `intent`, `confidence`, `response_text`, `sources_count`, `processing_time_ms`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (error case)

**–ü—Ä–∏–º–µ—Ä—ã**:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 8124731874:
  1. "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö?" - Intent: search, Confidence: 0.00, Time: 325ms
  2. "–ù–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π" - Intent: search, Confidence: 0.20, Time: 200ms

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 139883458:
  1. "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö?" - Intent: search, Confidence: 0.00, Time: 173ms
  2. "–ù–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π" - Intent: search, Confidence: 0.20, Time: 150ms
```

---

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤

**–°—Ç–∞—Ç—É—Å**: ‚è≥ **–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `generate_digest_for_user()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä—ã
- ‚ö†Ô∏è –î–∞–π–¥–∂–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å)

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚ö†Ô∏è –ù–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Ñ—É–Ω–∫—Ü–∏–∏
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é

---

### 4. –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å**: ‚è≥ **–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏**

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- ‚úÖ `TELEGRAM_BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ `settings.telegram_bot_token` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚ö†Ô∏è –ë–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ runtime (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å `init_bot()`)

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ö†Ô∏è `bot` –æ–±—ä–µ–∫—Ç `None` –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
- ‚ö†Ô∏è `init_bot()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `lifespan`, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `init_bot()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –±–æ—Ç–∞

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 8124731874
- **RAG –∑–∞–ø—Ä–æ—Å—ã**: ‚úÖ 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏
- **–î–∞–π–¥–∂–µ—Å—Ç—ã**: ‚è≥ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–¢—Ä–µ–Ω–¥—ã**: ‚è≥ –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å
- **–ë–æ—Ç**: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 139883458
- **RAG –∑–∞–ø—Ä–æ—Å—ã**: ‚úÖ 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏
- **–î–∞–π–¥–∂–µ—Å—Ç—ã**: ‚è≥ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–¢—Ä–µ–Ω–¥—ã**: ‚è≥ –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å
- **–ë–æ—Ç**: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ RAG –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é
2. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ RAG (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
3. ‚úÖ Neo4j –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
4. ‚úÖ Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã

---

## ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è

1. **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è** - 868 —Å–æ–±—ã—Ç–∏–π –≤ backlog, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
2. **Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø—É—Å—Ç—ã–µ** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
3. **–î–∞–π–¥–∂–µ—Å—Ç—ã** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
4. **–ë–æ—Ç** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
5. **GigaChat Proxy** - –æ—à–∏–±–∫–∞ 307 (Temporary Redirect)
6. **Intent Classifier** - –æ—à–∏–±–∫–∞ —Å `messages` attribute

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤** - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É backlog
4. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RAG** - –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ RAG –∏—Å—Ç–æ—Ä–∏–∏
```bash
docker compose exec api python3 << 'PYTHON'
from models.database import get_db, User, RAGQueryHistory
from sqlalchemy import desc
db = next(get_db())
user = db.query(User).filter(User.telegram_id == '8124731874').first()
if user:
    queries = db.query(RAGQueryHistory).filter(
        RAGQueryHistory.user_id == user.id
    ).order_by(desc(RAGQueryHistory.created_at)).limit(5).all()
    print(f"–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {len(queries)}")
    for q in queries:
        print(f"  - {q.query_text}: {q.intent} ({q.confidence:.2f})")
PYTHON
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
```bash
docker compose exec redis redis-cli XLEN stream:posts:enriched
docker compose exec worker python3 -c "
from qdrant_client import QdrantClient
client = QdrantClient(url='http://qdrant:6333')
for name in ['t6bf3422f-456f-4c41-a7f8-c86861c328c9_posts', 'te70c43b0-e11d-45a8-8e51-f0ead91fb126_posts']:
    try:
        info = client.get_collection(name)
        print(f'{name}: {info.points_count} —Ç–æ—á–µ–∫')
    except:
        print(f'{name}: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞
```bash
docker compose exec api python3 << 'PYTHON'
from bot.webhook import bot
if bot:
    print("‚úÖ –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    try:
        info = bot.get_me()
        print(f"Bot: {info.username} (ID: {info.id})")
    except:
        print("‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å info")
else:
    print("‚ùå –ë–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
PYTHON
```

