# –û—Ç—á—ë—Ç –æ–± –∞—É–¥–∏—Ç–µ: Vision + S3 + Crawl4ai Integration

**–î–∞—Ç–∞**: 2025-01-30  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–°—Ç–∞—Ç—É—Å**: –ê—É–¥–∏—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü—Ä–æ–≤–µ–¥—ë–Ω –∞—É–¥–∏—Ç –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:
- Vision –∞–Ω–∞–ª–∏–∑ (GigaChat Vision API + OCR fallback)
- S3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Cloud.ru, content-addressed storage)
- Crawl4ai –æ–±–æ–≥–∞—â–µ–Ω–∏–µ (—Å S3 –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î: `media_objects`, `post_media_map`, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `post_enrichment`

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å—Ö–µ–º—ã `post_enrichment` —Å –ø–æ–ª–µ–º `kind`

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT (post_id, kind)`, –Ω–æ:
  - –ú–æ–¥–µ–ª–∏ ORM (`api/models/database.py`, `worker/shared/database.py`) **–ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç** –ø–æ–ª–µ `kind`
  - –í –º–∏–≥—Ä–∞—Ü–∏–∏ `20250128_add_media_registry_vision.py` –ø–æ–ª–µ `kind` **–ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è**
  - –¢–µ—Å—Ç `test_tag_persistence.py:196` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ `kind`, —á—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—è

**–ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `(post_id, kind)`**:
- `crawl4ai/crawl4ai_service.py:364` ‚Äî `ON CONFLICT (post_id, kind)`
- `worker/tasks/tag_persistence_task.py:366` ‚Äî `ON CONFLICT (post_id, kind)`

**–†–∏—Å–∫**: 
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQL: `unique constraint violation` –∏–ª–∏ `column does not exist`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–¥—É–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–æ–≥–∞—â–µ–Ω–∏–π (tags, crawl, vision)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: 
- –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è `kind TEXT DEFAULT 'tags'` –≤ `post_enrichment`
- –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `UNIQUE (post_id, kind)`
- –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ ORM –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—è `kind`

### 2. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–ø–æ—Å–æ–±–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ `post_enrichment`

**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç-—Ç–∞—Ä–≥–µ—Ç—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ö–æ–Ω—Ñ–ª–∏–∫—Ç-—Ç–∞—Ä–≥–µ—Ç | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-----------|----------------|-----------|
| `worker/tasks/vision_analysis_task.py:457` | `ON CONFLICT (post_id)` | –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—é –∑–∞–ø–∏—Å—å |
| `crawl4ai/crawl4ai_service.py:364` | `ON CONFLICT (post_id, kind)` | –ú–æ–¥—É–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ |
| `worker/tasks/tag_persistence_task.py:366` | `ON CONFLICT (post_id, kind)` | –ú–æ–¥—É–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ |
| `worker/tasks/enrichment_task.py:763` | `UPDATE ... WHERE post_id` | –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å |

**–†–∏—Å–∫**: 
- Vision –∞–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç crawl4ai –∏ tags
- –ü–æ—Ç–µ—Ä—è –æ–±–æ–≥–∞—â–µ–Ω–∏–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `(post_id, kind)`
- –ò–∑–º–µ–Ω–∏—Ç—å `vision_analysis_task.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `kind='vision'`
- –ò–∑–º–µ–Ω–∏—Ç—å `enrichment_task.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `kind` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ UPDATE

### 3. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –¢–∞–±–ª–∏—Ü—ã `post_forwards`, `post_reactions`, `post_replies` –ù–ï –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: 
–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –≤ —Å—Ö–µ–º–∞—Ö (`api/models/database.py`, `worker/shared/database.py`), –Ω–æ:
- **–ù–µ—Ç INSERT –∑–∞–ø—Ä–æ—Å–æ–≤** –Ω–∏–≥–¥–µ –≤ –∫–æ–¥–µ
- –î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π (counters), –Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –í `posts` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—á—ë—Ç—á–∏–∫–∏: `forwards_count`, `reactions_count`, `replies_count`

**–ú–µ—Å—Ç–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**:
- `telethon-ingest/services/telegram_client.py:604` ‚Äî `forwards_count` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è
- `telethon-ingest/services/telegram_client.py:606` ‚Äî `reactions` –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è, –Ω–æ —Ç–æ–ª—å–∫–æ count
- `telethon-ingest/services/telegram_client.py:612` ‚Äî `replies` –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è, –Ω–æ —Ç–æ–ª—å–∫–æ count
- `telethon-ingest/services/channel_parser.py:965-967` ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: "–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π"

**–†–∏—Å–∫**:
- –ü–æ—Ç–µ—Ä—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ forwards/reactions/replies
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π forwards –≤ `post_forwards`
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π reactions –≤ `post_reactions`
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π replies –≤ `post_replies`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Context7 best practices –¥–ª—è batch insert –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

### 4. ‚ö†Ô∏è –í–´–°–û–ö–ò–ô: –ú–µ–¥–∏–∞-–¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ `media_objects` –∏ `post_media_map`

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- `telethon-ingest/services/media_processor.py` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ–¥–∏–∞ –≤ S3, –Ω–æ:
  - **–ù–µ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏** –≤ `media_objects`
  - **–ù–µ —Å–æ–∑–¥–∞—ë—Ç —Å–≤—è–∑–∏** –≤ `post_media_map`
- –¢–∞–±–ª–∏—Ü—ã `post_media_map` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è SELECT (–ø–æ–¥—Å—á—ë—Ç –º–µ–¥–∏–∞)
- Legacy —Ç–∞–±–ª–∏—Ü–∞ `post_media` —Ç–æ–∂–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è

**–ú–µ—Å—Ç–∞, –≥–¥–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞**:
- `telethon-ingest/services/media_processor.py:_upload_to_s3` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –∑–∞–ø–∏—Å–∏: `media_objects` (–ø–æ SHA256) –∏ `post_media_map` (—Å–≤—è–∑—å post ‚Üî media)

**–†–∏—Å–∫**:
- –ù–∞—Ä—É—à–µ–Ω–∏–µ content-addressed storage –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ (refs_count)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (S3 keys –≤ `post_enrichment.s3_media_keys` vs `media_objects`)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `media_objects` –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–¥–∏–∞ –≤ S3
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `post_media_map` –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –º–µ–¥–∏–∞ –∫ –ø–æ—Å—Ç—É
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±–Ω–æ–≤–∏—Ç—å `s3_media_keys` –≤ `post_enrichment` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π

### 5. ‚ö†Ô∏è –í–´–°–û–ö–ò–ô: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ OCR/Vision –ø–æ–ª–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –°—É—â–µ—Å—Ç–≤—É—é—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–æ–ª—è:

| Legacy –ø–æ–ª–µ | –ù–æ–≤–æ–µ –ø–æ–ª–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|-------------|------------|---------------|
| `ocr_text` | `vision_ocr_text` | –û–±–∞ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ—è—Å–Ω–æ |
| `vision_labels` | `vision_classification` | `vision_labels` –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ legacy, –Ω–æ –≤—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |

**–ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
- `crawl4ai/crawl4ai_service.py:347` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `ocr_text` –∏ `vision_labels`
- `worker/tasks/vision_analysis_task.py:430` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `vision_ocr_text` –∏ `vision_classification`

**–†–∏—Å–∫**:
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –ª–æ–≥–∏–∫–µ —á—Ç–µ–Ω–∏—è
- –í–æ–∑–º–æ–∂–Ω–∞—è –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å clear migration path: legacy ‚Üí –Ω–æ–≤—ã–µ –ø–æ–ª—è
- –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–æ–ª–µ–π
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–ø—Ä–µ–∫–∞—Ü–∏—é legacy –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–æ–±–ª–µ–º—ã —Å—Ä–µ–¥–Ω–µ–π –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏

### 6. ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è `kind` –≤ `post_enrichment`

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ `kind` –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω, –Ω—É–∂–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ `WHERE post_id = ? AND kind = ?`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å `(post_id, kind)` (—á–∞—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ constraint)

### 7. ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ foreign key constraints –¥–ª—è `post_forwards`, `post_reactions`, `post_replies`

**–ü—Ä–æ–±–ª–µ–º–∞**: –í –º–æ–¥–µ–ª—è—Ö –µ—Å—Ç—å FK, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ `ON DELETE` –¥–µ–π—Å—Ç–≤–∏—è–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å `ON DELETE CASCADE` –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

## SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—è `kind`

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ª—è kind –≤ post_enrichment
SELECT column_name, data_type, column_default, is_nullable
FROM information_schema.columns
WHERE table_name = 'post_enrichment'
AND column_name = 'kind';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ (post_id, kind)
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'post_enrichment'
AND indexname LIKE '%kind%';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è post_forwards
SELECT 
    COUNT(*) as total_forwards,
    COUNT(DISTINCT post_id) as posts_with_forwards
FROM post_forwards;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è post_reactions
SELECT 
    COUNT(*) as total_reactions,
    COUNT(DISTINCT post_id) as posts_with_reactions
FROM post_reactions;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è post_replies
SELECT 
    COUNT(*) as total_replies,
    COUNT(DISTINCT post_id) as posts_with_replies
FROM post_replies;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è media_objects
SELECT 
    COUNT(*) as total_media_objects,
    SUM(refs_count) as total_refs
FROM media_objects;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è post_media_map
SELECT 
    COUNT(*) as total_media_links,
    COUNT(DISTINCT post_id) as posts_with_media,
    COUNT(DISTINCT file_sha256) as unique_media_files
FROM post_media_map;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ legacy post_media
SELECT 
    COUNT(*) as total_legacy_media
FROM post_media;
```

### –ü–æ–∏—Å–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ post_enrichment (–µ—Å–ª–∏ kind —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
SELECT post_id, COUNT(*) as enrichment_count
FROM post_enrichment
GROUP BY post_id
HAVING COUNT(*) > 1;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è legacy vs –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
SELECT 
    COUNT(*) as total_records,
    COUNT(ocr_text) as has_ocr_text,
    COUNT(vision_ocr_text) as has_vision_ocr_text,
    COUNT(vision_labels) as has_vision_labels,
    COUNT(vision_classification) as has_vision_classification
FROM post_enrichment;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ orphaned –∑–∞–ø–∏—Å–µ–π –≤ post_media_map (–º–µ–¥–∏–∞ –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ media_objects)
SELECT pmm.post_id, pmm.file_sha256
FROM post_media_map pmm
LEFT JOIN media_objects mo ON pmm.file_sha256 = mo.file_sha256
WHERE mo.file_sha256 IS NULL;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–æ–≤ —Å –º–µ–¥–∏–∞, –Ω–æ –±–µ–∑ –∑–∞–ø–∏—Å–µ–π –≤ post_media_map
SELECT p.id, p.has_media
FROM posts p
WHERE p.has_media = true
AND NOT EXISTS (
    SELECT 1 FROM post_media_map pmm WHERE pmm.post_id = p.id
);
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É)

1. **–î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—è `kind` –≤ `post_enrichment`**
   - –§–∞–π–ª: `api/alembic/versions/YYYYMMDD_add_kind_to_post_enrichment.py`
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `kind TEXT DEFAULT 'tags'`
   - –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint `UNIQUE (post_id, kind)`
   - –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ ORM

2. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç-—Ç–∞—Ä–≥–µ—Ç—ã –≤ `post_enrichment`**
   - –ò–∑–º–µ–Ω–∏—Ç—å `vision_analysis_task.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `kind='vision'`
   - –ò–∑–º–µ–Ω–∏—Ç—å `enrichment_task.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `kind='crawl'` (–∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö)

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `media_objects` –∏ `post_media_map`**
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –≤ `media_processor.py` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
   - –û–±–Ω–æ–≤–∏—Ç—å `refs_count` –≤ `media_objects`

4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `post_forwards`, `post_reactions`, `post_replies`**
   - –î–æ–±–∞–≤–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏–∑ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
   - –î–æ–±–∞–≤–∏—Ç—å batch insert —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Context7 best practices

5. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å legacy –ø–æ–ª—è OCR/Vision**
   - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å clear migration path
   - –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
   - –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

6. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å foreign key constraints
8. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### 8. ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ S3

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å Context7 best practices

**–ù–∞—Ö–æ–¥–∫–∏**:
- `api/services/s3_storage.py` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Cloud.ru —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (500 –≤–º–µ—Å—Ç–æ 404 –Ω–∞ HEAD)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç request IDs –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- Quota –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å emergency cleanup

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LRUEvictionService (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

### 9. ‚úÖ –•–û–†–û–®–û: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å Vision –∞–Ω–∞–ª–∏–∑–∞

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ù–∞—Ö–æ–¥–∫–∏**:
- Redis-based –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ SHA256 + dedupe keys
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ idempotency cache

### 10. ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ media_objects

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ `media_processor.py` –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `media_objects`, –Ω—É–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —Å S3 –∑–∞–≥—Ä—É–∑–∫–æ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Saga pattern)

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª—ã |
|---|----------|-------------|--------|-------|
| 1 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—è `kind` –≤ `post_enrichment` | ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï | –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –ú–æ–¥–µ–ª–∏, –º–∏–≥—Ä–∞—Ü–∏–∏ |
| 2 | –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç-—Ç–∞—Ä–≥–µ—Ç–æ–≤ –≤ `post_enrichment` | ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï | –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | vision_analysis_task, enrichment_task |
| 3 | –¢–∞–±–ª–∏—Ü—ã forwards/reactions/replies –Ω–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è | ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï | –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | telegram_client, channel_parser |
| 4 | `media_objects` –∏ `post_media_map` –Ω–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è | ‚ö†Ô∏è –í–´–°–û–ö–ò–ô | –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | media_processor |
| 5 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ OCR/Vision –ø–æ–ª–µ–π | ‚ö†Ô∏è –í–´–°–û–ö–ò–ô | –¢—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ | –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã |
| 6 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è `kind` | ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #1 | –ú–∏–≥—Ä–∞—Ü–∏–∏ |
| 7 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ FK constraints –ø—Ä–æ–≤–µ—Ä–∫–∏ | ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô | –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | –ú–∏–≥—Ä–∞—Ü–∏–∏ |
| 8 | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ S3 | ‚úÖ –û–ö | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | s3_storage |
| 9 | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å Vision | ‚úÖ –û–ö | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | vision_analysis_task |
| 10 | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è media_objects | ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô | –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ | media_processor |

## Next Steps

1. üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è `kind` –≤ `post_enrichment`
2. üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç-—Ç–∞—Ä–≥–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `(post_id, kind)` –≤–µ–∑–¥–µ)
3. üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `post_forwards`, `post_reactions`, `post_replies`
4. üü° –í–´–°–û–ö–ò–ô: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `media_objects` / `post_media_map`
5. üü° –í–´–°–û–ö–ò–ô: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å migration path –¥–ª—è legacy –ø–æ–ª–µ–π OCR/Vision
6. üü¢ –°–†–ï–î–ù–ò–ô: –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –∏ constraints
7. üü¢ –°–†–ï–î–ù–ò–ô: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏

- `api/models/database.py`
- `worker/shared/database.py`
- `api/alembic/versions/*.py`
- `telethon-ingest/services/media_processor.py`
- `telethon-ingest/services/telegram_client.py`
- `worker/tasks/vision_analysis_task.py`
- `crawl4ai/crawl4ai_service.py`
- `worker/tasks/tag_persistence_task.py`

