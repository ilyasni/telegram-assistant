# ADR: Поддержка Telegram-групп и мультиагентных дайджестов

- **Статус:** Accepted
- **Дата:** 2025-11-09
- **Связанные документы:** `docs/ARCHITECTURE_PRINCIPLES.md`, `docs/OLD_SYSTEM_PIPELINE.md`, `docs/OLD_SYSTEM_SPECIFICATION.md`, план `group-f09746`
- **Контекст:** переход на архитектуру без локальных GPU с приоритетом GigaChat/gigachain и Context7

## 1. Контекст

1. Пользователи должны подключать Telegram-группы наряду с каналами. Для каждого арендатора требуется изолированный набор групп (multi-tenant по `tenant_id`), соответствующий описанному пайплайну в старой версии (`OLD_SYSTEM_PIPELINE.md`, разделы 1.2 и 2.1).
2. По запросу пользователя необходимо формировать дайджест активности группы за окна 4/6/12/24 часа с метриками как в примерном формате (темы, приоритеты, тональность, активные участники).
3. Аналитика должна выполняться мультиагентной системой (LangGraph) с проверкой качества ответов (RAGAS, LangSmith trajectory evaluators). Приоритет — безопасность, наблюдаемость, мультиарендность (`ARCHITECTURE_PRINCIPLES.md`, `06-evaluation-llmops.mdc`).
4. В инфраструктуре отсутствуют GPU. Все LLM/embedding/vision-функции реализуются через облачные модели GigaChat с использованием `ai-forever/gigachain` и смежных SDK, а также best practices Context7 [`docs/CONTEXT7_BEST_PRACTICES.md`].
5. Нужно переиспользовать рабочие наработки старой сборки (`t-bot-for-channels`, ветка `test-cleanup-fresh`) — в частности: сценарии авторизации, управление группами, логика дайджестов и fallback-процессы (см. `OLD_SYSTEM_SPECIFICATION.md`, разделы 3.1–3.7, 7.1–7.6).

## 2. Решение

1. **Доменные расширения.**
   - Добавляем сущности `group`, `group_member`, `group_message`, `group_digest_window`. Все сущности содержат `tenant_id` и соблюдают RLS Supabase.
   - Обновляем события (`MessageCreated`, `ConversationWindowReady`, `DigestGenerated`) с расширенным payload: `group_id`, список участников, метрики окна. Расписываем JSON Schema в `api/contracts`.
   - Расширяем Qdrant коллекции: `user_{tenant}_groups` с доп. payload (`participants`, `topic_embedding`, `sentiment_vector`).

2. **Инжест.**
   - Telethon-ingest сервис получает права на чтение групп, хранит сессии per tenant. Пайплайн идентичен канальному: подписка → event bus → LangGraph orchestrator.
   - FloodWait/backoff и лимиты берём из старой сборки (см. `OLD_SYSTEM_PIPELINE.md`, раздел 2.1) с адаптацией к группам (history limit, медиа).

3. **Мультиагентный анализ.**
   - Используем LangGraph orchestrator (координатор + агенты: тематическая кластеризация, эмоции, социальные роли, риск-флаги).
   - Все LLM-вызовы — через GigaChat (`gigachain`), промпты и параметры регистрируются в Context7 (для трассировки и аудита).
   - Контроль качества: RAGAS + LangSmith trajectory evaluators (LLM-as-judge, match). Семплирование ≥10% запросов; результаты в Prometheus/Grafana.

4. **Генерация и доставка дайджестов.**
   - Планировщик формирует окна 4/6/12/24 ч. Дайджест строится из результатов агентов, шаблоны Markdown/JSON задаются в `docs/examples/group_digest.md`.
   - Доставка: Telegram-бот, e-mail/webhooks (по настройкам). Результаты и источники логируются (структурированные логи, traces).
   - Версионирование дайджестов и ручной пересчёт поддерживаются через Admin Mini App.

5. **Контроль стоимости и наблюдаемость.**
   - Ограничения по запросам и стоимости GigaChat: лимиты per tenant, мониторинг token usage, circuit breaker при деградации.
   - Prometheus метрики: `group_ingest_messages_total`, `group_digest_generation_seconds`, `gigachat_requests_total` и др.
   - Алерты при падении RAGAS < 0.7, росте latency или стоимости.

## 3. Альтернативы

1. Использование локальных моделей (Ollama, open-source LLM) — отклонено: нет GPU, нарушает требования безопасности/стоимости.
2. Использование сторонних мультиагентных платформ (Flowise, n8n) — отклонено: не соответствует архитектурным принципам новой версии (минимальная инфраструктура, LangGraph-first).
3. Плоский дайджест без агентов и авто-оценки — отклонено: не покрывает требования по качеству и аналитическим метрикам.

## 4. Последствия

### Положительные

- Единый стек (GigaChat + gigachain + LangGraph + Context7) упрощает сопровождение и аудит.
- Репликация проверенных сценариев из старой сборки снижает риски регрессий.
- Мультиагентная архитектура позволяет добавлять новые типы анализа (мультимодальность, графовые инсайты).
- Жёсткая наблюдаемость и авто-оценка обеспечивают SLA и безопасность.

### Отрицательные

- Стоимость GigaChat вызовов возрастёт — требуется лимитирование, кэш и приоритизация.
- Усложняется управление секретами (аккаунты Telethon для групп, ключи GigaChat).
- Высокие требования к тестовому покрытию и мониторингу (нагрузка на команду DevOps).

### Риски и меры

| Риск | Митигирующая мера |
|------|-------------------|
| Деградация качества из-за изменений промптов | Версионирование промптов в Context7, A/B тесты, rollback |
| Превышение квот GigaChat | Circuit breaker, батчинг, кэширование эмбеддингов |
| Ошибки маппинга групп ↔ пользователей | RLS, автоматические проверки `tenant_id`, e2e тесты |
| Латентность digest-пайплайна | Асинхронные воркеры, инкрементальная обработка, ограничение окна |

## 5. Шаги реализации (Roadmap)

1. Консолидация требований, обновление ADR (настоящий документ).
2. Фаза 1–7 из плана `group-f09746`.
3. Регулярный аудит Context7 + gigachain зависимостей (ежемесячно).

## 6. Открытые вопросы — решения

1. **Политика хранения медиа.** Да, медиа из групп обязательно анализируются: все вложения (изображения, видео, голосовые) выгружаются в S3/MinIO с теми же правилами, что и канальные медиа, и проходят через Vision/Audio пайплайны для тегирования и тонального анализа.
2. **Интеграция с Neo4j.** Да, требуется уже в MVP — граф будет фиксировать связи между участниками и темами (подготовка к функции «портрет собеседника»). GroupDigestService передаёт события в `GraphService`, формируя узлы `Participant`/`Conversation` и ребра «участие», «упоминание».
3. **Голос/видео.** Да, дайджесты должны учитывать голосовые и видеосообщения. Транскрибация голосовых через SaluteSpeech (имеющийся пайплайн), извлечение ключевых кадров/описаний для видео через Vision сервис; результаты попадают в `group_message_analytics` и учитываются агентами.


