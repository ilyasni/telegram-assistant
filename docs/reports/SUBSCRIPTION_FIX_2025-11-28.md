# Исправление проблемы сохранения постов: subscription_inactive

**Дата**: 2025-11-28  
**Context7**: Исправление блокировки сохранения постов из-за проверки подписки

---

## Проблема

### Симптомы:
- Посты парсятся, но не сохраняются в БД
- В логах: `Atomic batch save failed` с ошибками `subscription_inactive` и `user_not_subscribed`
- `messages_processed: 0` для всех каналов
- Последний пост в БД: 2025-11-26 20:55:25 (2 дня назад)

### Причина:
`AtomicDBSaver` проверяет активную подписку пользователя на канал перед сохранением постов. Если подписка отсутствует или неактивна, посты не сохраняются.

**Проблема для системного парсинга (scheduler):**
- Scheduler использует системного пользователя (105957884) для парсинга всех активных каналов
- Не все каналы имеют активную подписку для этого пользователя
- Посты парсятся, но не сохраняются из-за отсутствия подписки

---

## Решение

### Context7 Best Practice:
Для системного парсинга (scheduler) автоматически создавать/активировать подписку для активных каналов.

### Изменения:

**Файл**: `telethon-ingest/services/atomic_db_saver.py` (строки 209-245)

**Было:**
```python
# Проверка подписки - если нет или неактивна, блокируем сохранение
if not subscription_row:
    return False, "user_not_subscribed", 0
if not subscription_row.is_active:
    return False, "subscription_inactive", 0
```

**Стало:**
```python
# Если подписки нет или она неактивна - проверяем, можно ли создать/активировать
if not subscription_row or not subscription_row.is_active:
    # Проверяем, активен ли канал (для системного парсинга)
    channel_check = await db_session.execute(...)
    
    if channel_row and channel_row.is_active:
        # Канал активен - создаем/активируем подписку для системного парсинга
        INSERT INTO user_channel ... ON CONFLICT DO UPDATE SET is_active = true
```

### Логика:
1. Проверяем наличие и активность подписки
2. Если подписки нет или она неактивна:
   - Проверяем, активен ли канал (`is_active = true`)
   - Если канал активен → автоматически создаем/активируем подписку
   - Если канал неактивен → блокируем сохранение (как раньше)

---

## Результат

### Ожидаемое поведение:
- ✅ Посты сохраняются для активных каналов при системном парсинге
- ✅ Подписки автоматически создаются/активируются для активных каналов
- ✅ Неактивные каналы по-прежнему требуют явной подписки
- ✅ Логирование создания/активации подписок для мониторинга

### Проверка:
```bash
# Проверить логи после перезапуска
docker logs telegram-assistant-telethon-ingest-1 --tail 50 | grep -i "created.*activated.*subscription\|messages_processed"

# Проверить новые посты в БД
docker exec telegram-assistant-supabase-db-1 psql -U postgres -d postgres -c "SELECT COUNT(*), MAX(posted_at) FROM posts;"
```

---

## Impact / Rollback

### Impact:
- ✅ Системный парсинг теперь работает для всех активных каналов
- ✅ Автоматическое создание подписок только для активных каналов
- ✅ Не влияет на пользовательские подписки (создаются через API)

### Rollback:
Если нужно откатить:
1. Вернуть проверку подписки без автоматического создания
2. Вручную создать подписки для нужных каналов через API

---

## Связанные проблемы

- `SCHEDULER_PIPELINE_CHECK_2025-11-28.md` - первоначальная диагностика
- `channel_subscription_fix.md` - удаление автоматического создания подписок (для пользовательского парсинга)
- `auto_subscription_issue.md` - проблема автоматического создания подписок

**Важно**: Это исправление применяется только для системного парсинга (scheduler). Пользовательский парсинг по-прежнему требует явной подписки.

