# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤

## –°—Ç–∞—Ç—É—Å: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ –ø–ª–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ Context7 best practices.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚úÖ

**1.1. –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤**
- –§–∞–π–ª: `telethon-ingest/services/channel_parser.py`
- –§—É–Ω–∫—Ü–∏—è: `_calculate_interarrival_stats()`
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
  - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Redis –∫–µ—à (TTL 1 —á–∞—Å) + PostgreSQL –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
  - SQL —Å LAG window function –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
  - –†–∞—Å—á–µ—Ç median, p95, EWMA
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

**1.2. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥**
- –§–∞–π–ª: `telethon-ingest/services/channel_parser.py`
- –§—É–Ω–∫—Ü–∏—è: `_compute_adaptive_threshold()`
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
  - –ë–∞–∑–æ–≤—ã–π –ø–æ—Ä–æ–≥: `clamp(p95 * 1.5, 30m, 12h)`
  - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ —á–∞—Å—É –¥–Ω—è (–Ω–æ—á—å 1.5x, –¥–µ–Ω—å 1.0x)
  - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏ (–≤—ã—Ö–æ–¥–Ω—ã–µ 1.8x, –±—É–¥–Ω–∏ 1.0x)
  - –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 24 —á–∞—Å–æ–≤
  - Fallback –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö

**1.3. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π overlap**
- –§–∞–π–ª: `telethon-ingest/services/channel_parser.py`
- –û–±–Ω–æ–≤–ª–µ–Ω: `_get_since_date()`
- –õ–æ–≥–∏–∫–∞: `overlap = clamp(p95 * 0.5, 2m, 10m)` –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 5 –º–∏–Ω—É—Ç

### –§–∞–∑–∞ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ gap –∏ watermarks ‚úÖ

**2.1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è gap**
- –û–±–Ω–æ–≤–ª–µ–Ω—ã: `_monitor_missing_posts()` –∏ `_check_and_trigger_backfill()`
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ: `gap_seconds = max(0, (now - last_post_date).total_seconds())` - –≤—Å–µ–≥–¥–∞ >= 0
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `if gap_seconds > threshold_seconds` (–±–µ–∑ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)

**2.2. High/Low Watermarks**
- –§—É–Ω–∫—Ü–∏–∏:
  - `_get_high_watermark()` - MAX(posted_at) –∏–∑ –ë–î
  - `_get_low_watermark()` - –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π since_date (Redis)
  - `_update_low_watermark()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ backfill
- –•—Ä–∞–Ω–µ–Ω–∏–µ: Redis —Å TTL 24 —á–∞—Å–∞

**2.3. Quiet hours**
- –§—É–Ω–∫—Ü–∏—è: `_is_quiet_hours()`
- –õ–æ–≥–∏–∫–∞:
  - –í—ã—Ö–æ–¥–Ω—ã–µ (weekday >= 5) ‚Üí `(True, "weekend")`
  - –ù–æ—á—å (22:00-08:00 MSK) ‚Üí `(True, "night_hours")`
  - –ò–Ω–∞—á–µ ‚Üí `(False, "normal")`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –≤ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º –ø–æ—Ä–æ–≥–µ

### –§–∞–∑–∞ 3: Locking –∏ idempotency ‚úÖ

**3.1. Redis lock –¥–ª—è backfill**
- –ö–ª—é—á: `lock:backfill:{channel_id}`
- –ú–µ—Ç–æ–¥: `SET NX EX 3600` (1 —á–∞—Å TTL)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–ª–∏ TTL

**3.2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è**
- –ö–ª—é—á: `backfill_job:{channel_id}:{window_start_rounded}`
- –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 10 –º–∏–Ω—É—Ç –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- TTL 24 —á–∞—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º backfill

### –§–∞–∑–∞ 4: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ‚úÖ

**–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `channel_last_post_timestamp_seconds{channel_id}` - Gauge (MAX(posted_at) –≤ epoch)
- `parser_last_success_seconds{channel_id}` - Gauge (–ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
- `adaptive_threshold_seconds{channel_id}` - Gauge (—Ç–µ–∫—É—â–∏–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥)
- `channel_gap_seconds{channel_id}` - Gauge (—Ç–µ–∫—É—â–∏–π gap = now - last_post)
- `backfill_jobs_total{channel_id, status}` - Counter (enqueued, completed, failed)
- `interarrival_seconds{channel_id}` - Histogram (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏)

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `posts_missing_duration_seconds` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –û—Å–Ω–æ–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞: `channel_gap_seconds` (–≤—Å–µ–≥–¥–∞ >= 0)

### –§–∞–∑–∞ 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ

**5.1. –û–±–Ω–æ–≤–ª–µ–Ω `_monitor_missing_posts()`**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥ –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ 1 —á–∞—Å–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞
- –£—á–∏—Ç—ã–≤–∞–µ—Ç quiet hours –≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

**5.2. –û–±–Ω–æ–≤–ª–µ–Ω `_check_and_trigger_backfill()`**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥
- Redis lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- Idempotency –ø—Ä–æ–≤–µ—Ä–∫–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ low watermark –ø–æ—Å–ª–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è backfill
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

**5.3. –û–±–Ω–æ–≤–ª–µ–Ω `_get_since_date()`**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π overlap
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤
FEATURE_ADAPTIVE_THRESHOLDS_ENABLED=true

# –ü–µ—Ä–∏–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14 –¥–Ω–µ–π)
PARSER_STATS_WINDOW_DAYS=14
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis

```
interarrival_stats:{channel_id} -> JSON
  TTL: 3600 (1 —á–∞—Å)

low_watermark:{channel_id} -> ISO datetime
  TTL: 86400 (24 —á–∞—Å–∞)

lock:backfill:{channel_id} -> instance_id
  TTL: 3600 (1 —á–∞—Å)

backfill_job:{channel_id}:{window_start} -> "1"
  TTL: 86400 (24 —á–∞—Å–∞)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ù–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π** –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ/–Ω–æ—á–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –ø–æ—Ä–æ–≥–∞–º
2. **–ö–∞–Ω–∞–ª-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ—Ä–æ–≥–∏** –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: locking –∏ idempotency –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
4. **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å**: —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Redis –∫–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
docker compose logs telethon-ingest | grep "interarrival stats"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
docker compose logs telethon-ingest | grep "adaptive threshold"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
curl http://localhost:9090/metrics | grep "channel_gap_seconds\|adaptive_threshold"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ quiet hours

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ/–Ω–æ—á–∏
docker compose logs telethon-ingest | grep "quiet\|weekend\|night_hours"
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
2. üîÑ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å telethon-ingest
3. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus/Grafana
4. üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ `channel_gap_seconds` –∏ `adaptive_threshold_seconds`

## –û—Ç–∫–∞—Ç

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑:
```bash
FEATURE_ADAPTIVE_THRESHOLDS_ENABLED=false
```

–ü—Ä–∏ –æ—Ç–∫–∞—Ç–µ —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω–µ—Ç—Å—è –∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ—Ä–æ–≥–∞–º (1 —á–∞—Å) —Å –±–∞–∑–æ–≤—ã–º overlap (5 –º–∏–Ω—É—Ç).

