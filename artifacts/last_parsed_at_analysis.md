# üìä –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –õ–û–ì–ò–ö–ò last_parsed_at

## ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

- `PARSER_INCREMENTAL_MINUTES`: 5 –º–∏–Ω—É—Ç
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback, –∫–æ–≥–¥–∞ –Ω–µ—Ç `last_parsed_at`
  - –ù–ï –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –ø–∞—Ä—Å–∏–Ω–≥–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
  
- `PARSER_LPA_MAX_AGE_HOURS`: 48 —á–∞—Å–æ–≤
  - Safeguard: –µ—Å–ª–∏ `last_parsed_at` —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤ ‚Üí —Ñ–æ—Ä—Å–∏–º historical —Ä–µ–∂–∏–º
  
- `PARSER_MODE_OVERRIDE`: auto
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ `last_parsed_at`

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ last_parsed_at

### 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê –ü–ê–†–°–ò–ù–ì–ê (`_decide_mode`)

```python
if last_parsed_at is None:
    ‚Üí historical —Ä–µ–∂–∏–º
elif age(last_parsed_at) > 48 hours:
    ‚Üí historical —Ä–µ–∂–∏–º (safeguard)
else:
    ‚Üí incremental —Ä–µ–∂–∏–º
```

### 2. –í–´–ß–ò–°–õ–ï–ù–ò–ï since_date (`_get_since_date`)

**Historical —Ä–µ–∂–∏–º:**
- `since_date = now - 24 hours`

**Incremental —Ä–µ–∂–∏–º:**
- –ï—Å–ª–∏ –µ—Å—Ç—å `last_parsed_at`:
  - ‚úÖ `since_date = last_parsed_at` (–ò–°–ü–†–ê–í–õ–ï–ù–û)
  - ‚ùå –ë–´–õ–û: `since_date = max(last_parsed_at, now - 5 min)` ‚Üí –ø—Ä–æ–ø—É—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ï—Å–ª–∏ –Ω–µ—Ç `last_parsed_at` (fallback):
  - `since_date = now - 5 minutes`

**Safeguard:**
- –ï—Å–ª–∏ `last_parsed_at` > 48 —á–∞—Å–æ–≤:
  - –§–æ—Ä—Å–∏–º historical: `since_date = now - 24 hours`

### 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï –ü–ê–†–°–ò–ù–ì–ê (`_update_last_parsed_at`)

**–ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
- ‚úÖ –í–°–ï–ì–î–ê –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ 0 —Å–æ–æ–±—â–µ–Ω–∏–π)
- ‚úÖ –ü–æ—Å–ª–µ cooldown skip (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫)

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```python
UPDATE channels SET last_parsed_at = NOW() WHERE id = channel_id
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
- –£–¥–∞–ª—è–µ—Ç—Å—è Redis HWM (`parse_hwm:{channel_id}`)
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

## üêõ –ü–†–û–ë–õ–ï–ú–ê, –ö–û–¢–û–†–ê–Ø –ë–´–õ–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
return max(base, now - timedelta(minutes=self.config.incremental_minutes))
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `last_parsed_at` = 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- `since_date` = max(10 –º–∏–Ω –Ω–∞–∑–∞–¥, now - 5 –º–∏–Ω) = now - 5 –º–∏–Ω—É—Ç
- **–ü–†–û–ü–£–°–ö**: —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É 10 –∏ 5 –º–∏–Ω—É—Ç–∞–º–∏ –Ω–∞–∑–∞–¥ –Ω–µ –ø–∞—Ä—Å—è—Ç—Å—è!

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
return base  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–Ω–æ last_parsed_at
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `since_date` = `last_parsed_at` (—Ç–æ—á–Ω–æ)
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É `last_parsed_at` –∏ `now` –±—É–¥—É—Ç –ø–∞—Ä—Å–∏—Ç—å—Å—è

## üìç –ì–î–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø last_parsed_at

1. **parse_all_channels_task.py** (`_decide_mode`)
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (historical/incremental)

2. **channel_parser.py** (`_get_since_date`)
   - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `since_date` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

3. **channel_parser.py** (`_update_last_parsed_at`)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

4. **channel_parser.py** (cooldown skip)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫

5. **Redis HWM** (`parse_hwm:{channel_id}`)
   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `last_parsed_at`
   - –£–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## ‚úÖ –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

- ‚úÖ –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- ‚úÖ `since_date` = `last_parsed_at` –≤ incremental —Ä–µ–∂–∏–º–µ
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –∫–∞–Ω–∞–ª–∞–º–∏ —Å `last_parsed_at` > 1 —á–∞—Å–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–Ω–∞–ª—ã —Å NULL `last_parsed_at` (–¥–æ–ª–∂–Ω—ã –ø–∞—Ä—Å–∏—Ç—å—Å—è –≤ historical —Ä–µ–∂–∏–º–µ)

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–º–µ–Ω—å—à–µ–Ω–∏–µ `PARSER_INCREMENTAL_MINUTES` –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `PARSER_LPA_MAX_AGE_HOURS` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã –ø–æ—Å—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª–∞—Ö

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
