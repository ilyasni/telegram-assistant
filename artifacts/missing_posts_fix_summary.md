# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–æ—Å—Ç–æ–≤

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. ‚úÖ Overlap –¥–ª—è since_date (-5 –º–∏–Ω—É—Ç)
**–§–∞–π–ª**: `telethon-ingest/services/channel_parser.py`

- –î–æ–±–∞–≤–ª–µ–Ω overlap –≤ 5 –º–∏–Ω—É—Ç –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ `since_date`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∏ –∏–∑-–∑–∞ race conditions –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
- Context7 ID: `incremental-overlap-001`

### 2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MAX(posted_at) –∏–∑ –ë–î
**–§–∞–π–ª**: `telethon-ingest/services/channel_parser.py`

- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_get_last_post_date()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç MAX(posted_at) –Ω–∞–¥ `last_parsed_at` –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –±–∞–∑–æ–≤–æ–π –¥–∞—Ç—ã
- Context7 ID: `incremental-since-date-fix-002`

### 3. ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤
**–§–∞–π–ª**: `telethon-ingest/tasks/parse_all_channels_task.py`

- `posts_missing_duration_seconds` - Gauge –º–µ—Ç—Ä–∏–∫–∞ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É last_parsed_at –∏ MAX(posted_at)
- `posts_backfill_triggered_total` - Counter –º–µ—Ç—Ä–∏–∫–∞ –∑–∞–ø—É—Å–∫–æ–≤ backfill –æ–ø–µ—Ä–∞—Ü–∏–π

### 4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
**–§–∞–π–ª**: `telethon-ingest/services/channel_parser.py`

- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_monitor_missing_posts()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤ > 1 —á–∞—Å–∞
- Context7 ID: `monitoring-missing-posts-001`

### 5. ‚úÖ Backfill –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤
**–§–∞–π–ª**: `telethon-ingest/tasks/parse_all_channels_task.py`

- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_check_and_trigger_backfill()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ scheduler
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∏ –∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥
- Context7 ID: `backfill-missing-posts-001`

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ since_date**:
   - –ü–æ–ª—É—á–∞–µ–º MAX(posted_at) –∏–∑ –ë–î (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞)
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å last_parsed_at –∏ –≤—ã–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É
   - –í—ã—á–∏—Ç–∞–µ–º 5 –º–∏–Ω—É—Ç overlap –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤

2. **–ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞**:
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º last_parsed_at —Å MAX(posted_at)
   - –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É `posts_missing_duration_seconds`
   - –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–Ω–∏—Ü–µ > 1 —á–∞—Å–∞

3. **–í scheduler**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∏
   - –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–ø—É—Å–∫–∞ > 1 —á–∞—Å–∞ - –ø–ª–∞–Ω–∏—Ä—É–µ–º backfill
   - –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É `posts_backfill_triggered_total`

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### `posts_missing_duration_seconds`
- –¢–∏–ø: Gauge
- Labels: `channel_id`
- –û–ø–∏—Å–∞–Ω–∏–µ: –†–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –º–µ–∂–¥—É last_parsed_at –∏ MAX(posted_at)
- –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:
  - –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –ø–∞—Ä—Å–∏–Ω–≥ –≤–ø–µ—Ä–µ–¥–∏ –ø–æ—Å—Ç–æ–≤ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
  - –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –µ—Å—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã (–ø—Ä–æ–±–ª–µ–º–∞)

### `posts_backfill_triggered_total`
- –¢–∏–ø: Counter
- Labels: `channel_id`, `reason`
- –û–ø–∏—Å–∞–Ω–∏–µ: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ backfill –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–Ω–∞—á–µ–Ω–∏—è reason:
  - `missing_posts_gap`: –ø—Ä–æ–ø—É—Å–∫ –º–µ–∂–¥—É last_parsed_at –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø–æ—Å—Ç–æ–º

## –ê–ª–µ—Ä—Ç—ã

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∞–ª–µ—Ä—Ç—ã –≤ Prometheus:

```promql
# –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã > 1 —á–∞—Å–∞
posts_missing_duration_seconds < -3600

# –ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—É—Å–∫–∞ backfill
rate(posts_backfill_triggered_total[5m]) > 0
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ overlap –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ "Calculated since_date with overlap"
   docker compose logs telethon-ingest | grep "overlap"
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
   ```bash
   curl http://localhost:9090/metrics | grep posts_missing
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–ø—É—Å–∫–æ–≤:
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ "Potential missing posts detected"
   docker compose logs telethon-ingest | grep "missing posts"
   ```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
2. üîÑ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å telethon-ingest
3. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus/Grafana
4. üìù –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ Alertmanager –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

