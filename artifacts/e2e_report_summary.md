# Отчёт E2E проверки пайплайна

**Дата проверки**: 2025-10-29 00:18:52  
**Режим**: e2e (полная проверка с SLO порогами)  
**Статус**: ❌ 2 проверки провалены из 4

---

## Результаты проверок

### ✅ Успешные проверки

1. **parsing.posts_last24h** ✅
   - Постов за 24 часа: **101** (порог: ≥1)
   - Всего постов в БД: 233
   - Новейший пост: 2025-10-28T19:51:28+00:00

2. **qdrant.telegram_posts.payload_coverage** ✅
   - Payload coverage: **100%** (порог: ≥90%)
   - Всего векторов: 113
   - Размерность: 2560 (⚠️ не соответствует EMBEDDING_DIM=384 из env.example)

### ❌ Проваленные проверки

1. **streams.stream:posts:indexed.groups** ❌
   - **Проблема**: Нет consumer groups для `stream:posts:indexed`
   - **Статистика потока**:
     - Длина потока: 211 событий
     - Groups: 0
   - **Причина**: Индексация происходит, но consumer groups не созданы или не активны
   - **Влияние**: Не отслеживаются лаги и pending сообщения для индексации

2. **pipeline.flow_complete** ❌
   - **Проблема**: Тестовый пост не прошёл полный цикл пайплайна
   - **Детали тестового поста** (`dc4fa139-3389-4c24-9ecf-d1cc2a7dbed2`):
     - ❌ Теги отсутствуют (has_tags: false)
     - ❌ Обогащение отсутствует (has_crawl: false)
     - ❌ Не найден в Qdrant
     - ❌ Не найден в Neo4j
   - **Причина**: Пост не обработан через полный пайплайн (is_processed: false)

---

## Статистика компонентов

### Scheduler
- **Статус**: idle (lock не найден)
- **HWM count**: 0 (нет активных high water marks)
- **Последняя активность**: нет данных

### Redis Streams

| Stream | Длина | Groups | Pending |
|--------|-------|--------|---------|
| `stream:posts:parsed` | 1979 | 1 | 0 |
| `stream:posts:tagged` | 1055 | 3 | 0 |
| `stream:posts:enriched` | 2110 | 1 | 0 |
| `stream:posts:indexed` | 211 | 0 | ❌ |

**Наблюдения**:
- Потоки содержат данные, но нет активных consumer groups
- Pending = 0 для всех потоков (сообщения обрабатываются или уже обработаны)

### База данных (PostgreSQL)

- **Всего постов**: 233
- **Обработанных** (is_processed=true): **0** ⚠️
- **Постов за 24ч**: 101
- **Старейший пост**: 2025-10-26T12:23:14+00:00
- **Новейший пост**: 2025-10-28T19:51:28+00:00

### Тегирование

- **Постов с тегами**: 233
- **Всего теговых записей**: 233
- **Последние теги**: пустые массивы `[]` ⚠️
  - Теги сохраняются, но содержат пустые массивы

### Обогащение (Crawl4AI)

- **Обогащённых постов**: **0** ⚠️
- **Всего записей обогащения**: 0
- **Причина**: Либо обогащение не запущено, либо нет данных для обогащения

### Qdrant

- **Коллекции**: 1 (`telegram_posts`)
- **Всего векторов**: 113
- **Payload coverage**: 100% ✅
- **Размерность**: 2560 (⚠️ не соответствует ожидаемой 384)
- **Distance**: Cosine

**Предупреждение**: Фактическая размерность (2560) не соответствует `EMBEDDING_DIM=384` из `env.example`. Возможно, используется другая модель эмбеддингов (GigaChat EmbeddingsGigaR).

### Neo4j

- **Всего узлов Post**: 102
- **Связи**: 
  - `OWNS`: 126
  - `HAS_POST`: 102
- **Индекс `:Post(id)`**: ❌ не найден

**Критические проблемы**:
- ⚠️ Узлы Post **не имеют свойств** `id` и `posted_at`
- Скрипт E2E ожидает `p.id` и `p.posted_at`, но в схеме Neo4j используются:
  - `post_id` (вместо `id`)
  - только `expires_at` (нет `posted_at`)

**Источник проблемы**: Несоответствие схемы между:
- `worker/integrations/neo4j_client.py` (использует `post_id`)
- `worker/redis_consumer.py` (использует `id`)
- E2E скриптом (ожидает `id` и `posted_at`)

---

## Контекст7 & Supabase Best Practices

### ✅ Что работает правильно

1. **asyncpg pool**: Используется правильный формат подключения через `asyncpg.create_pool`
2. **SCAN вместо KEYS**: Redis операции используют безопасный `SCAN` для итерации
3. **Structured logging**: Используется `structlog` для логирования
4. **SLO пороги**: Реализована система приоритетов (ENV → CLI → JSON)
5. **Артефакты**: Результаты сохраняются в JSON и JUnit XML

### ⚠️ Проблемы архитектуры

1. **Neo4j схема несогласованна**:
   - Разные части кода используют разные имена свойств (`id` vs `post_id`)
   - Отсутствует `posted_at` в узлах Post

2. **Consumer groups не настроены**:
   - Потоки создаются, но consumer groups отсутствуют
   - Невозможно отследить лаги и pending сообщения

3. **Размерность эмбеддингов**:
   - Фактическая размерность (2560) не документирована
   - `env.example` содержит устаревшее значение (384)

---

## Рекомендации

### Критические (требуют немедленного исправления)

1. **Исправить схему Neo4j**:
   ```cypher
   // Вариант 1: Добавить свойство id (алиас для post_id)
   MATCH (p:Post)
   SET p.id = p.post_id
   
   // Вариант 2: Обновить скрипт E2E для использования post_id
   ```

2. **Добавить posted_at в узлы Post**:
   - Обновить `worker/integrations/neo4j_client.py` для передачи `posted_at`
   - Обновить `worker/tasks/indexing_task.py` для передачи `posted_at` из post_data

3. **Создать consumer groups для indexed stream**:
   ```python
   # В worker/tasks/indexing_task.py
   await redis.xgroup_create(
       "stream:posts:indexed",
       "indexing_workers",
       id="0",
       mkstream=True
   )
   ```

### Важные (требуют внимания)

4. **Обновить документацию по размерности эмбеддингов**:
   - Исправить `env.example`: `EMBEDDING_DIM=2560`
   - Документировать модель: GigaChat EmbeddingsGigaR

5. **Исследовать пустые теги**:
   - Посты имеют записи в `post_enrichment`, но теги пустые
   - Проверить процесс тегирования

6. **Исследовать отсутствие обогащения**:
   - 0 постов обогащено через crawl4ai
   - Проверить работу crawl4ai сервиса и политику обогащения

---

## Следующие шаги

1. ✅ Запуск E2E проверки завершён
2. ⏳ Анализ результатов выполнен
3. ⏳ Рекомендации подготовлены
4. ⏳ Требуется исправление критических проблем

---

## Метрики для мониторинга

- `e2e_watermark_age_seconds`: нет данных (scheduler idle)
- `e2e_stream_pending_total`: 0 (все потоки обработаны)
- `e2e_posts_last24h_total`: 101 ✅
- `e2e_qdrant_vectors_total`: 113
- `e2e_qdrant_payload_coverage_ratio`: 1.0 ✅
- `e2e_neo4j_skew_vs_pg_minutes`: нет данных (нет posted_at в Neo4j)

---

**Файлы результатов**:
- JSON: `artifacts/e2e_result_20251029_001852.json`
- JUnit XML: `artifacts/e2e_result_20251029_001852.xml`
- Лог: `artifacts/e2e_check.log`

